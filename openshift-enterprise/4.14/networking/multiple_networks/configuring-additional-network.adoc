:_mod-docs-content-type: ASSEMBLY
[id="configuring-additional-network"]
= Configuring an additional network
// The {product-title} attribute provides the context-sensitive name of the relevant OpenShift distribution, for example, "OpenShift Container Platform" or "OKD". The {product-version} attribute provides the product version relative to the distribution, for example "4.9".
// {product-title} and {product-version} are parsed when AsciiBinder queries the _distro_map.yml file in relation to the base branch of a pull request.
// See https://github.com/openshift/openshift-docs/blob/main/contributing_to_docs/doc_guidelines.adoc#product-name-and-version for more information on this topic.
// Other common attributes are defined in the following lines:
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:imagesdir: images
:prewrap!:
:op-system-first: Red Hat Enterprise Linux CoreOS (RHCOS)
:op-system: RHCOS
:op-system-lowercase: rhcos
:op-system-base: RHEL
:op-system-base-full: Red Hat Enterprise Linux (RHEL)
:op-system-version: 8.x
:tsb-name: Template Service Broker
:kebab: image:kebab.png[title="Options menu"]
:rh-openstack-first: Red Hat OpenStack Platform (RHOSP)
:rh-openstack: RHOSP
:ai-full: Assisted Installer
:ai-version: 2.3
:cluster-manager-first: Red Hat OpenShift Cluster Manager
:cluster-manager: OpenShift Cluster Manager
:cluster-manager-url: link:https://console.redhat.com/openshift[OpenShift Cluster Manager Hybrid Cloud Console]
:cluster-manager-url-pull: link:https://console.redhat.com/openshift/install/pull-secret[pull secret from the Red Hat OpenShift Cluster Manager]
:insights-advisor-url: link:https://console.redhat.com/openshift/insights/advisor/[Insights Advisor]
:hybrid-console: Red Hat Hybrid Cloud Console
:hybrid-console-second: Hybrid Cloud Console
:oadp-first: OpenShift API for Data Protection (OADP)
:oadp-full: OpenShift API for Data Protection
:oc-first: pass:quotes[OpenShift CLI (`oc`)]
:product-registry: OpenShift image registry
:rh-storage-first: Red Hat OpenShift Data Foundation
:rh-storage: OpenShift Data Foundation
:rh-rhacm-first: Red Hat Advanced Cluster Management (RHACM)
:rh-rhacm: RHACM
:rh-rhacm-version: 2.8
:sandboxed-containers-first: OpenShift sandboxed containers
:sandboxed-containers-operator: OpenShift sandboxed containers Operator
:sandboxed-containers-version: 1.3
:sandboxed-containers-version-z: 1.3.3
:sandboxed-containers-legacy-version: 1.3.2
:cert-manager-operator: cert-manager Operator for Red Hat OpenShift
:secondary-scheduler-operator-full: Secondary Scheduler Operator for Red Hat OpenShift
:secondary-scheduler-operator: Secondary Scheduler Operator
// Backup and restore
:velero-domain: velero.io
:velero-version: 1.11
:launch: image:app-launcher.png[title="Application Launcher"]
:mtc-short: MTC
:mtc-full: Migration Toolkit for Containers
:mtc-version: 1.8
:mtc-version-z: 1.8.0
// builds (Valid only in 4.11 and later)
:builds-v2title: Builds for Red Hat OpenShift
:builds-v2shortname: OpenShift Builds v2
:builds-v1shortname: OpenShift Builds v1
//gitops
:gitops-title: Red Hat OpenShift GitOps
:gitops-shortname: GitOps
:gitops-ver: 1.1
:rh-app-icon: image:red-hat-applications-menu-icon.jpg[title="Red Hat applications"]
//pipelines
:pipelines-title: Red Hat OpenShift Pipelines
:pipelines-shortname: OpenShift Pipelines
:pipelines-ver: pipelines-1.12
:pipelines-version-number: 1.12
:tekton-chains: Tekton Chains
:tekton-hub: Tekton Hub
:artifact-hub: Artifact Hub
:pac: Pipelines as Code
//odo
:odo-title: odo
//OpenShift Kubernetes Engine
:oke: OpenShift Kubernetes Engine
//OpenShift Platform Plus
:opp: OpenShift Platform Plus
//openshift virtualization (cnv)
:VirtProductName: OpenShift Virtualization
:VirtVersion: 4.14
:KubeVirtVersion: v0.59.0
:HCOVersion: 4.14.0
:CNVNamespace: openshift-cnv
:CNVOperatorDisplayName: OpenShift Virtualization Operator
:CNVSubscriptionSpecSource: redhat-operators
:CNVSubscriptionSpecName: kubevirt-hyperconverged
:delete: image:delete.png[title="Delete"]
//distributed tracing
:DTProductName: Red Hat OpenShift distributed tracing platform
:DTShortName: distributed tracing platform
:DTProductVersion: 2.9
:JaegerName: Red Hat OpenShift distributed tracing platform (Jaeger)
:JaegerShortName: distributed tracing platform (Jaeger)
:JaegerVersion: 1.47.0
:OTELName: Red Hat OpenShift distributed tracing data collection
:OTELShortName: distributed tracing data collection
:OTELOperator: Red Hat OpenShift distributed tracing data collection Operator
:OTELVersion: 0.81.0
:TempoName: Red Hat OpenShift distributed tracing platform (Tempo)
:TempoShortName: distributed tracing platform (Tempo)
:TempoOperator: Tempo Operator
:TempoVersion: 2.1.1
//logging
:logging-title: logging subsystem for Red Hat OpenShift
:logging-title-uc: Logging subsystem for Red Hat OpenShift
:logging: logging subsystem
:logging-uc: Logging subsystem
//serverless
:ServerlessProductName: OpenShift Serverless
:ServerlessProductShortName: Serverless
:ServerlessOperatorName: OpenShift Serverless Operator
:FunctionsProductName: OpenShift Serverless Functions
//service mesh v2
:product-dedicated: Red Hat OpenShift Dedicated
:product-rosa: Red Hat OpenShift Service on AWS
:SMProductName: Red Hat OpenShift Service Mesh
:SMProductShortName: Service Mesh
:SMProductVersion: 2.4.4
:MaistraVersion: 2.4
//Service Mesh v1
:SMProductVersion1x: 1.1.18.2
//Windows containers
:productwinc: Red Hat OpenShift support for Windows Containers
// Red Hat Quay Container Security Operator
:rhq-cso: Red Hat Quay Container Security Operator
// Red Hat Quay
:quay: Red Hat Quay
:sno: single-node OpenShift
:sno-caps: Single-node OpenShift
//TALO and Redfish events Operators
:cgu-operator-first: Topology Aware Lifecycle Manager (TALM)
:cgu-operator-full: Topology Aware Lifecycle Manager
:cgu-operator: TALM
:redfish-operator: Bare Metal Event Relay
//Formerly known as CodeReady Containers and CodeReady Workspaces
:openshift-local-productname: Red Hat OpenShift Local
:openshift-dev-spaces-productname: Red Hat OpenShift Dev Spaces
// Factory-precaching-cli tool
:factory-prestaging-tool: factory-precaching-cli tool
:factory-prestaging-tool-caps: Factory-precaching-cli tool
:openshift-networking: Red Hat OpenShift Networking
// TODO - this probably needs to be different for OKD
//ifdef::openshift-origin[]
//:openshift-networking: OKD Networking
//endif::[]
// logical volume manager storage
:lvms-first: Logical volume manager storage (LVM Storage)
:lvms: LVM Storage
//Operator SDK version
:osdk_ver: 1.31.0
//Operator SDK version that shipped with the previous OCP 4.x release
:osdk_ver_n1: 1.28.0
//Next-gen (OCP 4.14+) Operator Lifecycle Manager, aka "v1"
:olmv1: OLM 1.0
:olmv1-first: Operator Lifecycle Manager (OLM) 1.0
:ztp-first: GitOps Zero Touch Provisioning (ZTP)
:ztp: GitOps ZTP
:3no: three-node OpenShift
:3no-caps: Three-node OpenShift
:run-once-operator: Run Once Duration Override Operator
// Web terminal
:web-terminal-op: Web Terminal Operator
:devworkspace-op: DevWorkspace Operator
:secrets-store-driver: Secrets Store CSI driver
:secrets-store-operator: Secrets Store CSI Driver Operator
//AWS STS
:sts-first: Security Token Service (STS)
:sts-full: Security Token Service
:sts-short: STS
//Cloud provider names
//AWS
:aws-first: Amazon Web Services (AWS)
:aws-full: Amazon Web Services
:aws-short: AWS
//GCP
:gcp-first: Google Cloud Platform (GCP)
:gcp-full: Google Cloud Platform
:gcp-short: GCP
//alibaba cloud
:alibaba: Alibaba Cloud
// IBM Cloud VPC
:ibmcloudVPCProductName: IBM Cloud VPC
:ibmcloudVPCRegProductName: IBM(R) Cloud VPC
// IBM Cloud
:ibm-cloud-bm: IBM Cloud Bare Metal (Classic)
:ibm-cloud-bm-reg: IBM Cloud(R) Bare Metal (Classic)
// IBM Power
:ibmpowerProductName: IBM Power
:ibmpowerRegProductName: IBM(R) Power
// IBM zSystems
:ibmzProductName: IBM Z
:ibmzRegProductName: IBM(R) Z
:linuxoneProductName: IBM(R) LinuxONE
//Azure
:azure-full: Microsoft Azure
:azure-short: Azure
//vSphere
:vmw-full: VMware vSphere
:vmw-short: vSphere
//Oracle
:oci-first: Oracle(R) Cloud Infrastructure
:oci: OCI
:ocvs-first: Oracle(R) Cloud VMware Solution (OCVS)
:ocvs: OCVS
:context: configuring-additional-network

toc::[]

As a cluster administrator, you can configure an additional network for your cluster. The following network types are supported:

* xref:../../networking/multiple_networks/configuring-additional-network.adoc#nw-multus-bridge-object_configuring-additional-network[Bridge]
* xref:../../networking/multiple_networks/configuring-additional-network.adoc#nw-multus-host-device-object_configuring-additional-network[Host device]
* xref:../../networking/multiple_networks/configuring-additional-network.adoc#nw-multus-vlan-object_configuring-additional-network[VLAN]
* xref:../../networking/multiple_networks/configuring-additional-network.adoc#nw-multus-ipvlan-object_configuring-additional-network[IPVLAN]
* xref:../../networking/multiple_networks/configuring-additional-network.adoc#nw-multus-macvlan-object_configuring-additional-network[MACVLAN]
* xref:../../networking/multiple_networks/configuring-additional-network.adoc#nw-multus-tap-object_configuring-additional-network[TAP]
* xref:../../networking/multiple_networks/configuring-additional-network.adoc#configuration-ovnk-additional-networks_configuring-additional-network[OVN-Kubernetes]

[id="{context}_approaches-managing-additional-network"]
== Approaches to managing an additional network

You can manage the life cycle of an additional network by two approaches. Each approach is mutually exclusive and you can only use one approach for managing an additional network at a time. For either approach, the additional network is managed by a Container Network Interface (CNI) plugin that you configure.

For an additional network, IP addresses are provisioned through an IP Address Management (IPAM) CNI plugin that you configure as part of the additional network. The IPAM plugin supports a variety of IP address assignment approaches including DHCP and static assignment.

* Modify the Cluster Network Operator (CNO) configuration: The CNO automatically creates and manages the `NetworkAttachmentDefinition` object. In addition to managing the object lifecycle the CNO ensures a DHCP is available for an additional network that uses a DHCP assigned IP address.

* Applying a YAML manifest: You can manage the additional network directly by creating an `NetworkAttachmentDefinition` object. This approach allows for the chaining of CNI plugins.

[NOTE]
====
When deploying {product-title} nodes with multiple network interfaces on {rh-openstack-first} with OVN SDN, DNS configuration of the secondary interface might take precedence over the DNS configuration of the primary interface. In this case, remove the DNS nameservers for the subnet id that is attached to the secondary interface:
[source,terminal]
----
$ openstack subnet set --dns-nameserver 0.0.0.0 <subnet_id>
----
====

[id="{context}_configuration-additional-network-attachment"]
== Configuration for an additional network attachment

An additional network is configured by using the `NetworkAttachmentDefinition` API in the `k8s.cni.cncf.io` API group.
[IMPORTANT]
====
Do not store any sensitive information or a secret in the `NetworkAttachmentDefinition` object because this information is accessible by the project administration user.
====

The configuration for the API is described in the following table:

.`NetworkAttachmentDefinition` API fields
[cols=".^3,.^2,.^5",options="header"]
|====
|Field|Type|Description

|`metadata.name`
|`string`
|The name for the additional network.

|`metadata.namespace`
|`string`
|The namespace that the object is associated with.

|`spec.config`
|`string`
|The CNI plugin configuration in JSON format.

|====

[id="{context}_configuration-additional-network-cno"]
=== Configuration of an additional network through the Cluster Network Operator

The configuration for an additional network attachment is specified as part of the Cluster Network Operator (CNO) configuration.

The following YAML describes the configuration parameters for managing an additional network with the CNO:

.Cluster Network Operator configuration
[source,yaml]
----
apiVersion: operator.openshift.io/v1
kind: Network
metadata:
  name: cluster
spec:
  # ...
  additionalNetworks: <1>
  - name: <name> <2>
    namespace: <namespace> <3>
    rawCNIConfig: |- <4>
      {
        ...
      }
    type: Raw
----
<1> An array of one or more additional network configurations.

<2> The name for the additional network attachment that you are
creating. The name must be unique within the specified `namespace`.

<3> The namespace to create the network attachment in. If
you do not specify a value, then the `default` namespace is used.

<4> A CNI plugin configuration in JSON format.

[id="{context}_configuration-additional-network-yaml"]
=== Configuration of an additional network from a YAML manifest

The configuration for an additional network is specified from a YAML configuration file, such as in the following example:

[source,yaml]
----
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: <name> <1>
spec:
  config: |- <2>
    {
      ...
    }
----
<1> The name for the additional network attachment that you are
creating.
<2> A CNI plugin configuration in JSON format.

[id="{context}_configuration-additional-network-types"]
== Configurations for additional network types

The specific configuration fields for additional networks is described in the following sections.

:leveloffset: +2

// Module included in the following assemblies:
//
// * networking/multiple_networks/configuring-additional-network.adoc
:_mod-docs-content-type: REFERENCE
[id="nw-multus-bridge-object_{context}"]
= Configuration for a bridge additional network

The following object describes the configuration parameters for the bridge CNI
plugin:

.Bridge CNI plugin JSON configuration object
[cols=".^2,.^2,.^6",options="header"]
|====
|Field|Type|Description

|`cniVersion`
|`string`
|The CNI specification version. The `0.3.1` value is required.

|`name`
|`string`
|The value for the `name` parameter you provided previously for the CNO configuration.

|`type`
|`string`
|The name of the CNI plugin to configure: `bridge`.

|`ipam`
|`object`
|The configuration object for the IPAM CNI plugin. The plugin manages IP address assignment for the attachment definition.

|`bridge`
|`string`
|Optional: Specify the name of the virtual bridge to use. If the bridge interface does not exist on the host, it is created. The default value is `cni0`.

|`ipMasq`
|`boolean`
|Optional: Set to `true` to enable IP masquerading for traffic that leaves the virtual network. The source IP address for all traffic is rewritten to the bridge's IP address. If the bridge does not have an IP address, this setting has no effect. The default value is `false`.

|`isGateway`
|`boolean`
|Optional: Set to `true` to assign an IP address to the bridge. The default value is `false`.

|`isDefaultGateway`
|`boolean`
|Optional: Set to `true` to configure the bridge as the default gateway for the virtual network. The default value is `false`. If `isDefaultGateway` is set to `true`, then `isGateway` is also set to `true` automatically.

|`forceAddress`
|`boolean`
|Optional: Set to `true` to allow assignment of a previously assigned IP address to the virtual bridge. When set to `false`, if an IPv4 address or an IPv6 address from overlapping subsets is assigned to the virtual bridge, an error occurs. The default value is `false`.

|`hairpinMode`
|`boolean`
|Optional: Set to `true` to allow the virtual bridge to send an Ethernet frame back through the virtual port it was received on. This mode is also known as _reflective relay_. The default value is `false`.

|`promiscMode`
|`boolean`
|Optional: Set to `true` to enable promiscuous mode on the bridge. The default value is `false`.

|`vlan`
|`string`
|Optional: Specify a virtual LAN (VLAN) tag as an integer value. By default, no VLAN tag is assigned.

|`preserveDefaultVlan`
|`string`
|Optional: Indicates whether the default vlan must be preserved on the `veth` end connected to the bridge. Defaults to true.

|`vlanTrunk`
|`list`
|Optional: Assign a VLAN trunk tag. The default value is `none`.

|`mtu`
|`string`
|Optional: Set the maximum transmission unit (MTU) to the specified value. The default value is automatically set by the kernel.

|`enabledad`
|`boolean`
|Optional: Enables duplicate address detection for the container side `veth`. The default value is `false`.

|`macspoofchk`
|`boolean`
|Optional: Enables mac spoof check, limiting the traffic originating from the container to the mac address of the interface. The default value is `false`.
|====

[NOTE]
====
The VLAN parameter configures the VLAN tag on the host end of the `veth` and also enables the `vlan_filtering` feature on the bridge interface.
====

[NOTE]
====
To configure uplink for a L2 network you need to allow the vlan on the uplink interface by using the following command:

[source,terminal]
----
$  bridge vlan add vid VLAN_ID dev DEV
----

====


[id="nw-multus-bridge-config-example_{context}"]
== bridge configuration example

The following example configures an additional network named `bridge-net`:

[source,json]
----
{
  "cniVersion": "0.3.1",
  "name": "bridge-net",
  "type": "bridge",
  "isGateway": true,
  "vlan": 2,
  "ipam": {
    "type": "dhcp"
    }
}
----

:leveloffset!:
:leveloffset: +2

// Module included in the following assemblies:
//
// * networking/multiple_networks/configuring-additional-network.adoc
:_mod-docs-content-type: REFERENCE
[id="nw-multus-host-device-object_{context}"]
= Configuration for a host device additional network

[NOTE]
====
Specify your network device by setting only one of the following parameters: `device`,`hwaddr`, `kernelpath`, or `pciBusID`.
====

The following object describes the configuration parameters for the host-device CNI plugin:

// containernetworking/plugins/.../host-device.go#L50
.Host device CNI plugin JSON configuration object
[cols=".^2,.^2,.^6",options="header"]
|====
|Field|Type|Description

|`cniVersion`
|`string`
|The CNI specification version. The `0.3.1` value is required.

|`name`
|`string`
|The value for the `name` parameter you provided previously for the CNO configuration.

|`type`
|`string`
|The name of the CNI plugin to configure: `host-device`.

|`device`
|`string`
|Optional: The name of the device, such as `eth0`.

|`hwaddr`
|`string`
|Optional: The device hardware MAC address.

|`kernelpath`
|`string`
|Optional: The Linux kernel device path, such as `/sys/devices/pci0000:00/0000:00:1f.6`.

|`pciBusID`
|`string`
|Optional: The PCI address of the network device, such as `0000:00:1f.6`.
|====

[id="nw-multus-hostdev-config-example_{context}"]
== host-device configuration example

The following example configures an additional network named `hostdev-net`:

[source,json]
----
{
  "cniVersion": "0.3.1",
  "name": "hostdev-net",
  "type": "host-device",
  "device": "eth1"
}
----

:leveloffset!:
:leveloffset: +2

// Module included in the following assemblies:
//
// * networking/multiple_networks/configuring-additional-network.adoc

//37.1. VLAN overview
//
:_mod-docs-content-type: REFERENCE
[id="nw-multus-vlan-object_{context}"]
= Configuration for an VLAN additional network

The following object describes the configuration parameters for the VLAN CNI plugin:

.VLAN CNI plugin JSON configuration object
[cols=".^2,.^2,.^6",options="header"]
|====
|Field|Type|Description

|`cniVersion`
|`string`
|The CNI specification version. The `0.3.1` value is required.

|`name`
|`string`
|The value for the `name` parameter you provided previously for the CNO configuration.

|`type`
|`string`
|The name of the CNI plugin to configure: `vlan`.

|`master`
|`string`
|The Ethernet interface to associate with the network attachment. If a `master` is not specified, the interface for the default network route is used.

|`vlanId`
|`integer`
|Set the id of the vlan.

|`ipam`
|`object`
|The configuration object for the IPAM CNI plugin. The plugin manages IP address assignment for the attachment definition.

|`mtu`
|`integer`
|Optional: Set the maximum transmission unit (MTU) to the specified value. The default value is automatically set by the kernel.

|`dns`
|`integer`
|Optional: DNS information to return, for example, a priority-ordered list of DNS nameservers.

|`linkInContainer`
|`boolean`
|Optional: Specifies whether the master interface is in the container network namespace or the main network namespace. Set the value to `true` to request the use of a container namespace master interface.

|====

[id="nw-multus-vlan-config-example_{context}"]
== vlan configuration example

The following example configures an additional network named `vlan-net`:

[source,json]
----
{
  "name": "vlan-net",
  "cniVersion": "0.3.1",
  "type": "vlan",
  "master": "eth0",
  "mtu": 1500,
  "vlanId": 5,
  "linkInContainer": false,
  "ipam": {
      "type": "host-local",
      "subnet": "10.1.1.0/24"
  },
  "dns": {
      "nameservers": [ "10.1.1.1", "8.8.8.8" ]
  }
}
----

:leveloffset!:
:leveloffset: +2

// Module included in the following assemblies:
//
// * networking/multiple_networks/configuring-additional-network.adoc

//37.1. IPVLAN overview
// https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/configuring_and_managing_networking/getting-started-with-ipvlan_configuring-and-managing-networking#ipvlan-overview_getting-started-with-ipvlan
:_mod-docs-content-type: REFERENCE

[id="nw-multus-ipvlan-object_{context}"]
= Configuration for an IPVLAN additional network

The following object describes the configuration parameters for the IPVLAN CNI plugin:

.IPVLAN CNI plugin JSON configuration object
[cols=".^2,.^2,.^6",options="header"]
|====
|Field|Type|Description

|`cniVersion`
|`string`
|The CNI specification version. The `0.3.1` value is required.

|`name`
|`string`
|The value for the `name` parameter you provided previously for the CNO configuration.

|`type`
|`string`
|The name of the CNI plugin to configure: `ipvlan`.

|`ipam`
|`object`
|The configuration object for the IPAM CNI plugin. The plugin manages IP address assignment for the attachment definition. This is required unless the plugin is chained.

|`mode`
|`string`
|Optional: The operating mode for the virtual network. The value must be `l2`, `l3`, or `l3s`. The default value is `l2`.

|`master`
|`string`
|Optional: The Ethernet interface to associate with the network attachment. If a `master` is not specified, the interface for the default network route is used.

|`mtu`
|`integer`
|Optional: Set the maximum transmission unit (MTU) to the specified value. The default value is automatically set by the kernel.

|`linkInContainer`
|`boolean`
|Optional: Specifies whether the master interface is in the container network namespace or the main network namespace. Set the value to `true` to request the use of a container namespace master interface.

|====

[NOTE]
====
* The `ipvlan` object does not allow virtual interfaces to communicate with the `master` interface. Therefore the container will not be able to reach the host by using the `ipvlan` interface. Be sure that the container joins a network that provides connectivity to the host, such as a network supporting the Precision Time Protocol (`PTP`).
* A single `master` interface cannot simultaneously be configured to use both `macvlan` and `ipvlan`.
* For IP allocation schemes that cannot be interface agnostic, the `ipvlan` plugin can be chained with an earlier plugin that handles this logic. If the `master` is omitted, then the previous result must contain a single interface name for the `ipvlan` plugin to enslave. If `ipam` is omitted, then the previous result is used to configure the `ipvlan` interface.
====

[id="nw-multus-ipvlan-config-example_{context}"]
== ipvlan configuration example

The following example configures an additional network named `ipvlan-net`:

[source,json]
----
{
  "cniVersion": "0.3.1",
  "name": "ipvlan-net",
  "type": "ipvlan",
  "master": "eth1",
  "linkInContainer": false,
  "mode": "l3",
  "ipam": {
    "type": "static",
    "addresses": [
       {
         "address": "192.168.10.10/24"
       }
    ]
  }
}
----

:leveloffset!:
:leveloffset: +2

// Module included in the following assemblies:
//
// * networking/multiple_networks/configuring-additional-network.adoc
:_mod-docs-content-type: REFERENCE
[id="nw-multus-macvlan-object_{context}"]
= Configuration for a MACVLAN additional network

The following object describes the configuration parameters for the macvlan CNI plugin:

.MACVLAN CNI plugin JSON configuration object
[cols=".^2,.^2,.^6",options="header"]
|====
|Field|Type|Description

|`cniVersion`
|`string`
|The CNI specification version. The `0.3.1` value is required.

|`name`
|`string`
|The value for the `name` parameter you provided previously for the CNO configuration.

|`type`
|`string`
|The name of the CNI plugin to configure: `macvlan`.

|`ipam`
|`object`
|The configuration object for the IPAM CNI plugin. The plugin manages IP address assignment for the attachment definition.

|`mode`
|`string`
|Optional: Configures traffic visibility on the virtual network. Must be either `bridge`, `passthru`, `private`, or `vepa`. If a value is not provided, the default value is `bridge`.

|`master`
|`string`
|Optional: The host network interface to associate with the newly created macvlan interface. If a value is not specified, then the default route interface is used.

|`mtu`
|`string`
|Optional: The maximum transmission unit (MTU) to the specified value. The default value is automatically set by the kernel.

|`linkInContainer`
|`boolean`
|Optional: Specifies whether the master interface is in the container network namespace or the main network namespace. Set the value to `true` to request the use of a container namespace master interface.

|====

[NOTE]
====
If you specify the `master` key for the plugin configuration, use a different physical network interface than the one that is associated with your primary network plugin to avoid possible conflicts.
====

[id="nw-multus-macvlan-config-example_{context}"]
== macvlan configuration example

The following example configures an additional network named `macvlan-net`:

[source,json]
----
{
  "cniVersion": "0.3.1",
  "name": "macvlan-net",
  "type": "macvlan",
  "master": "eth1",
  "linkInContainer": false,
  "mode": "bridge",
  "ipam": {
    "type": "dhcp"
    }
}
----

:leveloffset!:
:leveloffset: +2

// Module included in the following assemblies:
//
// * networking/multiple_networks/configuring-additional-network.adoc

:_mod-docs-content-type: REFERENCE
[id="nw-multus-tap-object_{context}"]
= Configuration for a TAP additional network

The following object describes the configuration parameters for the TAP CNI
plugin:

.TAP CNI plugin JSON configuration object
[cols=".^2,.^2,.^6",options="header"]
|====
|Field|Type|Description

|`cniVersion`
|`string`
|The CNI specification version. The `0.3.1` value is required.

|`name`
|`string`
|The value for the `name` parameter you provided previously for the CNO configuration.

|`type`
|`string`
|The name of the CNI plugin to configure: `tap`.

|`mac`
|`string`
|Optional: Request the specified MAC address for the interface.

|`mtu`
|`integer`
|Optional: Set the maximum transmission unit (MTU) to the specified value. The default value is automatically set by the kernel.

|`selinuxcontext`
|`string`
a|Optional: The SELinux context to associate with the tap device.

[NOTE]
====
The value `system_u:system_r:container_t:s0` is required for {product-title}.
====

|`multiQueue`
|`boolean`
|Optional: Set to `true` to enable multi-queue.

|`owner`
|`integer`
|Optional: The user owning the tap device.

|`group`
|`integer`
|Optional: The group owning the tap device.

|`bridge`
|`string`
|Optional: Set the tap device as a port of an already existing bridge.
|====

[id="nw-multus-tap-config-example_{context}"]
== Tap configuration example

The following example configures an additional network named `mynet`:

[source,json]
----
{
 "name": "mynet",
 "cniVersion": "0.3.1",
 "type": "tap",
 "mac": "00:11:22:33:44:55",
 "mtu": 1500,
 "selinuxcontext": "system_u:system_r:container_t:s0",
 "multiQueue": true,
 "owner": 0,
 "group": 0
 "bridge": "br1"
}
----

[id="nw-multus-enable-container_use_devices_{context}"]

== Setting SELinux boolean for the TAP CNI plugin

To create the tap device with the `container_t` SELinux context, enable the `container_use_devices` boolean on the host by using the Machine Config Operator (MCO).

.Prerequisites

* You have installed the OpenShift CLI (`oc`).

.Procedure

. Create a new YAML file named, such as `setsebool-container-use-devices.yaml`, with the following details:
+
[source, yaml]
----
apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: worker
  name: 99-worker-setsebool
spec:
  config:
    ignition:
      version: 3.2.0
    systemd:
      units:
      - enabled: true
        name: setsebool.service
        contents: |
          [Unit]
          Description=Set SELinux boolean for the TAP CNI plugin
          Before=kubelet.service

          [Service]
          Type=oneshot
          ExecStart=/usr/sbin/setsebool container_use_devices=on
          RemainAfterExit=true

          [Install]
          WantedBy=multi-user.target graphical.target
----
+

. Create the new `MachineConfig` object by running the following command:
+
[source,terminal]
----
$ oc apply -f setsebool-container-use-devices.yaml
----
+
[NOTE]
====
Applying any changes to the `MachineConfig` object causes all affected nodes to gracefully reboot after the change is applied. This update can take some time to be applied.
====
+
. Verify the change is applied by running the following command:
+
[source,terminal]
----
$ oc get machineconfigpools
----
+
.Expected output
+
[source,terminal,options="nowrap",role="white-space-pre"]
----
NAME        CONFIG                                                UPDATED   UPDATING   DEGRADED   MACHINECOUNT   READYMACHINECOUNT   UPDATEDMACHINECOUNT   DEGRADEDMACHINECOUNT   AGE
master      rendered-master-e5e0c8e8be9194e7c5a882e047379cfa      True      False      False      3              3                   3                     0                      7d2h
worker      rendered-worker-d6c9ca107fba6cd76cdcbfcedcafa0f2      True      False      False      3              3                   3                     0                      7d
----
+
[NOTE]
====
All nodes should be in the updated and ready state.
====

:leveloffset!:

[role="_additional-resources"]
.Additional resources

* For more information about enabling an SELinux boolean on a node, see xref:../../nodes/nodes/nodes-nodes-managing.adoc#nodes-nodes-working-setting-booleans_nodes-nodes-managing[Setting SELinux booleans]

// Set of includes pertains to OVN-Kubernetes additional network
:leveloffset: +2

// Module included in the following assemblies:
//
// * networking/multiple_networks/configuring-additional-network.adoc

:_mod-docs-content-type: CONCEPT
[id="configuration-ovnk-additional-networks_{context}"]
= Configuration for an OVN-Kubernetes additional network

The {openshift-networking} OVN-Kubernetes network plugin allows the configuration of secondary network interfaces for pods. To configure secondary network interfaces, you must define the configurations in the `NetworkAttachmentDefinition` custom resource (CR).

You can configure an OVN-Kubernetes additional network in either _layer 2_ or _localnet_ topologies.

- A layer 2 topology supports east-west cluster traffic, but does not allow access to the underlying physical network.
- A localnet topology allows connections to the physical network, but requires additional configuration of the underlying Open vSwitch (OVS) bridge on cluster nodes.

The following sections provide example configurations for each of the topologies that OVN-Kubernetes currently allows for secondary networks.

[NOTE]
====
Networks names must be unique. For example, creating multiple `NetworkAttachmentDefinition` CRs with different configurations that reference the same network is unsupported.
====

[id="configuration-additional-network-types-supported-platforms_{context}"]
== Supported platforms for OVN-Kubernetes additional network

You can use an OVN-Kubernetes additional network with the following supported platforms:

- Bare metal
- {ibmpowerProductName}
- {ibmzProductName}
- {linuxoneProductName}
- VMware vSphere
- {rh-openstack-first}

:leveloffset!:
:leveloffset: +3

:_mod-docs-content-type: REFERENCE
[id="configuration-ovnk-network-plugin-json-object_{context}"]
= OVN-Kubernetes network plugin JSON configuration table

The following table describes the configuration parameters for the OVN-Kubernetes CNI network plugin:

.OVN-Kubernetes network plugin JSON configuration table
[cols=".^2,.^2,.^6",options="header"]
|====
|Field|Type|Description

|`cniVersion`
|`string`
|
The CNI specification version. The required value is `0.3.1`.

|`name`
|`string`
|
The name of the network. These networks are not namespaced. For example, you can have a network named
`l2-network` referenced from two different `NetworkAttachmentDefinitions` that exist on two different
namespaces. This ensures that pods making use of the `NetworkAttachmentDefinition` on their own different
namespaces can communicate over the same secondary network. However, those two different `NetworkAttachmentDefinitions` must also share the same network specific parameters such as `topology`, `subnets`, `mtu`, and `excludeSubnets`.

|`type`
|`string`
|
The name of the CNI plugin to configure. This value must be set to `ovn-k8s-cni-overlay`.

|`topology`
|`string`
|
The topological configuration for the network. Must be one of `layer2` or `localnet`.

|`subnets`
|`string`
|
The subnet to use for the network across the cluster. When specifying `layer2` for the `topology`, only include the CIDR for the node. For example, `10.100.200.0/24`.

For `"topology":"layer2"` deployments, IPv6 (`2001:DBB::/64`) and dual-stack (`192.168.100.0/24,2001:DBB::/64`) subnets are supported.

When omitted, the logical switch implementing the network only provides layer 2 communication, and users must configure IP addresses for the pods. Port security only prevents MAC spoofing.

|`mtu`
|`string`
|
The maximum transmission unit (MTU). The default value, `1300`, is automatically set by the kernel.

|`netAttachDefName`
|`string`
|
The metadata `namespace` and `name` of the network attachment definition object where this
configuration is included. For example, if this configuration is defined in a `NetworkAttachmentDefinition` in namespace `ns1` named `l2-network`, this should be set to `ns1/l2-network`.

|`excludeSubnets`
|`string`
|
A comma-separated list of CIDRs and IP addresses. IP addresses are removed from the assignable IP address pool and are never passed to the pods.

|`vlanID`
|`integer`
|
If topology is set to `localnet`, the specified VLAN tag is assigned to traffic from this additional network. The default is to not assign a VLAN tag.

|====

:leveloffset!:
:leveloffset: +3

// Module included in the following assemblies:
//
// * networking/multiple_networks/configuring-additional-network.adoc

:_mod-docs-content-type: CONCEPT
[id="compatibility-with-multi-network-policy_{context}"]
= Compatibility with multi-network policy

The multi-network policy API, which is provided by the `MultiNetworkPolicy` custom resource definition (CRD) in the `k8s.cni.cncf.io` API group, is compatible with an OVN-Kubernetes secondary network. When defining a network policy, the network policy rules that can be used depend on whether the OVN-Kubernetes secondary network defines the `subnets` field. Refer to the following table for details:

.Supported multi-network policy selectors based on `subnets` CNI configuration
[cols=".^3,.^7",options="header"]
|====
a|`subnets` field specified|Allowed multi-network policy selectors

|
Yes
a|
* `podSelector` and `namespaceSelector`
* `ipBlock`

|
No
a|
* `ipBlock`

|====

For example, the following multi-network policy is valid only if the `subnets` field is defined in the additional network CNI configuration for the additional network named `blue2`:

.Example multi-network policy that uses a pod selector
[source,yaml]
----
apiVersion: k8s.cni.cncf.io/v1beta1
kind: MultiNetworkPolicy
metadata:
  name: allow-same-namespace
  annotations:
    k8s.v1.cni.cncf.io/policy-for: blue2
spec:
  podSelector:
  ingress:
  - from:
    - podSelector: {}
----

The following example uses the `ipBlock` network policy selector, which is always valid for an OVN-Kubernetes additional network:

.Example multi-network policy that uses an IP block selector
[source,yaml]
----
apiVersion: k8s.cni.cncf.io/v1beta1
kind: MultiNetworkPolicy
metadata:
  name:  ingress-ipblock
  annotations:
    k8s.v1.cni.cncf.io/policy-for: default/flatl2net
spec:
  podSelector:
    matchLabels:
      name: access-control
  policyTypes:
  - Ingress
  ingress:
  - from:
    - ipBlock:
        cidr: 10.200.0.0/30
----

:leveloffset!:

//include::modules/configuring-layer-three-routed-topology.adoc[leveloffset=+3]
:leveloffset: +3

// Module included in the following assemblies:
//
// * networking/multiple_networks/configuring-additional-network.adoc

:_mod-docs-content-type: CONCEPT
[id="configuration-layer-two-switched-topology_{context}"]
= Configuration for a layer 2 switched topology

The switched (layer 2) topology networks interconnect the workloads through a cluster-wide logical switch. This configuration can be used for IPv6 and dual-stack deployments.

[NOTE]
====
Layer 2 switched topology networks only allow for the transfer of data packets between pods within a cluster.
====

The following JSON example configures a switched secondary network:

[source,json]
----
{
  "cniVersion": "0.3.1",
  "name": "l2-network",
  "type": "ovn-k8s-cni-overlay",
  "topology":"layer2",
  "subnets": "10.100.200.0/24",
  "mtu": 1300,
  "netAttachDefName": "ns1/l2-network",
  "excludeSubnets": "10.100.200.0/29"
}
----

:leveloffset!:

[id="{context}_ovn-kubernetes-configuration-for-a-localnet-topology"]
==== Configuration for a localnet topology

The switched (localnet) topology interconnects the workloads through a cluster-wide logical switch to a physical network.

// Workaround lack of xref in modules
[id="{context}_configuration-additional-network-types-prerequisites"]
===== Prerequisites for configuring OVN-Kubernetes additional network

- The NMState Operator is installed. For more information, see xref:../../networking/k8s_nmstate/k8s-nmstate-about-the-k8s-nmstate-operator.adoc#k8s-nmstate-about-the-k8s-nmstate-operator[About the Kubernetes NMState Operator].

[id="{context}_configuration-additional-network-interface"]
===== Configuration for an OVN-Kubernetes additional network mapping

You must map an additional network to the OVN bridge to use it as an OVN-Kubernetes additional network. Bridge mappings allow network traffic to reach the physical network. A bridge mapping associates a physical network name, also known as an interface label, to a bridge created with Open vSwitch (OVS).

You can create an `NodeNetworkConfigurationPolicy` object, part of the `nmstate.io/v1` API group, to declaratively create the mapping. This API is provided by the NMState Operator. By using this API you can apply the bridge mapping to nodes that match your specified `nodeSelector` expression, such as `node-role.kubernetes.io/worker: ''`.

When attaching an additional network, you can either use the existing `br-ex` bridge or create a new bridge. Which approach to use depends on your specific network infrastructure.

- If your nodes include only a single network interface, you must use the existing bridge. This network interface is owned and managed by OVN-Kubernetes and you must not remove it from the `br-ex` bridge or alter the interface configuration. If you remove or alter the network interface, your cluster network will stop working correctly.
- If your nodes include several network interfaces, you can attach a different network interface to a new bridge, and use that for your additional network. This approach provides for traffic isolation from your primary cluster network.

The `localnet1` network is mapped to the `br-ex` bridge in the following example:

.Example mapping for sharing a bridge
[source,yaml]
----
apiVersion: nmstate.io/v1
kind: NodeNetworkConfigurationPolicy
metadata:
  name: mapping <1>
spec:
  nodeSelector:
    node-role.kubernetes.io/worker: '' <2>
  desiredState:
    ovn:
      bridge-mappings:
      - localnet: localnet1 <3>
        bridge: br-ex <4>
        state: present <5>
----
<1> The name for the configuration object.
<2> A node selector that specifies the nodes to apply the node network configuration policy to.
<3> The name for the additional network from which traffic is forwarded to the OVS bridge. This additional network must match the name of the `spec.config.name` field of the `NetworkAttachmentDefinition` object that defines the OVN-Kubernetes additional network.
<4> The name of the OVS bridge on the node. This value is required only if you specify `state: present`.
<5> The state for the mapping. Must be either `present` to add the bridge or `absent` to remove the bridge. The default value is `present`.

In the following example, the `localnet2` network interface is attached to the `ovs-br1` bridge. Through this attachment, the network interface is available to the OVN-Kubernetes network plugin as an additional network.

.Example mapping for nodes with multiple interfaces
[source,yaml]
----
apiVersion: nmstate.io/v1
kind: NodeNetworkConfigurationPolicy
metadata:
  name: ovs-br1-multiple-networks <1>
spec:
  nodeSelector:
    node-role.kubernetes.io/worker: '' <2>
  desiredState:
    interfaces:
    - name: ovs-br1 <3>
      description: |-
        A dedicated OVS bridge with eth1 as a port
        allowing all VLANs and untagged traffic
      type: ovs-bridge
      state: up
      bridge:
        options:
          stp: true
        port:
        - name: eth1 <4>
    ovn:
      bridge-mappings:
      - localnet: localnet2 <5>
        bridge: ovs-br1 <6>
        state: present <7>
----
<1> The name for the configuration object.
<2> A node selector that specifies the nodes to apply the node network configuration policy to.
<3> A new OVS bridge, separate from the default bridge used by OVN-Kubernetes for all cluster traffic.
<4> A network device on the host system to associate with this new OVS bridge.
<5> The name for the additional network from which traffic is forwarded to the OVS bridge. This additional network must match the name of the `spec.config.name` field of the `NetworkAttachmentDefinition` object that defines the OVN-Kubernetes additional network.
<6> The name of the OVS bridge on the node. This value is required only if you specify `state: present`.
<7> The state for the mapping. Must be either `present` to add the bridge or `absent` to remove the bridge. The default value is `present`.

This declarative approach is recommended because the NMState Operator applies additional network configuration to all nodes specified by the node selector automatically and transparently.

The following JSON example configures a localnet secondary network:

[source,json]
----
{
  "cniVersion": "0.3.1",
  "name": "ns1-localnet-network",
  "type": "ovn-k8s-cni-overlay",
  "topology":"localnet",
  "subnets": "202.10.130.112/28",
  "vlanID": 33,
  "mtu": 1500,
  "netAttachDefName": "ns1/localnet-network"
  "excludeSubnets": "10.100.200.0/29"
}
----
:leveloffset: +3

// Module included in the following assemblies:
//
// * networking/multiple_networks/configuring-additional-network.adoc

:_mod-docs-content-type: REFERENCE
[id="configuring-pods-secondary-network_{context}"]
= Configuring pods for additional networks

You must specify the secondary network attachments through the `k8s.v1.cni.cncf.io/networks` annotation.

The following example provisions a pod with two secondary attachments, one for each of the attachment configurations presented in this guide.

[source,yaml]
----
apiVersion: v1
kind: Pod
metadata:
  annotations:
    k8s.v1.cni.cncf.io/networks: l2-network
  name: tinypod
  namespace: ns1
spec:
  containers:
  - args:
    - pause
    image: k8s.gcr.io/e2e-test-images/agnhost:2.36
    imagePullPolicy: IfNotPresent
    name: agnhost-container
----

:leveloffset!:
:leveloffset: +3

// Module included in the following assemblies:
//
// * networking/multiple_networks/configuring-additional-network.adoc

:_mod-docs-content-type: CONCEPT
[id="configuring-pods-static-ip_{context}"]
= Configuring pods with a static IP address

The following example provisions a pod with a static IP address.

[NOTE]
====
* You can only specify the IP address for a pod's secondary network attachment for layer 2 attachments.
* Specifying a static IP address for the pod is only possible when the attachment configuration does not feature subnets.
====

[source,yaml]
----
apiVersion: v1
kind: Pod
metadata:
  annotations:
    k8s.v1.cni.cncf.io/networks: '[
      {
        "name": "l2-network", <1>
        "mac": "02:03:04:05:06:07", <2>
        "interface": "myiface1", <3>
        "ips": [
          "192.0.2.20/24"
          ] <4>
      }
    ]'
  name: tinypod
  namespace: ns1
spec:
  containers:
  - args:
    - pause
    image: k8s.gcr.io/e2e-test-images/agnhost:2.36
    imagePullPolicy: IfNotPresent
    name: agnhost-container
----
<1> The name of the network. This value must be unique across all `NetworkAttachmentDefinitions`.
<2> The MAC address to be assigned for the interface.
<3> The name of the network interface to be created for the pod.
<4> The IP addresses to be assigned to the network interface.

:leveloffset!:
// end OVN-Kubernetes includes

:leveloffset: +1

// Module included in the following assemblies:
//
// * networking/multiple_networks/configuring-additional-network.adoc
// * networking/hardware_networks/configuring-sriov-net-attach.adoc
// * virt/vm_networking/virt-connecting-vm-to-sriov.adoc

// Because the Cluster Network Operator abstracts the configuration for
// Macvlan, including IPAM configuration, this must be provided as YAML
// for the Macvlan CNI plugin only. In the future other Multus plugins
// might be managed the same way by the CNO.


:_mod-docs-content-type: CONCEPT
[id="nw-multus-ipam-object_{context}"]
= Configuration of IP address assignment for an additional network

The IP address management (IPAM) Container Network Interface (CNI) plugin provides IP addresses for other CNI plugins.

You can use the following IP address assignment types:

- Static assignment.
- Dynamic assignment through a DHCP server. The DHCP server you specify must be reachable from the additional network.
- Dynamic assignment through the Whereabouts IPAM CNI plugin.

////
IMPORTANT: If you set the `type` parameter to the `DHCP` value, you cannot set
any other parameters.
////

[id="nw-multus-static_{context}"]
== Static IP address assignment configuration

The following table describes the configuration for static IP address assignment:

.`ipam` static configuration object
[cols=".^2,.^2,.^6",options="header"]
|====
|Field|Type|Description

|`type`
|`string`
|The IPAM address type. The value `static` is required.

|`addresses`
|`array`
|An array of objects specifying IP addresses to assign to the virtual interface. Both IPv4 and IPv6 IP addresses are supported.

|`routes`
|`array`
|An array of objects specifying routes to configure inside the pod.

|`dns`
|`array`
|Optional: An array of objects specifying the DNS configuration.

|====

The `addresses` array requires objects with the following fields:

.`ipam.addresses[]` array
[cols=".^2,.^2,.^6",options="header"]
|====
|Field|Type|Description

|`address`
|`string`
|An IP address and network prefix that you specify. For example, if you specify `10.10.21.10/24`, then the additional network is assigned an IP address of `10.10.21.10` and the netmask is `255.255.255.0`.

|`gateway`
|`string`
|The default gateway to route egress network traffic to.

|====

.`ipam.routes[]` array
[cols=".^2,.^2,.^6",options="header"]
|====
|Field|Type|Description

|`dst`
|`string`
|The IP address range in CIDR format, such as `192.168.17.0/24` or `0.0.0.0/0` for the default route.

|`gw`
|`string`
|The gateway where network traffic is routed.

|====

.`ipam.dns` object
[cols=".^2,.^2,.^6",options="header"]
|====
|Field|Type|Description

|`nameservers`
|`array`
|An array of one or more IP addresses for to send DNS queries to.

|`domain`
|`array`
|The default domain to append to a hostname. For example, if the
domain is set to `example.com`, a DNS lookup query for `example-host` is
rewritten as `example-host.example.com`.

|`search`
|`array`
|An array of domain names to append to an unqualified hostname,
such as `example-host`, during a DNS lookup query.

|====

.Static IP address assignment configuration example
[source,json]
----
{
  "ipam": {
    "type": "static",
      "addresses": [
        {
          "address": "191.168.1.7/24"
        }
      ]
  }
}
----

[id="nw-multus-dhcp_{context}"]
== Dynamic IP address (DHCP) assignment configuration

The following JSON describes the configuration for dynamic IP address address assignment with DHCP.

.Renewal of DHCP leases
[IMPORTANT]
====
A pod obtains its original DHCP lease when it is created. The lease must be periodically renewed by a minimal DHCP server deployment running on the cluster.


To trigger the deployment of the DHCP server, you must create a shim network attachment by editing the Cluster Network Operator configuration, as in the following example:

.Example shim network attachment definition
[source,yaml]
----
apiVersion: operator.openshift.io/v1
kind: Network
metadata:
  name: cluster
spec:
  additionalNetworks:
  - name: dhcp-shim
    namespace: default
    type: Raw
    rawCNIConfig: |-
      {
        "name": "dhcp-shim",
        "cniVersion": "0.3.1",
        "type": "bridge",
        "ipam": {
          "type": "dhcp"
        }
      }
  # ...
----
====

.`ipam` DHCP configuration object
[cols=".^2,.^2,.^6",options="header"]
|====
|Field|Type|Description

|`type`
|`string`
|The IPAM address type. The value `dhcp` is required.

|====

.Dynamic IP address (DHCP) assignment configuration example
[source,json]
----
{
  "ipam": {
    "type": "dhcp"
  }
}
----

[id="nw-multus-whereabouts_{context}"]
== Dynamic IP address assignment configuration with Whereabouts

The Whereabouts CNI plugin allows the dynamic assignment of an IP address to an additional network without the use of a DHCP server.

The following table describes the configuration for dynamic IP address assignment with Whereabouts:

.`ipam` whereabouts configuration object
[cols=".^2,.^2,.^6",options="header"]
|====
|Field|Type|Description

|`type`
|`string`
|The IPAM address type. The value `whereabouts` is required.

|`range`
|`string`
|An IP address and range in CIDR notation. IP addresses are assigned from within this range of addresses.

|`exclude`
|`array`
|Optional: A list of zero or more IP addresses and ranges in CIDR notation. IP addresses within an excluded address range are not assigned.

|====

////
[NOTE]
=====
Whereabouts can be used for both IPv4 and IPv6 addresses.
=====
////

.Dynamic IP address assignment configuration example that uses Whereabouts
[source,json]
----
{
  "ipam": {
    "type": "whereabouts",
    "range": "192.0.2.192/27",
    "exclude": [
       "192.0.2.192/30",
       "192.0.2.196/32"
    ]
  }
}
----


[id="nw-multus-creating-whereabouts-reconciler-daemon-set_{context}"]
== Creating a Whereabouts reconciler daemon set

The Whereabouts reconciler is responsible for managing dynamic IP address assignments for the pods within a cluster using the Whereabouts IP Address Management (IPAM) solution. It ensures that each pods gets a unique IP address from the specified IP address range. It also handles IP address releases when pods are deleted or scaled down.

[NOTE]
====
You can also use a `NetworkAttachmentDefinition` custom resource for dynamic IP address assignment.
====

The Whereabouts reconciler daemon set is automatically created when you configure an additional network through the Cluster Network Operator. It is not automatically created when you configure an additional network from a YAML manifest.

To trigger the deployment of the Whereabouts reconciler daemonset, you must manually create a `whereabouts-shim` network attachment by editing the Cluster Network Operator custom resource file.

Use the following procedure to deploy the Whereabouts reconciler daemonset.

.Procedure

. Edit the `Network.operator.openshift.io` custom resource (CR) by running the following command:
+
[source,terminal]
----
$ oc edit network.operator.openshift.io cluster
----

. Modify the `additionalNetworks` parameter in the CR to add the `whereabouts-shim` network attachment definition. For example:
+
[source,yaml]
----
apiVersion: operator.openshift.io/v1
kind: Network
metadata:
  name: cluster
spec:
  additionalNetworks:
  - name: whereabouts-shim
    namespace: default
    rawCNIConfig: |-
      {
       "name": "whereabouts-shim",
       "cniVersion": "0.3.1",
       "type": "bridge",
       "ipam": {
         "type": "whereabouts"
       }
      }
    type: Raw
----

. Save the file and exit the text editor.

. Verify that the `whereabouts-reconciler` daemon set deployed successfully by running the following command:
+
[source,terminal]
----
$ oc get all -n openshift-multus | grep whereabouts-reconciler
----
+
.Example output
+
[source,terminal]
----
pod/whereabouts-reconciler-jnp6g 1/1 Running 0 6s
pod/whereabouts-reconciler-k76gg 1/1 Running 0 6s
pod/whereabouts-reconciler-k86t9 1/1 Running 0 6s
pod/whereabouts-reconciler-p4sxw 1/1 Running 0 6s
pod/whereabouts-reconciler-rvfdv 1/1 Running 0 6s
pod/whereabouts-reconciler-svzw9 1/1 Running 0 6s
daemonset.apps/whereabouts-reconciler 6 6 6 6 6 kubernetes.io/os=linux 6s
----

:leveloffset!:

:leveloffset: +2

// Module included in the following assemblies:
//
// * networking/multiple_networks/configuring-additional-network.adoc

:_mod-docs-content-type: PROCEDURE

[id="nw-multus-configure-dualstack-ip-address_{context}"]
= Creating a configuration for assignment of dual-stack IP addresses dynamically

Dual-stack IP address assignment can be configured with the `ipRanges` parameter for:

* IPv4 addresses
* IPv6 addresses
* multiple IP address assignment

.Procedure

. Set `type` to `whereabouts`.

. Use `ipRanges` to allocate IP addresses as shown in the following example:
+
[source,yaml]
----
cniVersion: operator.openshift.io/v1
kind: Network
=metadata:
  name: cluster
spec:
  additionalNetworks:
  - name: whereabouts-shim
    namespace: default
    type: Raw
    rawCNIConfig: |-
      {
       "name": "whereabouts-dual-stack",
       "cniVersion": "0.3.1,
       "type": "bridge",
       "ipam": {
         "type": "whereabouts",
         "ipRanges": [
                  {"range": "192.168.10.0/24"},
                  {"range": "2001:db8::/64"}
              ]
       }
      }

----

. Attach network to a pod. For more information, see "Adding a pod to an additional network".

. Verify that all IP addresses are assigned.

. Run the following command to ensure the IP addresses are assigned as metadata.
+
[source,yaml]
----
$ oc exec -it mypod -- ip a
----

:leveloffset!:

[role="_additional-resources"]
.Additional resources
* xref:../../networking/multiple_networks/attaching-pod.html#nw-multus-add-pod_attaching-pod[Attaching a pod to an additional network]

:leveloffset: +1

// Module included in the following assemblies:
//
// * networking/multiple_networks/configuring-additional-network.adoc

:_mod-docs-content-type: PROCEDURE
[id="nw-multus-create-network_{context}"]
= Creating an additional network attachment with the Cluster Network Operator

The Cluster Network Operator (CNO) manages additional network definitions. When
you specify an additional network to create, the CNO creates the
`NetworkAttachmentDefinition` object automatically.

[IMPORTANT]
====
Do not edit the `NetworkAttachmentDefinition` objects that the Cluster Network
Operator manages. Doing so might disrupt network traffic on your additional
network.
====

.Prerequisites

* Install the OpenShift CLI (`oc`).
* Log in as a user with `cluster-admin` privileges.

.Procedure

. Optional: Create the namespace for the additional networks:
+
[source,terminal]
----
$ oc create namespace <namespace_name>
----

. To edit the CNO configuration, enter the following command:
+
[source,terminal]
----
$ oc edit networks.operator.openshift.io cluster
----

. Modify the CR that you are creating by adding the configuration for the
additional network that you are creating, as in the following example CR.
+
[source,yaml,subs="attributes+"]
----
apiVersion: operator.openshift.io/v1
kind: Network
metadata:
  name: cluster
spec:
  # ...
  additionalNetworks:
  - name: tertiary-net
    namespace: namespace2
    type: Raw
    rawCNIConfig: |-
      {
        "cniVersion": "0.3.1",
        "name": "tertiary-net",
        "type": "ipvlan",
        "master": "eth1",
        "mode": "l2",
        "ipam": {
          "type": "static",
          "addresses": [
            {
              "address": "192.168.1.23/24"
            }
          ]
        }
      }
----

. Save your changes and quit the text editor to commit your changes.

.Verification

* Confirm that the CNO created the `NetworkAttachmentDefinition` object by running the following command. There might be a delay before the CNO creates the object.
+
[source,terminal]
----
$ oc get network-attachment-definitions -n <namespace>
----
+
--
where:

`<namespace>`:: Specifies the namespace for the network attachment that you added to the CNO configuration.
--
+
.Example output
[source,terminal]
----
NAME                 AGE
test-network-1       14m
----

:leveloffset!:

:leveloffset: +1

// Module included in the following assemblies:
//

:_mod-docs-content-type: PROCEDURE
[id="nw-multus-create-network-apply_{context}"]
= Creating an additional network attachment by applying a YAML manifest

.Prerequisites

* Install the OpenShift CLI (`oc`).
* Log in as a user with `cluster-admin` privileges.

.Procedure

. Create a YAML file with your additional network configuration, such as in the following example:
+
[source,yaml]
----
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: next-net
spec:
  config: |-
    {
      "cniVersion": "0.3.1",
      "name": "work-network",
      "type": "host-device",
      "device": "eth1",
      "ipam": {
        "type": "dhcp"
      }
    }
----

. To create the additional network, enter the following command:
+
[source,terminal]
----
$ oc apply -f <file>.yaml
----
+
--
where:

`<file>`:: Specifies the name of the file contained the YAML manifest.
--

:leveloffset!:

:leveloffset: +1

// Module included in the following assemblies:
//
// * networking/multiple_networks/configuring-additional-network.adoc

:_mod-docs-content-type: CONCEPT

[id="nw-about-configuring-master-interface-container_{context}"]
= About configuring the master interface in the container network namespace

In {product-title} 4.14 and later, the ability to allow users to create a MAC-VLAN, IP-VLAN, and VLAN subinterface based on a master interface in a container namespace is now generally available.

This feature allows you to create the master interfaces as part of the pod network configuration in a separate network attachment definition. You can then base the VLAN, MACVLAN, or IPVLAN on this interface without requiring the knowledge of the network configuration of the node.

To ensure the use of a container namespace master interface specify the `linkInContainer` and set the value to `true` in the VLAN, MACVLAN, or IPVLAN plugin configuration depending on the particular type of additional network.

An example use case for utilizing this feature is to create multiple VLANs based on SR-IOV VFs. To do so, begin by creating an SR-IOV network and then define the network attachments for the VLAN interfaces.

The following example shows how to configure the setup illustrated in this diagram.

.Creating VLANs
image::345_OpenShift_config_additional_network_0823.png[Creating VLANs]

.Prerequisites
* You installed the OpenShift CLI (`oc`).
* You have access to the cluster as a user with the `cluster-admin` role.
* You have installed the SR-IOV Network Operator.

.Procedure

. Create a dedicated container namespace where you want to deploy your pod by using the following command:
+
[source,terminal]
----
$ oc new-project test-namespace
----
. Create an SR-IOV node policy:

.. Create an `SriovNetworkNodePolicy` object, and then save the YAML in the `sriov-node-network-policy.yaml` file:
+
[source,yaml]
----
apiVersion: sriovnetwork.openshift.io/v1
kind: SriovNetworkNodePolicy
metadata:
 name: sriovnic
 namespace: openshift-sriov-network-operator
spec:
 deviceType: netdevice
 isRdma: false
 needVhostNet: true
 nicSelector:
   vendor: "15b3" <1>
   deviceID: "101b" <2>
   rootDevices: ["00:05.0"]
 numVfs: 10
 priority: 99
 resourceName: sriovnic
 nodeSelector:
    feature.node.kubernetes.io/network-sriov.capable: "true"
----
+
[NOTE]
====
The SR-IOV network node policy configuration example, with the setting `deviceType: netdevice`, is tailored specifically for Mellanox Network Interface Cards (NICs).
====
+
<1> The vendor hexadecimal code of the SR-IOV network device. The value `15b3` is associated with a Mellanox NIC.
<2> The device hexadecimal code of the SR-IOV network device.

.. Apply the YAML by running the following command:
+
[source,terminal]
----
$ oc apply -f sriov-node-network-policy.yaml
----
+
[NOTE]
====
Applying this might take some time due to the node requiring a reboot.
====

. Create an SR-IOV network:

.. Create the `SriovNetwork` custom resource (CR) for the additional SR-IOV network attachment as in the following example CR. Save the YAML as the file `sriov-network-attachment.yaml`:
+
[source,yaml]
----
apiVersion: sriovnetwork.openshift.io/v1
kind: SriovNetwork
metadata:
 name: sriov-network
 namespace: openshift-sriov-network-operator
spec:
 networkNamespace: test-namespace
 resourceName: sriovnic
 spoofChk: "off"
 trust: "on"
----

.. Apply the YAML by running the following command:
+
[source,terminal]
----
$ oc apply -f sriov-network-attachment.yaml
----

. Create a YAML file for the VLAN additional network configuration and then save the YAML in the `vlan100-additional-network-configuration.yaml` file:
+
[source,yaml]
----
apiVersion: k8s.cni.cncf.io/v1
kind: NetworkAttachmentDefinition
metadata:
  name: vlan-100
  namespace: test-namespace
spec:
  config: |
    {
      "cniVersion": "0.4.0",
      "name": "vlan-100",
      "plugins": [
        {
          "type": "vlan",
          "master": "ext0", <1>
          "mtu": 1500,
          "vlanId": 100,
          "linkInContainer": true, <2>
          "ipam": {"type": "whereabouts", "ipRanges": [{"range": "1.1.1.0/24"}]}
        }
      ]
    }
----
+
<1> The VLAN configuration needs to specify the master name. This can be configured in the pod networks annotation.
<2> The `linkInContainer` parameter must be specified.

. Apply the YAML by running the following command:
+
[source,terminal]
----
$ oc apply -f vlan100-additional-network-configuration.yaml
----

. Create a pod definition by using the earlier specified networks and then save the YAML in the `pod-a.yaml` file.
+
[NOTE]
====
The manifest below includes 2 resources:

* Namespace with security labels
* Pod definition with appropriate network annotation
====
+
[source,yaml]
----
apiVersion: v1
kind: Namespace
metadata:
  name: test-namespace
  labels:
    pod-security.kubernetes.io/enforce: privileged
    pod-security.kubernetes.io/audit: privileged
    pod-security.kubernetes.io/warn: privileged
    security.openshift.io/scc.podSecurityLabelSync: "false"
---
apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod
  namespace: test-namespace
  annotations:
    k8s.v1.cni.cncf.io/networks: '[
      {
        "name": "sriov-network",
        "namespace": "test-namespace",
        "interface": "ext0" <1>
      },
      {
        "name": "vlan-100",
        "namespace": "test-namespace",
        "interface": "ext0.100"
      }
    ]'
spec:
  securityContext:
    runAsNonRoot: true
  containers:
    - name: nginx-container
      image: nginxinc/nginx-unprivileged:latest
      securityContext:
        allowPrivilegeEscalation: false
        capabilities:
          drop: ["ALL"]
      ports:
        - containerPort: 80
      seccompProfile:
        type: "RuntimeDefault"
----
+
<1> The name to be used as the master for the VLAN interface.

. Apply the YAML by running the following command:
+
[source,terminal]
----
$ oc apply -f pod-a.yaml
----

. Get detailed information about the `nginx-pod` within the `test-namespace` by running the following command:
+
[source,terminal]
----
$ oc describe pods nginx-pod -n test-namespace
----
+
.Expected output
+
[source,terminal]
----
Name:         nginx-pod
Namespace:    test-namespace
Priority:     0
Node:         worker-1/10.46.186.105
Start Time:   Mon, 14 Aug 2023 16:23:13 -0400
Labels:       <none>
Annotations:  k8s.ovn.org/pod-networks:
                {"default":{"ip_addresses":["10.131.0.26/23"],"mac_address":"0a:58:0a:83:00:1a","gateway_ips":["10.131.0.1"],"routes":[{"dest":"10.128.0.0...
              k8s.v1.cni.cncf.io/network-status:
                [{
                    "name": "ovn-kubernetes",
                    "interface": "eth0",
                    "ips": [
                        "10.131.0.26"
                    ],
                    "mac": "0a:58:0a:83:00:1a",
                    "default": true,
                    "dns": {}
                },{
                    "name": "test-namespace/sriov-network",
                    "interface": "ext0",
                    "mac": "6e:a7:5e:3f:49:1b",
                    "dns": {},
                    "device-info": {
                        "type": "pci",
                        "version": "1.0.0",
                        "pci": {
                            "pci-address": "0000:d8:00.2"
                        }
                    }
                },{
                    "name": "test-namespace/vlan-100",
                    "interface": "ext0.100",
                    "ips": [
                        "1.1.1.1"
                    ],
                    "mac": "6e:a7:5e:3f:49:1b",
                    "dns": {}
                }]
              k8s.v1.cni.cncf.io/networks:
                [ { "name": "sriov-network", "namespace": "test-namespace", "interface": "ext0" }, { "name": "vlan-100", "namespace": "test-namespace", "i...
              openshift.io/scc: privileged
Status:       Running
IP:           10.131.0.26
IPs:
  IP:  10.131.0.26
----

:leveloffset!:

//# includes=_attributes/common-attributes,modules/nw-multus-bridge-object,modules/nw-multus-host-device-object,modules/nw-multus-vlan-object,modules/nw-multus-ipvlan-object,modules/nw-multus-macvlan-object,modules/nw-multus-tap-object,modules/configuring-ovnk-additional-networks,modules/configuration-ovnk-network-plugin-json-object,modules/configuration-ovnk-multi-network-policy,modules/configuring-layer-two-switched-topology,~modules/configuring-localnet-switched-topology,modules/configuring-pods-secondary-network,modules/configuring-pods-static-ip,modules/nw-multus-ipam-object,modules/nw-multus-configure-dualstack-ip-address,modules/nw-multus-create-network,modules/nw-multus-create-network-apply,modules/nw-about-configuring-master-interface-container
