:_mod-docs-content-type: ASSEMBLY
[id="ossm-create-smcp"]
= Creating the ServiceMeshControlPlane
// The {product-title} attribute provides the context-sensitive name of the relevant OpenShift distribution, for example, "OpenShift Container Platform" or "OKD". The {product-version} attribute provides the product version relative to the distribution, for example "4.9".
// {product-title} and {product-version} are parsed when AsciiBinder queries the _distro_map.yml file in relation to the base branch of a pull request.
// See https://github.com/openshift/openshift-docs/blob/main/contributing_to_docs/doc_guidelines.adoc#product-name-and-version for more information on this topic.
// Other common attributes are defined in the following lines:
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:imagesdir: images
:prewrap!:
:op-system-first: Red Hat Enterprise Linux CoreOS (RHCOS)
:op-system: RHCOS
:op-system-lowercase: rhcos
:op-system-base: RHEL
:op-system-base-full: Red Hat Enterprise Linux (RHEL)
:op-system-version: 8.x
:tsb-name: Template Service Broker
:kebab: image:kebab.png[title="Options menu"]
:rh-openstack-first: Red Hat OpenStack Platform (RHOSP)
:rh-openstack: RHOSP
:ai-full: Assisted Installer
:ai-version: 2.3
:cluster-manager-first: Red Hat OpenShift Cluster Manager
:cluster-manager: OpenShift Cluster Manager
:cluster-manager-url: link:https://console.redhat.com/openshift[OpenShift Cluster Manager Hybrid Cloud Console]
:cluster-manager-url-pull: link:https://console.redhat.com/openshift/install/pull-secret[pull secret from the Red Hat OpenShift Cluster Manager]
:insights-advisor-url: link:https://console.redhat.com/openshift/insights/advisor/[Insights Advisor]
:hybrid-console: Red Hat Hybrid Cloud Console
:hybrid-console-second: Hybrid Cloud Console
:oadp-first: OpenShift API for Data Protection (OADP)
:oadp-full: OpenShift API for Data Protection
:oc-first: pass:quotes[OpenShift CLI (`oc`)]
:product-registry: OpenShift image registry
:rh-storage-first: Red Hat OpenShift Data Foundation
:rh-storage: OpenShift Data Foundation
:rh-rhacm-first: Red Hat Advanced Cluster Management (RHACM)
:rh-rhacm: RHACM
:rh-rhacm-version: 2.8
:sandboxed-containers-first: OpenShift sandboxed containers
:sandboxed-containers-operator: OpenShift sandboxed containers Operator
:sandboxed-containers-version: 1.3
:sandboxed-containers-version-z: 1.3.3
:sandboxed-containers-legacy-version: 1.3.2
:cert-manager-operator: cert-manager Operator for Red Hat OpenShift
:secondary-scheduler-operator-full: Secondary Scheduler Operator for Red Hat OpenShift
:secondary-scheduler-operator: Secondary Scheduler Operator
// Backup and restore
:velero-domain: velero.io
:velero-version: 1.11
:launch: image:app-launcher.png[title="Application Launcher"]
:mtc-short: MTC
:mtc-full: Migration Toolkit for Containers
:mtc-version: 1.8
:mtc-version-z: 1.8.0
// builds (Valid only in 4.11 and later)
:builds-v2title: Builds for Red Hat OpenShift
:builds-v2shortname: OpenShift Builds v2
:builds-v1shortname: OpenShift Builds v1
//gitops
:gitops-title: Red Hat OpenShift GitOps
:gitops-shortname: GitOps
:gitops-ver: 1.1
:rh-app-icon: image:red-hat-applications-menu-icon.jpg[title="Red Hat applications"]
//pipelines
:pipelines-title: Red Hat OpenShift Pipelines
:pipelines-shortname: OpenShift Pipelines
:pipelines-ver: pipelines-1.12
:pipelines-version-number: 1.12
:tekton-chains: Tekton Chains
:tekton-hub: Tekton Hub
:artifact-hub: Artifact Hub
:pac: Pipelines as Code
//odo
:odo-title: odo
//OpenShift Kubernetes Engine
:oke: OpenShift Kubernetes Engine
//OpenShift Platform Plus
:opp: OpenShift Platform Plus
//openshift virtualization (cnv)
:VirtProductName: OpenShift Virtualization
:VirtVersion: 4.14
:KubeVirtVersion: v0.59.0
:HCOVersion: 4.14.0
:CNVNamespace: openshift-cnv
:CNVOperatorDisplayName: OpenShift Virtualization Operator
:CNVSubscriptionSpecSource: redhat-operators
:CNVSubscriptionSpecName: kubevirt-hyperconverged
:delete: image:delete.png[title="Delete"]
//distributed tracing
:DTProductName: Red Hat OpenShift distributed tracing platform
:DTShortName: distributed tracing platform
:DTProductVersion: 2.9
:JaegerName: Red Hat OpenShift distributed tracing platform (Jaeger)
:JaegerShortName: distributed tracing platform (Jaeger)
:JaegerVersion: 1.47.0
:OTELName: Red Hat OpenShift distributed tracing data collection
:OTELShortName: distributed tracing data collection
:OTELOperator: Red Hat OpenShift distributed tracing data collection Operator
:OTELVersion: 0.81.0
:TempoName: Red Hat OpenShift distributed tracing platform (Tempo)
:TempoShortName: distributed tracing platform (Tempo)
:TempoOperator: Tempo Operator
:TempoVersion: 2.1.1
//logging
:logging-title: logging subsystem for Red Hat OpenShift
:logging-title-uc: Logging subsystem for Red Hat OpenShift
:logging: logging subsystem
:logging-uc: Logging subsystem
//serverless
:ServerlessProductName: OpenShift Serverless
:ServerlessProductShortName: Serverless
:ServerlessOperatorName: OpenShift Serverless Operator
:FunctionsProductName: OpenShift Serverless Functions
//service mesh v2
:product-dedicated: Red Hat OpenShift Dedicated
:product-rosa: Red Hat OpenShift Service on AWS
:SMProductName: Red Hat OpenShift Service Mesh
:SMProductShortName: Service Mesh
:SMProductVersion: 2.4.4
:MaistraVersion: 2.4
//Service Mesh v1
:SMProductVersion1x: 1.1.18.2
//Windows containers
:productwinc: Red Hat OpenShift support for Windows Containers
// Red Hat Quay Container Security Operator
:rhq-cso: Red Hat Quay Container Security Operator
// Red Hat Quay
:quay: Red Hat Quay
:sno: single-node OpenShift
:sno-caps: Single-node OpenShift
//TALO and Redfish events Operators
:cgu-operator-first: Topology Aware Lifecycle Manager (TALM)
:cgu-operator-full: Topology Aware Lifecycle Manager
:cgu-operator: TALM
:redfish-operator: Bare Metal Event Relay
//Formerly known as CodeReady Containers and CodeReady Workspaces
:openshift-local-productname: Red Hat OpenShift Local
:openshift-dev-spaces-productname: Red Hat OpenShift Dev Spaces
// Factory-precaching-cli tool
:factory-prestaging-tool: factory-precaching-cli tool
:factory-prestaging-tool-caps: Factory-precaching-cli tool
:openshift-networking: Red Hat OpenShift Networking
// TODO - this probably needs to be different for OKD
//ifdef::openshift-origin[]
//:openshift-networking: OKD Networking
//endif::[]
// logical volume manager storage
:lvms-first: Logical volume manager storage (LVM Storage)
:lvms: LVM Storage
//Operator SDK version
:osdk_ver: 1.31.0
//Operator SDK version that shipped with the previous OCP 4.x release
:osdk_ver_n1: 1.28.0
//Next-gen (OCP 4.14+) Operator Lifecycle Manager, aka "v1"
:olmv1: OLM 1.0
:olmv1-first: Operator Lifecycle Manager (OLM) 1.0
:ztp-first: GitOps Zero Touch Provisioning (ZTP)
:ztp: GitOps ZTP
:3no: three-node OpenShift
:3no-caps: Three-node OpenShift
:run-once-operator: Run Once Duration Override Operator
// Web terminal
:web-terminal-op: Web Terminal Operator
:devworkspace-op: DevWorkspace Operator
:secrets-store-driver: Secrets Store CSI driver
:secrets-store-operator: Secrets Store CSI Driver Operator
//AWS STS
:sts-first: Security Token Service (STS)
:sts-full: Security Token Service
:sts-short: STS
//Cloud provider names
//AWS
:aws-first: Amazon Web Services (AWS)
:aws-full: Amazon Web Services
:aws-short: AWS
//GCP
:gcp-first: Google Cloud Platform (GCP)
:gcp-full: Google Cloud Platform
:gcp-short: GCP
//alibaba cloud
:alibaba: Alibaba Cloud
// IBM Cloud VPC
:ibmcloudVPCProductName: IBM Cloud VPC
:ibmcloudVPCRegProductName: IBM(R) Cloud VPC
// IBM Cloud
:ibm-cloud-bm: IBM Cloud Bare Metal (Classic)
:ibm-cloud-bm-reg: IBM Cloud(R) Bare Metal (Classic)
// IBM Power
:ibmpowerProductName: IBM Power
:ibmpowerRegProductName: IBM(R) Power
// IBM zSystems
:ibmzProductName: IBM Z
:ibmzRegProductName: IBM(R) Z
:linuxoneProductName: IBM(R) LinuxONE
//Azure
:azure-full: Microsoft Azure
:azure-short: Azure
//vSphere
:vmw-full: VMware vSphere
:vmw-short: vSphere
//Oracle
:oci-first: Oracle(R) Cloud Infrastructure
:oci: OCI
:ocvs-first: Oracle(R) Cloud VMware Solution (OCVS)
:ocvs: OCVS
:context: ossm-create-smcp

toc::[]

:leveloffset: +1

// Module included in the following assemblies:
// * service_mesh/v2x/ossm-create-smcp.adoc

:_mod-docs-content-type: CONCEPT
[id="ossm-about-smcp_{context}"]
= About ServiceMeshControlPlane

The control plane includes Istiod, Ingress and Egress Gateways, and other components, such as Kiali and Jaeger. The control plane must be deployed in a separate namespace than the {SMProductShortName} Operators and the data plane applications and services. You can deploy a basic installation of the `ServiceMeshControlPlane`(SMCP) from the {product-title} web console or the command line using the `oc` client tool.

[NOTE]
====
This basic installation is configured based on the default {product-title} settings and is not designed for production use. Use this default installation to verify your installation, and then configure your `ServiceMeshControlPlane` settings for your environment.
====

[NOTE]
====
Red Hat OpenShift Service on AWS (ROSA) places additional restrictions on where you can create resources, and as a result, the default deployment does not work. See Installing {SMProductShortName} on Red Hat OpenShift Service on AWS for additional requirements before deploying your SMCP in a ROSA environment.
====

[NOTE]
====
The {SMProductShortName} documentation uses `istio-system` as the example project, but you can deploy the service mesh to any project.
====


:leveloffset!:

:leveloffset: +2

// Module included in the following assemblies:
//
// * service_mesh/v2x/installing-ossm.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-control-plane-deploy-operatorhub_{context}"]
= Deploying the {SMProductShortName} control plane from the web console

You can deploy a basic `ServiceMeshControlPlane` by using the web console.  In this example, `istio-system` is the name of the {SMProductShortName} control plane project.

.Prerequisites

* The {SMProductName} Operator must be installed.
* An account with the `cluster-admin` role.

.Procedure

. Log in to the {product-title} web console as a user with the `cluster-admin` role. If you use {product-dedicated}, you must have an account with the `dedicated-admin` role.

. Create a project named `istio-system`.
+
.. Navigate to *Home* -> *Projects*.
+
.. Click *Create Project*.
+
.. In the *Name* field, enter `istio-system`. The `ServiceMeshControlPlane` resource must be installed in a project that is separate from your microservices and Operators.
+
These steps use `istio-system` as an example, but you can deploy your {SMProductShortName} control plane in any project as long as it is separate from the project that contains your services.
+
.. Click *Create*.

. Navigate to *Operators* -> *Installed Operators*.

. Click the {SMProductName} Operator, then click *Istio Service Mesh Control Plane*.

. On the *Istio Service Mesh Control Plane* tab, click *Create ServiceMeshControlPlane*.

. On the *Create ServiceMeshControlPlane* page, accept the default {SMProductShortName} control plane version to take advantage of the features available in the most current version of the product. The version of the control plane determines the features available regardless of the version of the Operator.
+
.. Click *Create*. The Operator creates pods, services, and {SMProductShortName} control plane components based on your configuration parameters. You can configure `ServiceMeshControlPlane` settings later.
+
. To verify the control plane installed correctly, click the *Istio Service Mesh Control Plane* tab.
+
.. Click the name of the new control plane.
+
.. Click the *Resources* tab to see the {SMProductName} control plane resources the Operator created and configured.

:leveloffset!:

:leveloffset: +2

////
This module is included in the following assemblies:
* service_mesh/v2x/ossm-create-smcp.adoc
////
:_mod-docs-content-type: PROCEDURE
[id="ossm-control-plane-deploy-cli_{context}"]
= Deploying the {SMProductShortName} control plane using the CLI

You can deploy a basic `ServiceMeshControlPlane` from the command line.

.Prerequisites

* The {SMProductName} Operator must be installed.
* Access to the OpenShift CLI (`oc`).

.Procedure

. Log in to the {product-title} CLI as a user with the `cluster-admin` role. If you use {product-dedicated}, you must have an account with the `dedicated-admin` role.
+
[source,terminal]
----
$ oc login --username=<NAMEOFUSER> https://<HOSTNAME>:6443
----
+
. Create a project named `istio-system`.
+
[source,terminal]
----
$ oc new-project istio-system
----
+
. Create a `ServiceMeshControlPlane` file named `istio-installation.yaml` using the following example. The version of the {SMProductShortName} control plane determines the features available regardless of the version of the Operator.
+
.Example version {MaistraVersion} istio-installation.yaml
[source,yaml, subs="attributes,verbatim"]
----
apiVersion: maistra.io/v2
kind: ServiceMeshControlPlane
metadata:
  name: basic
  namespace: istio-system
spec:
  version: v{MaistraVersion}
  tracing:
    type: Jaeger
    sampling: 10000
  addons:
    jaeger:
      name: jaeger
      install:
        storage:
          type: Memory
    kiali:
      enabled: true
      name: kiali
    grafana:
      enabled: true
----
+
. Run the following command to deploy the {SMProductShortName} control plane, where `<istio_installation.yaml>` includes the full path to your file.
+
[source,terminal]
----
$ oc create -n istio-system -f <istio_installation.yaml>
----
+
. To watch the progress of the pod deployment, run the following command:
+
[source,terminal]
----
$ oc get pods -n istio-system -w
----
+
You should see output similar to the following:
+
[source,terminal]
----
NAME                                   READY   STATUS    RESTARTS   AGE
grafana-b4d59bd7-mrgbr                 2/2     Running   0          65m
istio-egressgateway-678dc97b4c-wrjkp   1/1     Running   0          108s
istio-ingressgateway-b45c9d54d-4qg6n   1/1     Running   0          108s
istiod-basic-55d78bbbcd-j5556          1/1     Running   0          108s
jaeger-67c75bd6dc-jv6k6                2/2     Running   0          65m
kiali-6476c7656c-x5msp                 1/1     Running   0          43m
prometheus-58954b8d6b-m5std            2/2     Running   0          66m
----

:leveloffset!:

:leveloffset: +2

////
This module is included in the following assemblies:
* service_mesh/v2x/ossm-create-smcp.adoc
////
:_mod-docs-content-type: PROCEDURE
[id="ossm-validate-control-plane-cli_{context}"]
= Validating your SMCP installation with the CLI
You can validate the creation of the `ServiceMeshControlPlane` from the command line.

.Procedure

. Log in to the {product-title} CLI as a user with the `cluster-admin` role. If you use Red Hat OpenShift Dedicated, you must have an account with the `dedicated-admin` role.
+
[source,terminal]
----
$ oc login https://<HOSTNAME>:6443
----
+
. Run the following command to verify the {SMProductShortName} control plane installation, where `istio-system` is the namespace where you installed the {SMProductShortName} control plane.
+
[source,terminal]
----
$ oc get smcp -n istio-system
----
+
The installation has finished successfully when the `STATUS` column is `ComponentsReady`.
+
[source,terminal]
----
NAME    READY   STATUS            PROFILES      VERSION   AGE
basic   10/10   ComponentsReady   ["default"]   2.1.1     66m
----

:leveloffset!:


:leveloffset: +1

// Module included in the following assemblies:
// * service_mesh/v2x/ossm-create-smcp.adoc

:_mod-docs-content-type: CONCEPT
[id="ossm-about-control-plane-components-and-infrastructure-nodes_{context}"]
= About control plane components and infrastructure nodes

Infrastructure nodes provide a way to isolate infrastructure workloads for two primary purposes:

* To prevent incurring billing costs against subscription counts
* To separate maintenance and management of infrastructure workloads

You can configure some or all of the {SMProductShortName} control plane components to run on infrastructure nodes.

:leveloffset!:

:leveloffset: +2

// Module included in the following assemblies:
//
// * service_mesh/v2x/ossm-deployment-models.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-config-control-plane-infrastructure-node-console_{context}"]
= Configuring all control plane components to run on infrastructure nodes using the web console

Perform this task if all of the components deployed by the {SMProductShortName} control plane will run on infrastructure nodes. These deployed components include Istiod, Ingress Gateway, and Egress Gateway, and optional applications such as Prometheus, Grafana, and Distributed Tracing.

If the control plane will run on a worker node, skip this task.

.Prerequisites

* You have installed the {SMProductName} Operator.
* You are logged in as a user with the `cluster-admin` role. If you use {product-dedicated}, you are logged in as a user with the `dedicated-admin` role.

.Procedure

. Log in to the {product-title} web console.

. Navigate to *Operators* -> *Installed Operators*.

. Click the {SMProductName} Operator, and then click *Istio Service Mesh Control Plane*.

. Click the name of the control plane resource. For example, `basic`.

. Click *YAML*.

. Add the `nodeSelector` and `tolerations` fields to the `spec.runtime.defaults.pod` specification in the `ServiceMeshControlPlane` resource, as shown in the following example:
+
[source,yaml]
----
spec:
  runtime:
    defaults:
      pod:
        nodeSelector: <1>
          node-role.kubernetes.io/infra: ""
        tolerations: <2>
        - effect: NoSchedule
          key: node-role.kubernetes.io/infra
          value: reserved
        - effect: NoExecute
          key: node-role.kubernetes.io/infra
          value: reserved
----
<1> Ensures that the `ServiceMeshControlPlane` pod is only scheduled on an infrastructure node.
<2> Ensures that the pod is accepted by the infrastructure node for execution.

. Click *Save*.

. Click *Reload*.

:leveloffset!:

:leveloffset: +2

// Module included in the following assemblies:
//
// * service_mesh/v2x/ossm-deployment-models.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-config-individual-control-plane-infrastructure-node-console_{context}"]
= Configuring individual control plane components to run on infrastructure nodes using the web console

Perform this task if individual components deployed by the {SMProductShortName} control plane will run on infrastructure nodes. These deployed components include Istiod, the Ingress Gateway, and the Egress Gateway.

If the control plane will run on a worker node, skip this task.

.Prerequisites

* You have installed the {SMProductName} Operator.
* You are logged in as a user with the `cluster-admin` role. If you use {product-dedicated}, you are logged in as a user with the `dedicated-admin` role.

.Procedure

. Log in to the {product-title} web console.

. Navigate to *Operators* -> *Installed Operators*.

. Click the {SMProductName} Operator, and then click *Istio Service Mesh Control Plane*.

. Click the name of the control plane resource. For example, `basic`.

. Click *YAML*.

. Add the `nodeSelector` and `tolerations` fields to the `spec.runtime.components.pilot.pod` specification in the `ServiceMeshControlPlane` resource, as shown in the following example:
+
[source,yaml]
----
spec:
  runtime:
    components:
      pilot:
        pod:
          nodeSelector: <1>
            node-role.kubernetes.io/infra: ""
          tolerations: <2>
          - effect: NoSchedule
            key: node-role.kubernetes.io/infra
            value: reserved
          - effect: NoExecute
            key: node-role.kubernetes.io/infra
            value: reserved
----
<1> Ensures that the `Istiod` pod is only scheduled on an infrastructure node.
<2> Ensures that the pod is accepted by the infrastructure node for execution.

. Add the `nodeSelector` and the `tolerations` fields to the `spec.gateways.ingress.runtime.pod` and `spec.gateways.egress.runtime.pod` specifications in the `ServiceMeshControlPlane` resource, as shown in the following example:
+
[source,yaml]
----
spec:
  gateways:
    ingress:
      runtime:
        pod:
          nodeSelector: <1>
            node-role.kubernetes.io/infra: ""
          tolerations: <2>
          - effect: NoSchedule
            key: node-role.kubernetes.io/infra
            value: reserved
          - effect: NoExecute
            key: node-role.kubernetes.io/infra
            value: reserved
    egress:
      runtime:
        pod:
          nodeSelector: <1>
            node-role.kubernetes.io/infra: ""
          tolerations: <2>
          - effect: NoSchedule
            key: node-role.kubernetes.io/infra
            value: reserved
          - effect: NoExecute
            key: node-role.kubernetes.io/infra
            value: reserved
----
<1> Ensures that the gateway pod is only scheduled on an infrastructure node
<2> Ensures that the pod is accepted by the infrastructure node for execution.

. Click *Save*.

. Click *Reload*.

:leveloffset!:

:leveloffset: +2

// Module included in the following assemblies:
//
// * service_mesh/v2x/ossm-deployment-models.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-config-control-plane-infrastructure-node-cli_{context}"]
= Configuring all control plane components to run on infrastructure nodes using the CLI

Perform this task if all of the components deployed by the {SMProductShortName} control plane will run on infrastructure nodes. These deployed components include Istiod, Ingress Gateway, and Egress Gateway, and optional applications such as Prometheus, Grafana, and Distributed Tracing.

If the control plane will run on a worker node, skip this task.

.Prerequisites

* You have installed the {SMProductName} Operator.
* You are logged in as a user with the `cluster-admin` role. If you use {product-dedicated}, you are logged in as a user with the `dedicated-admin` role.

.Procedure

. Open the `ServiceMeshControlPlane` resource as a YAML file:
+
[source,terminal]
----
$ oc -n istio-system edit smcp <name> <1>
----
<1> `<name>` represents the name of the `ServiceMeshControlPlane` resource.

. To run all of the {SMProductShortName} components deployed by the `ServiceMeshControlPlane` on infrastructure nodes, add the `nodeSelector` and `tolerations` fields to the `spec.runtime.defaults.pod` spec in the `ServiceMeshControlPlane` resource:
+
[source,yaml]
----
spec:
  runtime:
    defaults:
      pod:
        nodeSelector: <1>
          node-role.kubernetes.io/infra: ""
        tolerations: <2>
        - effect: NoSchedule
          key: node-role.kubernetes.io/infra
          value: reserved
        - effect: NoExecute
          key: node-role.kubernetes.io/infra
          value: reserved
----
<1> Ensures that the SMCP pods are only scheduled on an infrastructure node.
<2> Ensures that the pods are accepted by the infrastructure node.

:leveloffset!:

:leveloffset: +2

// Module included in the following assemblies:
//
// * service_mesh/v2x/ossm-deployment-models.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-config-individual-control-plane-infrastructure-node-cli_{context}"]
= Configuring individual control plane components to run on infrastructure nodes using the CLI

Perform this task if individual components deployed by the {SMProductShortName} control plane will run on infrastructure nodes. These deployed components include Istiod, the Ingress Gateway, and the Egress Gateway.

If the control plane will run on a worker node, skip this task.

.Prerequisites

* You have installed the {SMProductName} Operator.
* You are logged in as a user with the `cluster-admin` role. If you use {product-dedicated}, you are logged in as a user with the `dedicated-admin` role.

.Procedure

. Open the `ServiceMeshControlPlane` resource as a YAML file.
+
[source,terminal]
----
$ oc -n istio-system edit smcp <name> <1>
----
<1>  `<name>` represents the name of the `ServiceMeshControlPlane` resource.

. To run the Istiod component on an infrastructure node, add the `nodeSelector` and the `tolerations` fields to the `spec.runtime.components.pilot.pod` spec in the `ServiceMeshControlPlane` resource.
+
[source,yaml]
----
spec:
  runtime:
    components:
      pilot:
        pod:
          nodeSelector: <1>
            node-role.kubernetes.io/infra: ""
          tolerations: <2>
          - effect: NoSchedule
            key: node-role.kubernetes.io/infra
            value: reserved
          - effect: NoExecute
            key: node-role.kubernetes.io/infra
            value: reserved
----
<1> Ensures that the `Istiod` pod is only scheduled on an infrastructure node.
<2> Ensures that the pod is accepted by the infrastructure node.

. To run Ingress and Egress Gateways on infrastructure nodes, add the `nodeSelector` and the `tolerations` fields to the `spec.gateways.ingress.runtime.pod` spec and the `spec.gateways.egress.runtime.pod` spec in the `ServiceMeshControlPlane` resource.
+
[source,yaml]
----
spec:
  gateways:
    ingress:
      runtime:
        pod:
          nodeSelector: <1>
            node-role.kubernetes.io/infra: ""
          tolerations: <2>
          - effect: NoSchedule
            key: node-role.kubernetes.io/infra
            value: reserved
          - effect: NoExecute
            key: node-role.kubernetes.io/infra
            value: reserved
    egress:
      runtime:
        pod:
          nodeSelector: <1>
            node-role.kubernetes.io/infra: ""
          tolerations: <2>
          - effect: NoSchedule
            key: node-role.kubernetes.io/infra
            value: reserved
          - effect: NoExecute
            key: node-role.kubernetes.io/infra
            value: reserved
----
<1> Ensures that the gateway pod is only scheduled on an infrastructure node
<2> Ensures that the pod is accepted by the infrastructure node.

:leveloffset!:

:leveloffset: +2

// Module included in the following assemblies:
//
// * service_mesh/v2x/installing-ossm.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-confirm-smcp-infrastructure-node_{context}"]
= Verifying the {SMProductShortName} control plane is running on infrastructure nodes

.Procedure

* Confirm that the nodes associated with Istiod, Ingress Gateway, and Egress Gateway pods are infrastructure nodes:
+
[source,terminal]
----
$ oc -n istio-system get pods -owide
----

:leveloffset!:


:leveloffset: +1

// Module included in the following assemblies:
// * service_mesh/v2x/ossm-create-smcp.adoc

:_mod-docs-content-type: CONCEPT
[id="ossm-about-control-plane-and-cluster-wide-deployment_{context}"]
= About control plane and cluster-wide deployments

A cluster-wide deployment contains a {SMProductShortName} Control Plane that monitors resources for an entire cluster. Monitoring resources for an entire cluster closely resembles Istio functionality in that the control plane uses a single query across all namespaces to monitor Istio and Kubernetes resources. As a result, cluster-wide deployments decrease the number of requests sent to the API server.

You can configure the {SMProductShortName} Control Plane for cluster-wide deployments using either the {product-title} web console or the CLI.

:leveloffset!:

:leveloffset: +2

// Module included in the following assemblies:
//
// * service_mesh/v2x/ossm-create-smcp.adoc

:_mod-docs-content-type: PROCEDURE
[id="ossm-deploy-cluster-wide-control-plane-console_{context}"]
= Configuring the control plane for cluster-wide deployment with the web console

You can configure the `ServiceMeshControlPlane` resource for cluster-wide deployment using the {product-title} web console. In this example, `istio-system` is the name of the {SMProductShortName} control plane project.

.Prerequisites

* The {SMProductName} Operator is installed.
* You are logged in using an account with the `cluster-admin` role, or if you use {product-dedicated} with the `dedicated-admin` role.

.Procedure

. Create a project named `istio-system`.
+
.. Navigate to *Home* -> *Projects*.
+
.. Click *Create Project*.
+
.. In the *Name* field, enter `istio-system`. The `ServiceMeshControlPlane` resource must be installed in a project that is separate from your microservices and Operators.
+
These steps use `istio-system` as an example. You can deploy the {SMProductShortName} control plane to any project as long as it is separate from the project that contains your services.
+
.. Click *Create*.

. Navigate to *Operators* -> *Installed Operators*.

. Click the {SMProductName} Operator, then click *Istio Service Mesh Control Plane*.

. On the *Istio Service Mesh Control Plane* tab, click *Create ServiceMeshControlPlane*.

. Click *YAML view*. The version of the {SMProductShortName} control plane determines the features available regardless of the version of the Operator.

. Modify the `spec.mode` field of the YAML file to specify `ClusterWide`.
+
.Example version {MaistraVersion} istio-installation.yaml
+
[source,yaml, subs="attributes,verbatim"]
----
apiVersion: maistra.io/v2
kind: ServiceMeshControlPlane
metadata:
  name: basic
  namespace: istio-system
spec:
  version: v{MaistraVersion}
  mode: ClusterWide
----

. Click *Create*. The Operator creates pods, services, and {SMProductShortName} control plane components based on your configuration parameters. The operator also creates the `ServiceMeshMemberRoll` if it does not exist as part of the default configuration.

. To verify that the control plane installed correctly, click the *Istio Service Mesh Control Plane* tab.
+
.. Click the name of the new `ServiceMeshControlPlane` object.
+
.. Click the *Resources* tab to see the {SMProductName} control plane resources that the Operator created and configured.

:leveloffset!:

:leveloffset: +2

//
This module is included in the following assemblies:
* service_mesh/v2x/ossm-create-smcp.adoc
//
:_mod-docs-content-type: PROCEDURE
[id="ossm-deploy-cluster-wide-control-plane-cli_{context}"]
= Configuring the control plane for cluster-wide deployment with the CLI

You can configure the `ServiceMeshControlPlane` resource for cluster-wide deployment using the CLI. In this example, `istio-system` is the name of the Service Mesh control plane namespace.

.Prerequisites

* The {SMProductName} Operator is installed.
* You have access to the OpenShift CLI (`oc`).

.Procedure

. Log in to the {product-title} CLI as a user with the `cluster-admin` role. If you use {product-dedicated}, you must have an account with the `dedicated-admin` role.
+
[source,terminal]
----
$ oc login --username=<NAMEOFUSER> https://<HOSTNAME>:6443
----
+
. Create a project named `istio-system`.
+
[source,terminal]
----
$ oc new-project istio-system
----

. Create a `ServiceMeshControlPlane` file named `istio-installation.yaml` using the following example.
+
.Example version {MaistraVersion} istio-installation.yaml
[source,yaml, subs="attributes,verbatim"]
----
apiVersion: maistra.io/v2
kind: ServiceMeshControlPlane
metadata:
  name: basic
  namespace: istio-system
spec:
  version: v{MaistraVersion}
  mode: ClusterWide
----

. Run the following command to deploy the {SMProductShortName} control plane, where `<istio_installation.yaml>` includes the full path to your file.
+
[source,terminal]
----
$ oc create -n istio-system -f <istio_installation.yaml>
----
+
. To monitor the progress of the pod deployment, run the following command:
+
[source,terminal]
----
$ oc get pods -n istio-system -w
----
+
You should see output similar to the following example:
+
.Example output
[source,terminal]
----
NAME                                   READY   STATUS    RESTARTS   AGE
grafana-b4d59bd7-mrgbr                 2/2     Running   0          65m
istio-egressgateway-678dc97b4c-wrjkp   1/1     Running   0          108s
istio-ingressgateway-b45c9d54d-4qg6n   1/1     Running   0          108s
istiod-basic-55d78bbbcd-j5556          1/1     Running   0          108s
jaeger-67c75bd6dc-jv6k6                2/2     Running   0          65m
kiali-6476c7656c-x5msp                 1/1     Running   0          43m
prometheus-58954b8d6b-m5std            2/2     Running   0          66m
----

:leveloffset!:

:leveloffset: +2

//
This module is included in the following assemblies:
* service_mesh/v2x/ossm-create-smcp.adoc
//

:_mod-docs-content-type: CONCEPT
[id="ossm-customize-smrr-cluster-wide_{context}"]
= Customizing the member roll for a cluster-wide mesh

In cluster-wide mode, when you create the `ServiceMeshControlPlane` resource, the `ServiceMeshMemberRoll` resource is also created. You can modify the `ServiceMeshMemberRoll` resource after it gets created. After you modify the resource, the {SMProductShortName} operator no longer changes it. If you modify the `ServiceMeshMemberRoll` resource by using the {product-title} web console, accept the prompt to overwrite the modifications.

Alternatively, you can create a `ServiceMeshMemberRoll` resource before deploying the `ServiceMeshControlPlane` resource. When you create the `ServiceMeshControlPlane` resource, the {SMProductShortName} Operator will not modify the `ServiceMeshMemberRoll`.

[NOTE]
====
The `ServiceMeshMemberRoll` resource name must be named `default` and must be created in the same project namespace as the `ServiceMeshControlPlane` resource.
====

There are two ways to add a namespace to the mesh. You can either add the namespace by specifying its name in the `spec.members` list, or configure a set of namespace label selectors to include or exclude namespaces based on their labels.

[NOTE]
====
Regardless of how members are specified in the `ServiceMeshMemberRoll` resource, you can also add members to the mesh by creating the `ServiceMeshMember` resource in each namespace.
====

:leveloffset!:

:leveloffset: +1

////
This module is included in the following assemblies:
* service_mesh/v2x/ossm-create-smcp.adoc
////
:_mod-docs-content-type: PROCEDURE
[id="ossm-validate-control-plane-kiali_{context}"]
= Validating your SMCP installation with Kiali

You can use the Kiali console to validate your {SMProductShortName} installation. The Kiali console offers several ways to validate your {SMProductShortName} components are deployed and configured properly.

.Procedure

. Log in to the {product-title} web console as a user with cluster-admin rights. If you use {product-dedicated}, you must have an account with the `dedicated-admin` role.

. Navigate to *Networking* -> *Routes*.

. On the *Routes* page, select the {SMProductShortName} control plane project, for example `istio-system`, from the *Namespace* menu.
+
The *Location* column displays the linked address for each route.
+
. If necessary, use the filter to find the route for the Kiali console. Click the route *Location* to launch the console.

. Click *Log In With OpenShift*.
+
When you first log in to the Kiali Console, you see the *Overview* page which displays all the namespaces in your service mesh that you have permission to view. When there are multiple namespaces shown on the *Overview* page, Kiali shows namespaces with health or validation problems first.
+
.Kiali Overview page
image::ossm-kiali-overview.png[Kiali Overview page showing istio-system]
+
The tile for each namespace displays the number of labels, the *Istio Config* health, the number of and *Applications* health, and *Traffic* for the namespace. If you are validating the console installation and namespaces have not yet been added to the mesh, there might not be any data to display other than `istio-system`.

. Kiali has four dashboards specifically for the namespace where the {SMProductShortName} control plane is installed.  To view these dashboards, click the *Options* menu {kebab} on the tile for the control plane namespace, for example, `istio-system`, and select one of the following options:

** *Istio Mesh Dashboard*
** *Istio Control Plane Dashboard*
** *Istio Performance Dashboard*
** *Istio Wasm Exetension Dashboard*
+
.Grafana Istio Control Plane Dashboard
image::ossm-grafana-control-plane-dashboard.png[Istio Control Plane Dashboard showing data for bookinfo sample project]
+
Kiali also installs two additional Grafana dashboards, available from the Grafana *Home* page:
** *Istio Workload Dashboard*
** *Istio Service Dashboard*
+
. To view the {SMProductShortName} control plane nodes, click the *Graph* page, select the *Namespace* where you installed the `ServiceMeshControlPlane` from the menu, for example `istio-system`.

.. If necessary, click *Display idle nodes*.

.. To learn more about the *Graph* page, click the *Graph tour* link.

.. To view the mesh topology, select one or more additional namespaces from the Service Mesh Member Roll from the *Namespace* menu.

. To view the list of applications in the `istio-system` namespace, click the *Applications* page. Kiali displays the health of the applications.

.. Hover your mouse over the information icon to view any additional information noted in the *Details* column.

. To view the list of workloads in the `istio-system` namespace, click the *Workloads* page. Kiali displays the health of the workloads.

.. Hover your mouse over the information icon to view any additional information noted in the *Details* column.

. To view the list of services in the `istio-system` namespace, click the *Services* page. Kiali displays the health of the services and of the configurations.

.. Hover your mouse over the information icon to view any additional information noted in the *Details* column.

. To view a list of the Istio Configuration objects in the `istio-system` namespace, click the *Istio Config* page. Kiali displays the health of the configuration.

.. If there are configuration errors, click the row and Kiali opens the configuration file with the error highlighted.

:leveloffset!:

:leveloffset: +1

////
This module included in the following assemblies:
* service_mesh/v2/ossm-create-smcp.adoc
////

:_mod-docs-content-type: REFERENCE
[id="ossm-install-rosa_{context}"]
= Installing on Red Hat OpenShift Service on AWS (ROSA)

Starting with version 2.2, {SMProductName} supports installation on Red Hat OpenShift Service on AWS (ROSA). This section documents the additional requirements when installing Service Mesh on this platform.

[id="ossm-install-rosa-location_{context}"]
== Installation location

You must create a new namespace, for example `istio-system`, when installing {SMProductName} and creating the `ServiceMeshControlPlane`.

[id="ossm-install-rosa-smcp_{context}"]
== Required {SMProductShortName} control plane configuration

The default configuration in the `ServiceMeshControlPlane` file does not work on a ROSA cluster. You must modify the default SMCP and set `spec.security.identity.type=ThirdParty` when installing on Red Hat OpenShift Service on AWS.

.Example `ServiceMeshControlPlane` resource for ROSA
[source,yaml, subs="attributes,verbatim"]
----
apiVersion: maistra.io/v2
kind: ServiceMeshControlPlane
metadata:
  name: basic
  namespace: istio-system
spec:
  version: v{MaistraVersion}
  security:
    identity:
      type: ThirdParty  #required setting for ROSA
  tracing:
    type: Jaeger
    sampling: 10000
  policy:
    type: Istiod
  addons:
    grafana:
      enabled: true
    jaeger:
      install:
        storage:
          type: Memory
    kiali:
      enabled: true
    prometheus:
      enabled: true
  telemetry:
    type: Istiod
----

[id="ossm-install-rosa-kiali-config_{context}"]
== Restrictions on Kiali configuration

Red Hat OpenShift Service on AWS places additional restrictions on where you can create resources and does not let you create the Kiali resource in a Red Hat managed namespace.

This means that the following common settings for `spec.deployment.accessible_namespaces` are not allowed in a ROSA cluster:

* `['**']`   (all namespaces)
* `default`
* `codeready-*`
* `openshift-*`
* `redhat-*`

The validation error message provides a complete list of all the restricted namespaces.

.Example `Kiali` resource for ROSA
[source,yaml]
----
apiVersion: kiali.io/v1alpha1
kind: Kiali
metadata:
  name: kiali
  namespace: istio-system
spec:
  auth:
    strategy: openshift
  deployment:
    accessible_namespaces:   #restricted setting for ROSA
      - istio-system
    image_pull_policy: ''
    ingress_enabled: true
    namespace: istio-system
----

:leveloffset!:

[role="_additional-resources"]
== Additional resources

{SMProductName} supports multiple independent control planes within the cluster. You can create reusable configurations with `ServiceMeshControlPlane` profiles. For more information, see xref:../../service_mesh/v2x/ossm-profiles-users.adoc#ossm-control-plane-profiles_ossm-profiles-users[Creating control plane profiles].

== Next steps

* Add a project to the {SMProductShortName} so that applications can be made available. For more information, see xref:../../service_mesh/v2x/ossm-create-mesh.adoc#ossm-create-mesh[Adding services to a service mesh].

//# includes=_attributes/common-attributes,modules/ossm-about-smcp,modules/ossm-control-plane-web,modules/ossm-control-plane-cli,modules/ossm-validate-smcp-cli,modules/ossm-about-control-plane-components-and-infrastructure-nodes,modules/ossm-config-control-plane-infrastructure-node-console,modules/ossm-config-individual-control-plane-infrastructure-node-console,modules/ossm-config-control-plane-infrastructure-node-cli,modules/ossm-config-individual-control-plane-infrastructure-node-cli,modules/ossm-confirm-smcp-infrastructure-node,modules/ossm-about-control-plane-and-cluster-wide-deployment,modules/ossm-deploy-cluster-wide-control-plane-console,modules/ossm-deploy-cluster-wide-control-plane-cli,modules/ossm-customize-smmr-cluster-wide,modules/ossm-validate-smcp-kiali,modules/ossm-install-rosa
