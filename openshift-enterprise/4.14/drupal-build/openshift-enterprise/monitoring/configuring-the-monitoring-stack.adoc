:_mod-docs-content-type: ASSEMBLY
[id="configuring-the-monitoring-stack"]
= Configuring the monitoring stack
include::includes/common-attributes.adoc[]
:context: configuring-the-monitoring-stack


ifndef::openshift-dedicated,openshift-rosa[]
The {product-title} 4 installation program provides only a low number of configuration options before installation. Configuring most {product-title} framework components, including the cluster monitoring stack, happens postinstallation.
endif::openshift-dedicated,openshift-rosa[]

This section explains what configuration is supported,
ifndef::openshift-dedicated,openshift-rosa[]
shows how to configure the monitoring stack,
endif::openshift-dedicated,openshift-rosa[]
ifdef::openshift-dedicated,openshift-rosa[]
shows how to configure the monitoring stack for user-defined projects,
endif::openshift-dedicated,openshift-rosa[]
and demonstrates several common configuration scenarios.

ifndef::openshift-dedicated,openshift-rosa[]
== Prerequisites

* The monitoring stack imposes additional resource requirements. Consult the computing resources recommendations in link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/scalability_and_performance/#scaling-cluster-monitoring-operator[Scaling the Cluster Monitoring Operator] and verify that you have sufficient resources.
endif::openshift-dedicated,openshift-rosa[]

// Maintenance and support for monitoring
include::includes/monitoring-maintenance-and-support.adoc[leveloffset=+1]
include::includes/monitoring-support-considerations.adoc[leveloffset=+2]
ifndef::openshift-dedicated,openshift-rosa[]
include::includes/monitoring-unmanaged-monitoring-operators.adoc[leveloffset=+2]
endif::openshift-dedicated,openshift-rosa[]

ifndef::openshift-dedicated,openshift-rosa[]
// Preparing to configure the monitoring stack
[id="preparing-to-configure-the-monitoring-stack"]
== Preparing to configure the monitoring stack

You can configure the monitoring stack by creating and updating monitoring config maps.

include::includes/monitoring-creating-cluster-monitoring-configmap.adoc[leveloffset=+2]
include::includes/monitoring-creating-user-defined-workload-monitoring-configmap.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* xref:enabling-monitoring-for-user-defined-projects[Enabling monitoring for user-defined projects]
endif::openshift-dedicated,openshift-rosa[]

// Configuring the monitoring stack
include::includes/monitoring-configuring-the-monitoring-stack.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources

ifndef::openshift-dedicated,openshift-rosa[]
* Configuration reference for the xref:clustermonitoringconfiguration[`cluster-monitoring-config`] config map
endif::openshift-dedicated,openshift-rosa[]
* Configuration reference for the xref:userworkloadconfiguration[`user-workload-monitoring-config`] config map
ifndef::openshift-dedicated,openshift-rosa[]
* See xref:preparing-to-configure-the-monitoring-stack[Preparing to configure the monitoring stack] for steps to create monitoring config maps
* xref:enabling-monitoring-for-user-defined-projects[Enabling monitoring for user-defined projects]
endif::openshift-dedicated,openshift-rosa[]

// Configurable monitoring components
include::includes/monitoring-configurable-monitoring-components.adoc[leveloffset=+1]

// Moving monitoring components to different nodes
include::includes/monitoring-using-node-selectors-to-move-monitoring-components.adoc[leveloffset=+1]
[role="_additional-resources"]
.Additional resources
// The nodes topics may apply to OSD/ROSA when that content is ported from OCP.
ifndef::openshift-dedicated,openshift-rosa[]
* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/nodes/#nodes-nodes-working-updating_nodes-nodes-working[Understanding how to update labels on nodes]
* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/nodes/#nodes-scheduler-node-selectors[Placing pods on specific nodes using node selectors]
* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/nodes/#placing-pods-relative-to-other-pods-using-pod-affinity-and-anti-affinity-rules[Placing pods relative to other pods using affinity and anti-affinity rules]
* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/nodes/#controlling-pod-placement-using-pod-topology-spread-constraints[Controlling pod placement by using pod topology spread constraints]
endif::openshift-dedicated,openshift-rosa[]
* xref:configuring_pod_topology_spread_constraintsfor_monitoring_configuring-the-monitoring-stack[Configuring pod topology spread constraints for monitoring]
* link:https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector[Kubernetes documentation about node selectors]

include::includes/monitoring-moving-monitoring-components-to-different-nodes.adoc[leveloffset=+2]


[role="_additional-resources"]
.Additional resources

ifndef::openshift-dedicated,openshift-rosa[]
* See xref:preparing-to-configure-the-monitoring-stack[Preparing to configure the monitoring stack] for steps to create monitoring config maps
* xref:enabling-monitoring-for-user-defined-projects[Enabling monitoring for user-defined projects]
// This xref might be relevant for ROSA/OSD if the Node content is reused:
* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/nodes/#nodes-nodes-working-updating_nodes-nodes-working[Understanding how to update labels on nodes]
// This xref might be relevant for ROSA/OSD if the Node content is reused:
* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/nodes/#nodes-scheduler-node-selectors[Placing pods on specific nodes using node selectors]
endif::openshift-dedicated,openshift-rosa[]
* See the link:https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector[Kubernetes documentation] for details on the `nodeSelector` constraint

// Assigning tolerations to monitoring components
include::includes/monitoring-assigning-tolerations-to-monitoring-components.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources
ifndef::openshift-dedicated,openshift-rosa[]
* See xref:preparing-to-configure-the-monitoring-stack[Preparing to configure the monitoring stack] for steps to create monitoring config maps
* xref:enabling-monitoring-for-user-defined-projects[Enabling monitoring for user-defined projects]
// This xref might be relevant for ROSA/OSD if the Node content is reused:
* See the link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/nodes/#nodes-scheduler-taints-tolerations[{product-title} documentation] on taints and tolerations
endif::openshift-dedicated,openshift-rosa[]
* See the link:https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/[Kubernetes documentation] on taints and tolerations

ifndef::openshift-dedicated,openshift-rosa[]
// Setting the body size limit for metrics scraping
include::includes/monitoring-setting-the-body-size-limit-for-metrics-scraping.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources

* link:https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config[Prometheus scrape configuration documentation]
endif::openshift-dedicated,openshift-rosa[]

// Configuring limits and resource requests for monitoring components

[id="managing-cpu-and-memory-resources-for-monitoring-components"]
== Managing CPU and memory resources for monitoring components 

You can ensure that the containers that run monitoring components have enough CPU and memory resources by specifying values for resource limits and requests for those components.

You can configure these limits and requests for core platform monitoring components in the `openshift-monitoring` namespace and for the components that monitor user-defined projects in the `openshift-user-workload-monitoring` namespace.

include::includes/monitoring-about-specifying-limits-and-requests-for-monitoring-components.adoc[leveloffset=+2]
include::includes/monitoring-specifying-limits-and-requests-for-monitoring-components.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources
* link:https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits[Kubernetes requests and limits documentation]

// Configuring persistent storage
include::includes/monitoring-configuring-persistent-storage.adoc[leveloffset=+1]
include::includes/monitoring-configuring-a-local-persistent-volume-claim.adoc[leveloffset=+2]
ifndef::openshift-dedicated,openshift-rosa[]
include::includes/monitoring-resizing-a-persistent-storage-volume.adoc[leveloffset=+2]
endif::openshift-dedicated,openshift-rosa[]
include::includes/monitoring-modifying-retention-time-and-size-for-prometheus-metrics-data.adoc[leveloffset=+2]
include::includes/monitoring-modifying-the-retention-time-for-thanos-ruler-metrics-data.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources
ifndef::openshift-dedicated,openshift-rosa[]
* xref:creating-cluster-monitoring-configmap_configuring-the-monitoring-stack[Creating a cluster monitoring config map]
* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/scalability_and_performance/#prometheus-database-storage-requirements_cluster-monitoring-operator[Prometheus database storage requirements]
* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/scalability_and_performance/#optimizing-storage[Recommended configurable storage technology]
* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/storage/#understanding-persistent-storage[Understanding persistent storage]
* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/scalability_and_performance/#optimizing-storage[Optimizing storage]
* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/storage/#persistent-storage-using-local-volume[Configure local persistent storage]
* xref:enabling-monitoring-for-user-defined-projects[Enabling monitoring for user-defined projects]
endif::openshift-dedicated,openshift-rosa[]
ifdef::openshift-dedicated,openshift-rosa[]
* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/storage/#understanding-persistent-storage[Understanding persistent storage]
endif::openshift-dedicated,openshift-rosa[]

// Configuring remote write storage for Prometheus
include::includes/monitoring-configuring-remote-write-storage.adoc[leveloffset=+1]
include::includes/monitoring-supported-remote-write-authentication-settings.adoc[leveloffset=+2]
include::includes/monitoring-example-remote-write-authentication-settings.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* See link:https://prometheus.io/docs/operating/integrations/#remote-endpoints-and-storage[Setting up remote write compatible endpoints] for steps to create a remote write compatible endpoint (such as Thanos).
* See link:https://prometheus.io/docs/practices/remote_write/#remote-write-tuning[Tuning remote write settings] for information about how to optimize remote write settings for different use cases.
ifndef::openshift-dedicated,openshift-rosa[]
// This xref might be relevant for ROSA/OSD if this content is reused:
* See link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/nodes/#nodes-pods-secrets-about_nodes-pods-secrets[Understanding secrets] for steps to create and configure `Secret` objects in {product-title}.
* See the link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/api_reference/#spec-remotewrite-2[Prometheus REST API reference for remote write] for information about additional optional fields.
endif::openshift-dedicated,openshift-rosa[]

// Configuring labels for outgoing metrics
include::includes/monitoring-adding-cluster-id-labels-to-metrics.adoc[leveloffset=+1]
include::includes/monitoring-creating-cluster-id-labels-for-metrics.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* For details about write relabel configuration, see xref:configuring_remote_write_storage_configuring-the-monitoring-stack[Configuring remote write storage].

// Configuring metrics collection profiles
// TP features are excluded from OSD and ROSA. When this feature is GA, it can be included in the OSD/ROSA docs.
ifndef::openshift-dedicated,openshift-rosa[]
include::includes/monitoring-configuring-metrics-collection-profiles.adoc[leveloffset=+1]
include::includes/monitoring-choosing-a-metrics-collection-profile.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* See xref:viewing-a-list-of-available-metrics_managing-metrics[Viewing a list of available metrics] for steps to view a list of metrics being collected for a cluster.
* See link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/nodes/#enabling-features-using-featuregates[Enabling features using feature gates] for steps to enable Technology Preview features.
endif::openshift-dedicated,openshift-rosa[]

// Managing scrape sample limits for user-defined projects
include::includes/monitoring-limiting-scrape-samples-in-user-defined-projects.adoc[leveloffset=+1]
include::includes/monitoring-setting-scrape-sample-and-label-limits-for-user-defined-projects.adoc[leveloffset=+2]
ifndef::openshift-dedicated,openshift-rosa[]
include::includes/monitoring-creating-scrape-sample-alerts.adoc[leveloffset=+2]

[role="_additional-resources"]
.Additional resources

* xref:creating-user-defined-workload-monitoring-configmap_configuring-the-monitoring-stack[Creating a user-defined workload monitoring config map]
* xref:enabling-monitoring-for-user-defined-projects[Enabling monitoring for user-defined projects]
* See xref:determining-why-prometheus-is-consuming-disk-space_troubleshooting-monitoring-issues[Determining why Prometheus is consuming a lot of disk space] for steps to query which metrics have the highest number of scrape samples.
endif::openshift-dedicated,openshift-rosa[]

//Configuring external alertmanagers
include::includes/monitoring-configuring-external-alertmanagers.adoc[leveloffset=1]

//Configuring secrets for Alertmanager
include::includes/monitoring-configuring-secrets-for-alertmanager.adoc[leveloffset=1]
include::includes/monitoring-adding-a-secret-to-the-alertmanager-configuration.adoc[leveloffset=2]

//Attaching additional labels to your time series and alerts
include::includes/monitoring-attaching-additional-labels-to-your-time-series-and-alerts.adoc[leveloffset=+1]

ifndef::openshift-dedicated,openshift-rosa[]
[role="_additional-resources"]
.Additional resources

* See xref:preparing-to-configure-the-monitoring-stack[Preparing to configure the monitoring stack] for steps to create monitoring config maps.
* xref:enabling-monitoring-for-user-defined-projects[Enabling monitoring for user-defined projects]
endif::openshift-dedicated,openshift-rosa[]

// Configuring topology spread constraints for monitoring components
include::includes/monitoring-configuring-pod-topology-spread-constraints-for-monitoring.adoc[leveloffset=1]

[role="_additional-resources"]
.Additional resources

ifndef::openshift-dedicated,openshift-rosa[]
// This xref might be relevant to ROSA/OSD if the Node content is reused:
* link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/nodes/#nodes-scheduler-pod-topology-spread-constraints-about[Controlling pod placement by using pod topology spread constraints]
endif::openshift-dedicated,openshift-rosa[]
* link:https://kubernetes.io/docs/concepts/scheduling-eviction/topology-spread-constraints/[Kubernetes Pod Topology Spread Constraints documentation]

ifndef::openshift-dedicated,openshift-rosa[]
include::includes/monitoring-setting-up-pod-topology-spread-constraints-for-prometheus.adoc[leveloffset=2]
include::includes/monitoring-setting-up-pod-topology-spread-constraints-for-alertmanager.adoc[leveloffset=2]
endif::openshift-dedicated,openshift-rosa[]

include::includes/monitoring-setting-up-pod-topology-spread-constraints-for-thanos-ruler.adoc[leveloffset=2]

// Setting log levels for monitoring components
include::includes/monitoring-setting-log-levels-for-monitoring-components.adoc[leveloffset=+1]

// Setting query log for Prometheus
include::includes/monitoring-setting-query-log-file-for-prometheus.adoc[leveloffset=+1]

ifndef::openshift-dedicated,openshift-rosa[]
[role="_additional-resources"]
.Additional resources
* See xref:preparing-to-configure-the-monitoring-stack[Preparing to configure the monitoring stack] for steps to create monitoring config maps
* See xref:enabling-monitoring-for-user-defined-projects[Enabling monitoring for user-defined projects] for steps to enable user-defined monitoring.
endif::openshift-dedicated,openshift-rosa[]

// Enabling query logging for Thanos Querier
ifndef::openshift-dedicated,openshift-rosa[]
include::includes/monitoring-enabling-query-logging-for-thanos-querier.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources

* See xref:preparing-to-configure-the-monitoring-stack[Preparing to configure the monitoring stack] for steps to create monitoring config maps.
endif::openshift-dedicated,openshift-rosa[]

// Setting audit log levels for the Prometheus Adapter
ifndef::openshift-dedicated,openshift-rosa[]
include::includes/monitoring-setting-audit-log-levels-for-the-prometheus-adapter.adoc[leveloffset=1]

[role="_additional-resources"]
.Additional resources

* See xref:preparing-to-configure-the-monitoring-stack[Preparing to configure the monitoring stack] for steps to create monitoring config maps.
endif::openshift-dedicated,openshift-rosa[]

// Disabling the local Alertmanager
ifndef::openshift-dedicated,openshift-rosa[]
include::includes/monitoring-disabling-the-local-alertmanager.adoc[leveloffset=+1]

[role="_additional-resources"]
.Additional resources
* link:https://prometheus.io/docs/alerting/latest/alertmanager/[Prometheus Alertmanager documentation]
* xref:[Managing alerts]
endif::openshift-dedicated,openshift-rosa[]

ifndef::openshift-dedicated,openshift-rosa[]
== Next steps

* xref:enabling-monitoring-for-user-defined-projects[Enabling monitoring for user-defined projects]
* Learn about link:https://access.redhat.com/documentation/en-us/openshift_container_platform/4.14/html-single/support/#opting-out-remote-health-reporting_opting-out-remote-health-reporting[remote health reporting] and, if necessary, opt out of it.
endif::openshift-dedicated,openshift-rosa[]
