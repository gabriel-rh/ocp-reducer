:_mod-docs-content-type: ASSEMBLY
[id="installing-azure-account"]
= Configuring an Azure account
// The {product-title} attribute provides the context-sensitive name of the relevant OpenShift distribution, for example, "OpenShift Container Platform" or "OKD". The {product-version} attribute provides the product version relative to the distribution, for example "4.9".
// {product-title} and {product-version} are parsed when AsciiBinder queries the _distro_map.yml file in relation to the base branch of a pull request.
// See https://github.com/openshift/openshift-docs/blob/main/contributing_to_docs/doc_guidelines.adoc#product-name-and-version for more information on this topic.
// Other common attributes are defined in the following lines:
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:imagesdir: images
:prewrap!:
:op-system-first: Red Hat Enterprise Linux CoreOS (RHCOS)
:op-system: RHCOS
:op-system-lowercase: rhcos
:op-system-base: RHEL
:op-system-base-full: Red Hat Enterprise Linux (RHEL)
:op-system-version: 8.x
:tsb-name: Template Service Broker
:kebab: image:kebab.png[title="Options menu"]
:rh-openstack-first: Red Hat OpenStack Platform (RHOSP)
:rh-openstack: RHOSP
:ai-full: Assisted Installer
:ai-version: 2.3
:cluster-manager-first: Red Hat OpenShift Cluster Manager
:cluster-manager: OpenShift Cluster Manager
:cluster-manager-url: link:https://console.redhat.com/openshift[OpenShift Cluster Manager Hybrid Cloud Console]
:cluster-manager-url-pull: link:https://console.redhat.com/openshift/install/pull-secret[pull secret from the Red Hat OpenShift Cluster Manager]
:insights-advisor-url: link:https://console.redhat.com/openshift/insights/advisor/[Insights Advisor]
:hybrid-console: Red Hat Hybrid Cloud Console
:hybrid-console-second: Hybrid Cloud Console
:oadp-first: OpenShift API for Data Protection (OADP)
:oadp-full: OpenShift API for Data Protection
:oc-first: pass:quotes[OpenShift CLI (`oc`)]
:product-registry: OpenShift image registry
:rh-storage-first: Red Hat OpenShift Data Foundation
:rh-storage: OpenShift Data Foundation
:rh-rhacm-first: Red Hat Advanced Cluster Management (RHACM)
:rh-rhacm: RHACM
:rh-rhacm-version: 2.8
:sandboxed-containers-first: OpenShift sandboxed containers
:sandboxed-containers-operator: OpenShift sandboxed containers Operator
:sandboxed-containers-version: 1.3
:sandboxed-containers-version-z: 1.3.3
:sandboxed-containers-legacy-version: 1.3.2
:cert-manager-operator: cert-manager Operator for Red Hat OpenShift
:secondary-scheduler-operator-full: Secondary Scheduler Operator for Red Hat OpenShift
:secondary-scheduler-operator: Secondary Scheduler Operator
// Backup and restore
:velero-domain: velero.io
:velero-version: 1.11
:launch: image:app-launcher.png[title="Application Launcher"]
:mtc-short: MTC
:mtc-full: Migration Toolkit for Containers
:mtc-version: 1.8
:mtc-version-z: 1.8.0
// builds (Valid only in 4.11 and later)
:builds-v2title: Builds for Red Hat OpenShift
:builds-v2shortname: OpenShift Builds v2
:builds-v1shortname: OpenShift Builds v1
//gitops
:gitops-title: Red Hat OpenShift GitOps
:gitops-shortname: GitOps
:gitops-ver: 1.1
:rh-app-icon: image:red-hat-applications-menu-icon.jpg[title="Red Hat applications"]
//pipelines
:pipelines-title: Red Hat OpenShift Pipelines
:pipelines-shortname: OpenShift Pipelines
:pipelines-ver: pipelines-1.12
:pipelines-version-number: 1.12
:tekton-chains: Tekton Chains
:tekton-hub: Tekton Hub
:artifact-hub: Artifact Hub
:pac: Pipelines as Code
//odo
:odo-title: odo
//OpenShift Kubernetes Engine
:oke: OpenShift Kubernetes Engine
//OpenShift Platform Plus
:opp: OpenShift Platform Plus
//openshift virtualization (cnv)
:VirtProductName: OpenShift Virtualization
:VirtVersion: 4.14
:KubeVirtVersion: v0.59.0
:HCOVersion: 4.14.0
:CNVNamespace: openshift-cnv
:CNVOperatorDisplayName: OpenShift Virtualization Operator
:CNVSubscriptionSpecSource: redhat-operators
:CNVSubscriptionSpecName: kubevirt-hyperconverged
:delete: image:delete.png[title="Delete"]
//distributed tracing
:DTProductName: Red Hat OpenShift distributed tracing platform
:DTShortName: distributed tracing platform
:DTProductVersion: 2.9
:JaegerName: Red Hat OpenShift distributed tracing platform (Jaeger)
:JaegerShortName: distributed tracing platform (Jaeger)
:JaegerVersion: 1.47.0
:OTELName: Red Hat OpenShift distributed tracing data collection
:OTELShortName: distributed tracing data collection
:OTELOperator: Red Hat OpenShift distributed tracing data collection Operator
:OTELVersion: 0.81.0
:TempoName: Red Hat OpenShift distributed tracing platform (Tempo)
:TempoShortName: distributed tracing platform (Tempo)
:TempoOperator: Tempo Operator
:TempoVersion: 2.1.1
//logging
:logging-title: logging subsystem for Red Hat OpenShift
:logging-title-uc: Logging subsystem for Red Hat OpenShift
:logging: logging subsystem
:logging-uc: Logging subsystem
//serverless
:ServerlessProductName: OpenShift Serverless
:ServerlessProductShortName: Serverless
:ServerlessOperatorName: OpenShift Serverless Operator
:FunctionsProductName: OpenShift Serverless Functions
//service mesh v2
:product-dedicated: Red Hat OpenShift Dedicated
:product-rosa: Red Hat OpenShift Service on AWS
:SMProductName: Red Hat OpenShift Service Mesh
:SMProductShortName: Service Mesh
:SMProductVersion: 2.4.4
:MaistraVersion: 2.4
//Service Mesh v1
:SMProductVersion1x: 1.1.18.2
//Windows containers
:productwinc: Red Hat OpenShift support for Windows Containers
// Red Hat Quay Container Security Operator
:rhq-cso: Red Hat Quay Container Security Operator
// Red Hat Quay
:quay: Red Hat Quay
:sno: single-node OpenShift
:sno-caps: Single-node OpenShift
//TALO and Redfish events Operators
:cgu-operator-first: Topology Aware Lifecycle Manager (TALM)
:cgu-operator-full: Topology Aware Lifecycle Manager
:cgu-operator: TALM
:redfish-operator: Bare Metal Event Relay
//Formerly known as CodeReady Containers and CodeReady Workspaces
:openshift-local-productname: Red Hat OpenShift Local
:openshift-dev-spaces-productname: Red Hat OpenShift Dev Spaces
// Factory-precaching-cli tool
:factory-prestaging-tool: factory-precaching-cli tool
:factory-prestaging-tool-caps: Factory-precaching-cli tool
:openshift-networking: Red Hat OpenShift Networking
// TODO - this probably needs to be different for OKD
//ifdef::openshift-origin[]
//:openshift-networking: OKD Networking
//endif::[]
// logical volume manager storage
:lvms-first: Logical volume manager storage (LVM Storage)
:lvms: LVM Storage
//Operator SDK version
:osdk_ver: 1.31.0
//Operator SDK version that shipped with the previous OCP 4.x release
:osdk_ver_n1: 1.28.0
//Next-gen (OCP 4.14+) Operator Lifecycle Manager, aka "v1"
:olmv1: OLM 1.0
:olmv1-first: Operator Lifecycle Manager (OLM) 1.0
:ztp-first: GitOps Zero Touch Provisioning (ZTP)
:ztp: GitOps ZTP
:3no: three-node OpenShift
:3no-caps: Three-node OpenShift
:run-once-operator: Run Once Duration Override Operator
// Web terminal
:web-terminal-op: Web Terminal Operator
:devworkspace-op: DevWorkspace Operator
:secrets-store-driver: Secrets Store CSI driver
:secrets-store-operator: Secrets Store CSI Driver Operator
//AWS STS
:sts-first: Security Token Service (STS)
:sts-full: Security Token Service
:sts-short: STS
//Cloud provider names
//AWS
:aws-first: Amazon Web Services (AWS)
:aws-full: Amazon Web Services
:aws-short: AWS
//GCP
:gcp-first: Google Cloud Platform (GCP)
:gcp-full: Google Cloud Platform
:gcp-short: GCP
//alibaba cloud
:alibaba: Alibaba Cloud
// IBM Cloud VPC
:ibmcloudVPCProductName: IBM Cloud VPC
:ibmcloudVPCRegProductName: IBM(R) Cloud VPC
// IBM Cloud
:ibm-cloud-bm: IBM Cloud Bare Metal (Classic)
:ibm-cloud-bm-reg: IBM Cloud(R) Bare Metal (Classic)
// IBM Power
:ibmpowerProductName: IBM Power
:ibmpowerRegProductName: IBM(R) Power
// IBM zSystems
:ibmzProductName: IBM Z
:ibmzRegProductName: IBM(R) Z
:linuxoneProductName: IBM(R) LinuxONE
//Azure
:azure-full: Microsoft Azure
:azure-short: Azure
//vSphere
:vmw-full: VMware vSphere
:vmw-short: vSphere
//Oracle
:oci-first: Oracle(R) Cloud Infrastructure
:oci: OCI
:ocvs-first: Oracle(R) Cloud VMware Solution (OCVS)
:ocvs: OCVS
:context: installing-azure-account

toc::[]

Before you can install {product-title}, you must configure a Microsoft Azure account to meet installation requirements.

[IMPORTANT]
====
All Azure resources that are available through public endpoints are subject to
resource name restrictions, and you cannot create resources that use certain
terms. For a list of terms that Azure restricts, see
link:https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-reserved-resource-name[Resolve reserved resource name errors]
in the Azure documentation.
====

:leveloffset: +1

// Module included in the following assemblies:
//
// * installing/installing_azure/installing-azure-account.adoc
// * installing/installing_azure/installing-azure-user-infra.adoc
// * installing/installing_azure_stack_hub/installing-azure-stack-hub-user-infra.adoc
// * installing/installing_azure_stack_hub/installing-azure-stack-hub-account.adoc
// * installing/installing_azure/installing-restricted-networks-azure-user-provisioned.adoc

:cp: Azure

:_mod-docs-content-type: REFERENCE
[id="installation-azure-limits_{context}"]
= {cp} account limits

The {product-title} cluster uses a number of Microsoft {cp} components, and the default link:https://docs.microsoft.com/en-us/azure/azure-subscription-service-limits[Azure subscription and service limits, quotas, and constraints] affect your ability to install {product-title} clusters.

[IMPORTANT]
====
Default limits vary by offer category types, such as Free Trial and Pay-As-You-Go, and by series, such as Dv2, F, and G. For example, the default for Enterprise Agreement subscriptions is 350 cores.

Check the limits for your subscription type and if necessary, increase quota limits for your account before you install a default
cluster on Azure.
====

The following table summarizes the {cp} components whose limits can impact your
ability to install and run {product-title} clusters.

[cols="2a,3a,3a,8a",options="header"]
|===
|Component |Number of components required by default| Default {cp} limit |Description

|vCPU
|44
|20 per region
|A default cluster requires 44 vCPUs, so you must increase the account limit.

By default, each cluster creates the following instances:

* One bootstrap machine, which is removed after installation
* Three control plane machines
* Three compute machines

Because the bootstrap and control plane machines use `Standard_D8s_v3` virtual
machines, which use 8 vCPUs, and the compute machines use `Standard_D4s_v3`
virtual machines, which use 4 vCPUs, a default cluster requires 44 vCPUs.
The bootstrap node VM, which uses 8 vCPUs, is used only during installation.

To deploy more worker nodes, enable autoscaling, deploy large workloads, or use
a different instance type, you must further increase the vCPU limit for your
account to ensure that your cluster can deploy the machines that you require.

|OS Disk
|7
|
|Each cluster machine must have a minimum of 100 GB of storage and 300 IOPS. While these are the minimum supported values, faster storage is recommended for production clusters and clusters with intensive workloads. For more information about optimizing storage for performance, see the page titled "Optimizing storage" in the "Scalability and performance" section.

|VNet
| 1
| 1000 per region
| Each default cluster requires one Virtual Network (VNet), which contains two
subnets.

|Network interfaces
|7
|65,536 per region
|Each default cluster requires seven network interfaces. If you create more
machines or your deployed workloads create load balancers, your cluster uses
more network interfaces.

|Network security groups
|2
|5000
| Each cluster creates network security groups for each subnet in the VNet.
The default cluster creates network
security groups for the control plane and for the compute node subnets:

[horizontal]
 `controlplane`:: Allows the control plane machines to be reached on port 6443
 from anywhere
`node`:: Allows worker nodes to be reached from the internet on ports 80 and 443

|Network load balancers
| 3
| 1000 per region
|Each cluster creates the following
link:https://docs.microsoft.com/en-us/azure/load-balancer/load-balancer-overview[load balancers]:

[horizontal]
`default`:: Public IP address that load balances requests to ports 80 and 443 across worker machines
`internal`:: Private IP address that load balances requests to ports 6443 and 22623 across control plane machines
`external`:: Public IP address that load balances requests to port 6443 across control plane machines

If your applications create more Kubernetes `LoadBalancer` service objects,
your cluster uses more load balancers.

|Public IP addresses
|3
|
|Each of the two public load balancers uses a public IP address. The bootstrap
machine also uses a public IP address so that you can SSH into the
machine to troubleshoot issues during installation. The IP address for the
bootstrap node is used only during installation.

|Private IP addresses
|7
|
|The internal load balancer, each of the three control plane machines, and each
of the three worker machines each use a private IP address.

|Spot VM vCPUs (optional)
|0

If you configure spot VMs, your cluster must have two spot VM vCPUs for every compute node.
|20 per region
|This is an optional component. To use spot VMs, you must increase the Azure default limit to at least twice the number of compute nodes in your cluster.
[NOTE]
====
Using spot VMs for control plane nodes is not recommended.
====
|===

:!cp: Azure

:leveloffset!:

[role="_additional-resources"]
.Additional resources

* xref:../../scalability_and_performance/optimization/optimizing-storage.adoc#optimizing-storage[Optimizing storage].

:leveloffset: +1

// Module included in the following assemblies:
//
// * installing/installing_azure/installing-azure-account.adoc
// * installing/installing_azure/installing-azure-user-infra.adoc
// * installing/installing_azure/installing-restricted-networks-azure-user-provisioned.adoc

:_mod-docs-content-type: PROCEDURE
[id="installation-azure-network-config_{context}"]
= Configuring a public DNS zone in Azure

To install {product-title}, the Microsoft Azure account you use must
have a dedicated public hosted DNS zone in your account. This zone must be
authoritative for the domain. This service provides
cluster DNS resolution and name lookup for external connections to the cluster.

.Procedure

. Identify your domain, or subdomain, and registrar. You can transfer an
existing domain and registrar or obtain a new one through Azure or another source.
+
[NOTE]
====
For more information about purchasing domains through Azure, see
link:https://docs.microsoft.com/en-us/azure/app-service/manage-custom-dns-buy-domain[Buy a custom domain name for Azure App Service]
in the Azure documentation.
====

. If you are using an existing domain and registrar, migrate its DNS to Azure. See
link:https://docs.microsoft.com/en-us/azure/app-service/manage-custom-dns-migrate-domain[Migrate an active DNS name to Azure App Service]
in the Azure documentation.

. Configure DNS for your domain. Follow the steps in the
link:https://docs.microsoft.com/en-us/azure/dns/dns-delegate-domain-azure-dns[Tutorial: Host your domain in Azure DNS]
in the Azure documentation to create a public hosted zone for your domain or
subdomain, extract the new authoritative name servers, and update the registrar
records for the name servers that your domain uses.
+
Use an appropriate root domain, such as `openshiftcorp.com`, or subdomain,
such as `clusters.openshiftcorp.com`.

. If you use a subdomain, follow your company's procedures to add its delegation
records to the parent domain.

:leveloffset!:

:leveloffset: +1

// Module included in the following assemblies:
//
// * installing/installing_azure/installing-azure-account.adoc
// * installing/installing_azure/installing-azure-user-infra.adoc
// * installing/installing_azure/installing-restricted-networks-azure-user-provisioned.adoc

:_mod-docs-content-type: PROCEDURE
[id="installation-azure-increasing-limits_{context}"]
= Increasing Azure account limits

To increase an account limit, file a support request on the Azure portal.
[NOTE]
====
You can increase only one type of quota per support request.
====

.Procedure

. From the Azure portal, click *Help + support* in the lower left corner.

. Click *New support request* and then select the required values:
.. From the *Issue type* list, select *Service and subscription limits (quotas)*.
.. From the *Subscription* list, select the subscription to modify.
.. From the *Quota type* list, select the quota to increase. For example, select
*Compute-VM (cores-vCPUs) subscription limit increases* to increase the number
of vCPUs, which is required to install a cluster.
.. Click *Next: Solutions*.

. On the *Problem Details* page, provide the required information for your quota
increase:
.. Click *Provide details* and provide the required details in the *Quota details* window.
.. In the SUPPORT METHOD and CONTACT INFO sections, provide the issue severity
and your contact details.

. Click *Next: Review + create* and then click *Create*.

:leveloffset!:

:leveloffset: +1

// Module included in the following assemblies:
//
// * installing/installing_azure/installing-azure-account.adoc

:_mod-docs-content-type: PROCEDURE
[id="installation-azure-subscription-tenant-id_{context}"]
= Recording the subscription and tenant IDs

The installation program requires the subscription and tenant IDs that are associated with your Azure account. You can use the Azure CLI to gather this information.

.Prerequisites

* You have installed or updated the link:https://docs.microsoft.com/en-us/cli/azure/install-azure-cli-yum?view=azure-cli-latest[Azure CLI].

.Procedure

. Log in to the Azure CLI by running the following command:
+
[source,terminal]
----
$ az login
----

. Ensure that you are using the right subscription:

.. View a list of available subscriptions by running the following command:
+
[source,terminal]
----
$ az account list --refresh
----
+
.Example output
[source,terminal]
----
[
  {
    "cloudName": "AzureCloud",
    "id": "8xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "isDefault": true,
    "name": "Subscription Name 1",
    "state": "Enabled",
    "tenantId": "6xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "user": {
      "name": "you@example.com",
      "type": "user"
    }
  },
  {
    "cloudName": "AzureCloud",
    "id": "9xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "isDefault": false,
    "name": "Subscription Name 2",
    "state": "Enabled",
    "tenantId": "7xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
    "user": {
      "name": "you2@example.com",
      "type": "user"
    }
  }
]
----

.. View the details of the active account, and confirm that this is the subscription you want to use, by running the following command:
+
[source,terminal]
----
$ az account show
----
+
.Example output
[source,terminal]
----
{
  "environmentName": "AzureCloud",
  "id": "8xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "isDefault": true,
  "name": "Subscription Name 1",
  "state": "Enabled",
  "tenantId": "6xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "user": {
    "name": "you@example.com",
    "type": "user"
  }
}
----

. If you are not using the right subscription:

.. Change the active subscription by running the following command:
+
[source,terminal]
----
$ az account set -s <subscription_id>
----

.. Verify that you are using the subscription you need by running the following command:
+
[source,terminal]
----
$ az account show
----
+
.Example output
[source,terminal]
----
{
  "environmentName": "AzureCloud",
  "id": "9xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "isDefault": true,
  "name": "Subscription Name 2",
  "state": "Enabled",
  "tenantId": "7xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "user": {
    "name": "you2@example.com",
    "type": "user"
  }
}
----

. Record the `id` and `tenantId` parameter values from the output. You require these values to install an {product-title} cluster.

:leveloffset!:

:leveloffset: +1

// Module included in the following assemblies:
//
// * installing/installing_azure/installing-azure-account.adoc

:_mod-docs-content-type: CONCEPT
[id="installation-azure-identities_{context}"]
= Supported identities to access Azure resources

An {product-title} cluster requires an Azure identity to create and manage Azure resources. As such, you need one of the following types of identities to complete the installation:

* A service principal
* A system-assigned managed identity
* A user-assigned managed identity

:leveloffset!:

:leveloffset: +2

// Module included in the following assemblies:
//
// * installing/installing_azure/installing-azure-account.adoc
// * installing/installing_azure/installing-azure-user-infra.adoc
// * installing/installing_azure/installing-restricted-networks-azure-user-provisioned.adoc

[id="installation-azure-permissions_{context}"]
= Required Azure roles

An {product-title} cluster requires an Azure identity to create and manage Azure resources. Before you create the identity, verify that your environment meets the following requirements:

* The Azure account that you use to create the identity is assigned the `User Access Administrator` and `Contributor` roles. These roles are required when:
** Creating a service principal or user-assigned managed identity.
** Enabling a system-assigned managed identity on a virtual machine.
* If you are going to use a service principal to complete the installation, verify that the Azure account that you use to create the identity is assigned the `microsoft.directory/servicePrincipals/createAsOwner` permission in Azure Active Directory.

To set roles on the Azure portal, see the link:https://docs.microsoft.com/en-us/azure/role-based-access-control/role-assignments-portal[Manage access to Azure resources using RBAC and the Azure portal] in the Azure documentation.

:leveloffset!:
:leveloffset: +2

// Module included in the following assemblies:
//
// * installing/installing_azure/installing-azure-account.adoc

:_mod-docs-content-type: CONCEPT
[id="minimum-required-permissions-ipi-azure_{context}"]
= Required Azure permissions for installer-provisioned infrastructure

The installation program requires access to an Azure service principal or managed identity with the necessary permissions to deploy the cluster and to maintain its daily operation. These permissions must be granted to the Azure subscription that is associated with the identity.

The following options are available to you:

* You can assign the identity the `Contributor` and `User Access Administrator` roles. Assigning these roles is the quickest way to grant all of the required permissions.
+
For more information about assigning roles, see the Azure documentation for link:https://docs.microsoft.com/en-us/azure/role-based-access-control/role-assignments-portal[managing access to Azure resources using the Azure portal].
* If your organization's security policies require a more restrictive set of permissions, you can create a link:https://learn.microsoft.com/en-us/azure/role-based-access-control/custom-roles[custom role] with the necessary permissions.

The following permissions are required for creating an {product-title} cluster on Microsoft Azure.

.Required permissions for creating authorization resources
[%collapsible]
====
* `Microsoft.Authorization/policies/audit/action`
* `Microsoft.Authorization/policies/auditIfNotExists/action`
* `Microsoft.Authorization/roleAssignments/read`
* `Microsoft.Authorization/roleAssignments/write`
====

.Required permissions for creating compute resources
[%collapsible]
====
* `Microsoft.Compute/availabilitySets/write`
* `Microsoft.Compute/availabilitySets/read`
* `Microsoft.Compute/disks/beginGetAccess/action`
* `Microsoft.Compute/disks/delete`
* `Microsoft.Compute/disks/read`
* `Microsoft.Compute/disks/write`
* `Microsoft.Compute/galleries/images/read`
* `Microsoft.Compute/galleries/images/versions/read`
* `Microsoft.Compute/galleries/images/versions/write`
* `Microsoft.Compute/galleries/images/write`
* `Microsoft.Compute/galleries/read`
* `Microsoft.Compute/galleries/write`
* `Microsoft.Compute/snapshots/read`
* `Microsoft.Compute/snapshots/write`
* `Microsoft.Compute/snapshots/delete`
* `Microsoft.Compute/virtualMachines/delete`
* `Microsoft.Compute/virtualMachines/powerOff/action`
* `Microsoft.Compute/virtualMachines/read`
* `Microsoft.Compute/virtualMachines/write`
====

.Required permissions for creating identity management resources
[%collapsible]
====
* `Microsoft.ManagedIdentity/userAssignedIdentities/assign/action`
* `Microsoft.ManagedIdentity/userAssignedIdentities/read`
* `Microsoft.ManagedIdentity/userAssignedIdentities/write`
====

.Required permissions for creating network resources
[%collapsible]
====
* `Microsoft.Network/dnsZones/A/write`
* `Microsoft.Network/dnsZones/CNAME/write`
* `Microsoft.Network/dnszones/CNAME/read`
* `Microsoft.Network/dnszones/read`
* `Microsoft.Network/loadBalancers/backendAddressPools/join/action`
* `Microsoft.Network/loadBalancers/backendAddressPools/read`
* `Microsoft.Network/loadBalancers/backendAddressPools/write`
* `Microsoft.Network/loadBalancers/read`
* `Microsoft.Network/loadBalancers/write`
* `Microsoft.Network/networkInterfaces/delete`
* `Microsoft.Network/networkInterfaces/join/action`
* `Microsoft.Network/networkInterfaces/read`
* `Microsoft.Network/networkInterfaces/write`
* `Microsoft.Network/networkSecurityGroups/join/action`
* `Microsoft.Network/networkSecurityGroups/read`
* `Microsoft.Network/networkSecurityGroups/securityRules/delete`
* `Microsoft.Network/networkSecurityGroups/securityRules/read`
* `Microsoft.Network/networkSecurityGroups/securityRules/write`
* `Microsoft.Network/networkSecurityGroups/write`
* `Microsoft.Network/privateDnsZones/A/read`
* `Microsoft.Network/privateDnsZones/A/write`
* `Microsoft.Network/privateDnsZones/A/delete`
* `Microsoft.Network/privateDnsZones/SOA/read`
* `Microsoft.Network/privateDnsZones/read`
* `Microsoft.Network/privateDnsZones/virtualNetworkLinks/read`
* `Microsoft.Network/privateDnsZones/virtualNetworkLinks/write`
* `Microsoft.Network/privateDnsZones/write`
* `Microsoft.Network/publicIPAddresses/delete`
* `Microsoft.Network/publicIPAddresses/join/action`
* `Microsoft.Network/publicIPAddresses/read`
* `Microsoft.Network/publicIPAddresses/write`
* `Microsoft.Network/virtualNetworks/join/action`
* `Microsoft.Network/virtualNetworks/read`
* `Microsoft.Network/virtualNetworks/subnets/join/action`
* `Microsoft.Network/virtualNetworks/subnets/read`
* `Microsoft.Network/virtualNetworks/subnets/write`
* `Microsoft.Network/virtualNetworks/write`
====
[NOTE]
====
The following permissions are not required to create the private {product-title} cluster on Azure.

* `Microsoft.Network/dnsZones/A/write`
* `Microsoft.Network/dnsZones/CNAME/write`
* `Microsoft.Network/dnszones/CNAME/read`
* `Microsoft.Network/dnszones/read`
====

.Required permissions for checking the health of resources
[%collapsible]
====
* `Microsoft.Resourcehealth/healthevent/Activated/action`
* `Microsoft.Resourcehealth/healthevent/InProgress/action`
* `Microsoft.Resourcehealth/healthevent/Pending/action`
* `Microsoft.Resourcehealth/healthevent/Resolved/action`
* `Microsoft.Resourcehealth/healthevent/Updated/action`
====

.Required permissions for creating a resource group
[%collapsible]
====
* `Microsoft.Resources/subscriptions/resourceGroups/read`
* `Microsoft.Resources/subscriptions/resourcegroups/write`
====

.Required permissions for creating resource tags
[%collapsible]
====
* `Microsoft.Resources/tags/write`
====

.Required permissions for creating storage resources
[%collapsible]
====
* `Microsoft.Storage/storageAccounts/blobServices/read`
* `Microsoft.Storage/storageAccounts/blobServices/containers/write`
* `Microsoft.Storage/storageAccounts/fileServices/read`
* `Microsoft.Storage/storageAccounts/fileServices/shares/read`
* `Microsoft.Storage/storageAccounts/fileServices/shares/write`
* `Microsoft.Storage/storageAccounts/fileServices/shares/delete`
* `Microsoft.Storage/storageAccounts/listKeys/action`
* `Microsoft.Storage/storageAccounts/read`
* `Microsoft.Storage/storageAccounts/write`
====

.Optional permissions for creating marketplace virtual machine resources
[%collapsible]
====
* `Microsoft.MarketplaceOrdering/offertypes/publishers/offers/plans/agreements/read`
* `Microsoft.MarketplaceOrdering/offertypes/publishers/offers/plans/agreements/write`
====

.Optional permissions for creating compute resources
[%collapsible]
====
* `Microsoft.Compute/images/read`
* `Microsoft.Compute/images/write`
* `Microsoft.Compute/images/delete`
====

.Optional permissions for enabling user-managed encryption
[%collapsible]
====
* `Microsoft.Compute/diskEncryptionSets/read`
* `Microsoft.Compute/diskEncryptionSets/write`
* `Microsoft.Compute/diskEncryptionSets/delete`
* `Microsoft.KeyVault/vaults/read`
* `Microsoft.KeyVault/vaults/write`
* `Microsoft.KeyVault/vaults/delete`
* `Microsoft.KeyVault/vaults/deploy/action`
* `Microsoft.KeyVault/vaults/keys/read`
* `Microsoft.KeyVault/vaults/keys/write`
* `Microsoft.Features/providers/features/register/action`
====

.Optional permissions for installing a cluster using the `NatGateway` outbound type
[%collapsible]
====
* `Microsoft.Network/natGateways/read`
* `Microsoft.Network/natGateways/write`
====

.Optional permissions for installing a private cluster with Azure Network Address Translation (NAT)
[%collapsible]
====
* `Microsoft.Network/natGateways/join/action`
* `Microsoft.Network/natGateways/read`
* `Microsoft.Network/natGateways/write`
====

.Optional permissions for installing a private cluster with Azure firewall
[%collapsible]
====
* `Microsoft.Network/azureFirewalls/applicationRuleCollections/write`
* `Microsoft.Network/azureFirewalls/read`
* `Microsoft.Network/azureFirewalls/write`
* `Microsoft.Network/routeTables/join/action`
* `Microsoft.Network/routeTables/read`
* `Microsoft.Network/routeTables/routes/read`
* `Microsoft.Network/routeTables/routes/write`
* `Microsoft.Network/routeTables/write`
* `Microsoft.Network/virtualNetworks/peer/action`
* `Microsoft.Network/virtualNetworks/virtualNetworkPeerings/read`
* `Microsoft.Network/virtualNetworks/virtualNetworkPeerings/write`
====

.Optional permission for running gather bootstrap
[%collapsible]
====
* `Microsoft.Compute/virtualMachines/instanceView/read`
====

The following permissions are required for deleting an {product-title} cluster on Microsoft Azure. You can use the same permissions to delete a private {product-title} cluster on Azure.

.Required permissions for deleting authorization resources
[%collapsible]
====
* `Microsoft.Authorization/roleAssignments/delete`
====

.Required permissions for deleting compute resources
[%collapsible]
====
* `Microsoft.Compute/disks/delete`
* `Microsoft.Compute/galleries/delete`
* `Microsoft.Compute/galleries/images/delete`
* `Microsoft.Compute/galleries/images/versions/delete`
* `Microsoft.Compute/virtualMachines/delete`
====

.Required permissions for deleting identity management resources
[%collapsible]
====
* `Microsoft.ManagedIdentity/userAssignedIdentities/delete`
====

.Required permissions for deleting network resources
[%collapsible]
====
* `Microsoft.Network/dnszones/read`
* `Microsoft.Network/dnsZones/A/read`
* `Microsoft.Network/dnsZones/A/delete`
* `Microsoft.Network/dnsZones/CNAME/read`
* `Microsoft.Network/dnsZones/CNAME/delete`
* `Microsoft.Network/loadBalancers/delete`
* `Microsoft.Network/networkInterfaces/delete`
* `Microsoft.Network/networkSecurityGroups/delete`
* `Microsoft.Network/privateDnsZones/read`
* `Microsoft.Network/privateDnsZones/A/read`
* `Microsoft.Network/privateDnsZones/delete`
* `Microsoft.Network/privateDnsZones/virtualNetworkLinks/delete`
* `Microsoft.Network/publicIPAddresses/delete`
* `Microsoft.Network/virtualNetworks/delete`
====
[NOTE]
====
The following permissions are not required to delete a private {product-title} cluster on Azure.

* `Microsoft.Network/dnszones/read`
* `Microsoft.Network/dnsZones/A/read`
* `Microsoft.Network/dnsZones/A/delete`
* `Microsoft.Network/dnsZones/CNAME/read`
* `Microsoft.Network/dnsZones/CNAME/delete`
====

.Required permissions for checking the health of resources
[%collapsible]
====
* `Microsoft.Resourcehealth/healthevent/Activated/action`
* `Microsoft.Resourcehealth/healthevent/Resolved/action`
* `Microsoft.Resourcehealth/healthevent/Updated/action`
====

.Required permissions for deleting a resource group
[%collapsible]
====
* `Microsoft.Resources/subscriptions/resourcegroups/delete`
====

.Required permissions for deleting storage resources
[%collapsible]
====
* `Microsoft.Storage/storageAccounts/delete`
* `Microsoft.Storage/storageAccounts/listKeys/action`
====

[NOTE]
====
To install {product-title} on Azure, you must scope the permissions to your subscription. Later, you can re-scope these permissions to the installer created resource group. If the public DNS zone is present in a different resource group, then the network DNS zone related permissions must always be applied to your subscription. By default, the {product-title} installation program assigns the Azure identity the `Contributor` role.

You can scope all the permissions to your subscription when deleting an {product-title} cluster.
====

:leveloffset!:
:leveloffset: +2

// Module included in the following assemblies:
//
// * installing/installing_azure/installing-azure-account.adoc

:_mod-docs-content-type: PROCEDURE
[id="installation-using-azure-managed-identities_{context}"]
= Using Azure managed identities

The installation program requires an Azure identity to complete the installation. You can use either a system-assigned or user-assigned managed identity.

If you are unable to use a managed identity, you can use a service principal.

.Procedure

. If you are using a system-assigned managed identity, enable it on the virtual machine that you will run the installation program from.
. If you are using a user-assigned managed identity:
.. Assign it to the virtual machine that you will run the installation program from.
.. Record its client ID. You require this value when installing the cluster.
+
For more information about viewing the details of a user-assigned managed identity, see the Microsoft Azure documentation for link:https:https://learn.microsoft.com/en-us/azure/active-directory/managed-identities-azure-resources/how-manage-user-assigned-managed-identities?pivots=identity-mi-methods-azp#list-user-assigned-managed-identities[listing user-assigned managed identities].
. Verify that the required permissions are assigned to the managed identity.

:leveloffset!:
:leveloffset: +2

// Module included in the following assemblies:
//
// * installing/installing_azure/installing-azure-account.adoc

:_mod-docs-content-type: PROCEDURE
[id="installation-creating-azure-service-principal_{context}"]
= Creating a service principal

The installation program requires an Azure identity to complete the installation. You can use a service principal.

If you are unable to use a service principal, you can use a managed identity.

.Prerequisites

* You have installed or updated the link:https://docs.microsoft.com/en-us/cli/azure/install-azure-cli-yum?view=azure-cli-latest[Azure CLI].
* You have an Azure subscription ID.
* If you are not going to assign the `Contributor` and `User Administrator Access` roles to the service principal, you have created a custom role with the required Azure permissions.

.Procedure

. Create the service principal for your account by running the following command:
+
[source,terminal]
----
$ az ad sp create-for-rbac --role <role_name> \// <1>
     --name <service_principal> \// <2>
     --scopes /subscriptions/<subscription_id> <3>
----
<1> Defines the role name. You can use the `Contributor` role, or you can specify a custom role which contains the necessary permissions.
<2> Defines the service principal name.
<3> Specifies the subscription ID.
+
.Example output
[source,terminal]
----
Creating 'Contributor' role assignment under scope '/subscriptions/<subscription_id>'
The output includes credentials that you must protect. Be sure that you do not
include these credentials in your code or check the credentials into your source
control. For more information, see https://aka.ms/azadsp-cli
{
  "appId": "axxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "displayName": <service_principal>",
  "password": "00000000-0000-0000-0000-000000000000",
  "tenantId": "8xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}
----

. Record the values of the `appId` and `password` parameters from the output. You require these values when installing the cluster.

. If you applied the `Contributor` role to your service principal, assign the `User Administrator Access` role by running the following command:
+
[source,terminal]
----
$ az role assignment create --role "User Access Administrator" \
  --assignee-object-id $(az ad sp show --id <appId> --query id -o tsv) <1>
----
<1> Specify the `appId` parameter value for your service principal.

:leveloffset!:

[role="_additional-resources"]
.Additional resources

* xref:../../authentication/managing_cloud_provider_credentials/about-cloud-credential-operator.adoc#about-cloud-credential-operator-modes[About the Cloud Credential Operator]

:leveloffset: +1

// Module included in the following assemblies:
//
// * installing/installing_aws/installing-azure-account.adoc

:_mod-docs-content-type: CONCEPT
[id="installation-azure-marketplace_{context}"]
= Supported Azure Marketplace regions

Installing a cluster using the Azure Marketplace image is available to customers who purchase the offer in North America and EMEA.

While the offer must be purchased in North America or EMEA, you can deploy the cluster to any of the Azure public partitions that {product-title} supports.

[NOTE]
====
Deploying a cluster using the Azure Marketplace image is not supported for the Azure Government regions.
====

:leveloffset!:

:leveloffset: +1


// Module included in the following assemblies:
//
// * installing/installing_azure/installing-azure-account.adoc
// * installing/installing_azure/installing-azure-user-infra.adoc
// * installing/installing_azure_stack_hub/installing-azure-stack-hub-user-infra.adoc
// * installing/installing_azure/installing-restricted-networks-azure-user-provisioned.adoc

[id="installation-azure-regions_{context}"]
= Supported Azure regions

The installation program dynamically generates the list of available Microsoft Azure regions based on your subscription.

[discrete]
== Supported Azure public regions

* `australiacentral` (Australia Central)
* `australiaeast` (Australia East)
* `australiasoutheast` (Australia South East)
* `brazilsouth` (Brazil South)
* `canadacentral` (Canada Central)
* `canadaeast` (Canada East)
* `centralindia` (Central India)
* `centralus` (Central US)
* `eastasia` (East Asia)
* `eastus` (East US)
* `eastus2` (East US 2)
* `francecentral` (France Central)
//* francesouth (France South)
* `germanywestcentral` (Germany West Central)
* `israelcentral` (Israel Central)
* `italynorth` (Italy North)
* `japaneast` (Japan East)
* `japanwest` (Japan West)
* `koreacentral` (Korea Central)
* `koreasouth` (Korea South)
* `northcentralus` (North Central US)
* `northeurope` (North Europe)
* `norwayeast` (Norway East)
* `qatarcentral` (Qatar Central)
* `southafricanorth` (South Africa North)
//* southafricawest (South Africa West)
* `southcentralus` (South Central US)
* `southeastasia` (Southeast Asia)
* `southindia` (South India)
* `swedencentral` (Sweden Central)
* `switzerlandnorth` (Switzerland North)
//* uaecentral (UAE Central)
* `uaenorth` (UAE North)
* `uksouth` (UK South)
* `ukwest` (UK West)
* `westcentralus` (West Central US)
* `westeurope` (West Europe)
* `westindia` (West India)
* `westus` (West US)
* `westus2` (West US 2)
* `westus3` (West US 3)

[discrete]
== Supported Azure Government regions

Support for the following Microsoft Azure Government (MAG) regions was added in {product-title} version 4.6:

* `usgovtexas` (US Gov Texas)
* `usgovvirginia` (US Gov Virginia)
//* usdodcentral (US DoD Central)
//* usdodeast (US DoD East)
//* usgovarizona (US Gov Arizona)
//* usgoviowa (US Gov Iowa)

You can reference all available MAG regions in the link:https://azure.microsoft.com/en-us/global-infrastructure/geographies/#geographies[Azure documentation]. Other provided MAG regions are expected to work with {product-title}, but have not been tested.

:leveloffset!:

== Next steps

* Install an {product-title} cluster on Azure. You can
xref:../../installing/installing_azure/installing-azure-customizations.adoc#installing-azure-customizations[install a customized cluster]
or
xref:../../installing/installing_azure/installing-azure-default.adoc#installing-azure-default[quickly install a cluster] with default options.

//# includes=_attributes/common-attributes,modules/installation-azure-limits,modules/installation-azure-network-config,modules/installation-azure-increasing-limits,modules/installation-azure-subscription-tenant-id,modules/installation-azure-identities,modules/installation-azure-permissions,modules/minimum-required-permissions-ipi-azure,modules/installation-using-azure-managed-identities,modules/installation-creating-azure-service-principal,modules/installation-azure-marketplace,modules/installation-azure-regions
