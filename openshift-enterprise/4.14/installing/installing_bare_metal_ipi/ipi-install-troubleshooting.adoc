:_mod-docs-content-type: ASSEMBLY
[id="ipi-install-troubleshooting"]
= Troubleshooting
// The {product-title} attribute provides the context-sensitive name of the relevant OpenShift distribution, for example, "OpenShift Container Platform" or "OKD". The {product-version} attribute provides the product version relative to the distribution, for example "4.9".
// {product-title} and {product-version} are parsed when AsciiBinder queries the _distro_map.yml file in relation to the base branch of a pull request.
// See https://github.com/openshift/openshift-docs/blob/main/contributing_to_docs/doc_guidelines.adoc#product-name-and-version for more information on this topic.
// Other common attributes are defined in the following lines:
:data-uri:
:icons:
:experimental:
:toc: macro
:toc-title:
:imagesdir: images
:prewrap!:
:op-system-first: Red Hat Enterprise Linux CoreOS (RHCOS)
:op-system: RHCOS
:op-system-lowercase: rhcos
:op-system-base: RHEL
:op-system-base-full: Red Hat Enterprise Linux (RHEL)
:op-system-version: 8.x
:tsb-name: Template Service Broker
:kebab: image:kebab.png[title="Options menu"]
:rh-openstack-first: Red Hat OpenStack Platform (RHOSP)
:rh-openstack: RHOSP
:ai-full: Assisted Installer
:ai-version: 2.3
:cluster-manager-first: Red Hat OpenShift Cluster Manager
:cluster-manager: OpenShift Cluster Manager
:cluster-manager-url: link:https://console.redhat.com/openshift[OpenShift Cluster Manager Hybrid Cloud Console]
:cluster-manager-url-pull: link:https://console.redhat.com/openshift/install/pull-secret[pull secret from the Red Hat OpenShift Cluster Manager]
:insights-advisor-url: link:https://console.redhat.com/openshift/insights/advisor/[Insights Advisor]
:hybrid-console: Red Hat Hybrid Cloud Console
:hybrid-console-second: Hybrid Cloud Console
:oadp-first: OpenShift API for Data Protection (OADP)
:oadp-full: OpenShift API for Data Protection
:oc-first: pass:quotes[OpenShift CLI (`oc`)]
:product-registry: OpenShift image registry
:rh-storage-first: Red Hat OpenShift Data Foundation
:rh-storage: OpenShift Data Foundation
:rh-rhacm-first: Red Hat Advanced Cluster Management (RHACM)
:rh-rhacm: RHACM
:rh-rhacm-version: 2.8
:sandboxed-containers-first: OpenShift sandboxed containers
:sandboxed-containers-operator: OpenShift sandboxed containers Operator
:sandboxed-containers-version: 1.3
:sandboxed-containers-version-z: 1.3.3
:sandboxed-containers-legacy-version: 1.3.2
:cert-manager-operator: cert-manager Operator for Red Hat OpenShift
:secondary-scheduler-operator-full: Secondary Scheduler Operator for Red Hat OpenShift
:secondary-scheduler-operator: Secondary Scheduler Operator
// Backup and restore
:velero-domain: velero.io
:velero-version: 1.11
:launch: image:app-launcher.png[title="Application Launcher"]
:mtc-short: MTC
:mtc-full: Migration Toolkit for Containers
:mtc-version: 1.8
:mtc-version-z: 1.8.0
// builds (Valid only in 4.11 and later)
:builds-v2title: Builds for Red Hat OpenShift
:builds-v2shortname: OpenShift Builds v2
:builds-v1shortname: OpenShift Builds v1
//gitops
:gitops-title: Red Hat OpenShift GitOps
:gitops-shortname: GitOps
:gitops-ver: 1.1
:rh-app-icon: image:red-hat-applications-menu-icon.jpg[title="Red Hat applications"]
//pipelines
:pipelines-title: Red Hat OpenShift Pipelines
:pipelines-shortname: OpenShift Pipelines
:pipelines-ver: pipelines-1.12
:pipelines-version-number: 1.12
:tekton-chains: Tekton Chains
:tekton-hub: Tekton Hub
:artifact-hub: Artifact Hub
:pac: Pipelines as Code
//odo
:odo-title: odo
//OpenShift Kubernetes Engine
:oke: OpenShift Kubernetes Engine
//OpenShift Platform Plus
:opp: OpenShift Platform Plus
//openshift virtualization (cnv)
:VirtProductName: OpenShift Virtualization
:VirtVersion: 4.14
:KubeVirtVersion: v0.59.0
:HCOVersion: 4.14.0
:CNVNamespace: openshift-cnv
:CNVOperatorDisplayName: OpenShift Virtualization Operator
:CNVSubscriptionSpecSource: redhat-operators
:CNVSubscriptionSpecName: kubevirt-hyperconverged
:delete: image:delete.png[title="Delete"]
//distributed tracing
:DTProductName: Red Hat OpenShift distributed tracing platform
:DTShortName: distributed tracing platform
:DTProductVersion: 2.9
:JaegerName: Red Hat OpenShift distributed tracing platform (Jaeger)
:JaegerShortName: distributed tracing platform (Jaeger)
:JaegerVersion: 1.47.0
:OTELName: Red Hat OpenShift distributed tracing data collection
:OTELShortName: distributed tracing data collection
:OTELOperator: Red Hat OpenShift distributed tracing data collection Operator
:OTELVersion: 0.81.0
:TempoName: Red Hat OpenShift distributed tracing platform (Tempo)
:TempoShortName: distributed tracing platform (Tempo)
:TempoOperator: Tempo Operator
:TempoVersion: 2.1.1
//logging
:logging-title: logging subsystem for Red Hat OpenShift
:logging-title-uc: Logging subsystem for Red Hat OpenShift
:logging: logging subsystem
:logging-uc: Logging subsystem
//serverless
:ServerlessProductName: OpenShift Serverless
:ServerlessProductShortName: Serverless
:ServerlessOperatorName: OpenShift Serverless Operator
:FunctionsProductName: OpenShift Serverless Functions
//service mesh v2
:product-dedicated: Red Hat OpenShift Dedicated
:product-rosa: Red Hat OpenShift Service on AWS
:SMProductName: Red Hat OpenShift Service Mesh
:SMProductShortName: Service Mesh
:SMProductVersion: 2.4.4
:MaistraVersion: 2.4
//Service Mesh v1
:SMProductVersion1x: 1.1.18.2
//Windows containers
:productwinc: Red Hat OpenShift support for Windows Containers
// Red Hat Quay Container Security Operator
:rhq-cso: Red Hat Quay Container Security Operator
// Red Hat Quay
:quay: Red Hat Quay
:sno: single-node OpenShift
:sno-caps: Single-node OpenShift
//TALO and Redfish events Operators
:cgu-operator-first: Topology Aware Lifecycle Manager (TALM)
:cgu-operator-full: Topology Aware Lifecycle Manager
:cgu-operator: TALM
:redfish-operator: Bare Metal Event Relay
//Formerly known as CodeReady Containers and CodeReady Workspaces
:openshift-local-productname: Red Hat OpenShift Local
:openshift-dev-spaces-productname: Red Hat OpenShift Dev Spaces
// Factory-precaching-cli tool
:factory-prestaging-tool: factory-precaching-cli tool
:factory-prestaging-tool-caps: Factory-precaching-cli tool
:openshift-networking: Red Hat OpenShift Networking
// TODO - this probably needs to be different for OKD
//ifdef::openshift-origin[]
//:openshift-networking: OKD Networking
//endif::[]
// logical volume manager storage
:lvms-first: Logical volume manager storage (LVM Storage)
:lvms: LVM Storage
//Operator SDK version
:osdk_ver: 1.31.0
//Operator SDK version that shipped with the previous OCP 4.x release
:osdk_ver_n1: 1.28.0
//Next-gen (OCP 4.14+) Operator Lifecycle Manager, aka "v1"
:olmv1: OLM 1.0
:olmv1-first: Operator Lifecycle Manager (OLM) 1.0
:ztp-first: GitOps Zero Touch Provisioning (ZTP)
:ztp: GitOps ZTP
:3no: three-node OpenShift
:3no-caps: Three-node OpenShift
:run-once-operator: Run Once Duration Override Operator
// Web terminal
:web-terminal-op: Web Terminal Operator
:devworkspace-op: DevWorkspace Operator
:secrets-store-driver: Secrets Store CSI driver
:secrets-store-operator: Secrets Store CSI Driver Operator
//AWS STS
:sts-first: Security Token Service (STS)
:sts-full: Security Token Service
:sts-short: STS
//Cloud provider names
//AWS
:aws-first: Amazon Web Services (AWS)
:aws-full: Amazon Web Services
:aws-short: AWS
//GCP
:gcp-first: Google Cloud Platform (GCP)
:gcp-full: Google Cloud Platform
:gcp-short: GCP
//alibaba cloud
:alibaba: Alibaba Cloud
// IBM Cloud VPC
:ibmcloudVPCProductName: IBM Cloud VPC
:ibmcloudVPCRegProductName: IBM(R) Cloud VPC
// IBM Cloud
:ibm-cloud-bm: IBM Cloud Bare Metal (Classic)
:ibm-cloud-bm-reg: IBM Cloud(R) Bare Metal (Classic)
// IBM Power
:ibmpowerProductName: IBM Power
:ibmpowerRegProductName: IBM(R) Power
// IBM zSystems
:ibmzProductName: IBM Z
:ibmzRegProductName: IBM(R) Z
:linuxoneProductName: IBM(R) LinuxONE
//Azure
:azure-full: Microsoft Azure
:azure-short: Azure
//vSphere
:vmw-full: VMware vSphere
:vmw-short: vSphere
//Oracle
:oci-first: Oracle(R) Cloud Infrastructure
:oci: OCI
:ocvs-first: Oracle(R) Cloud VMware Solution (OCVS)
:ocvs: OCVS
:context: ipi-install-troubleshooting

toc::[]


== Troubleshooting the installer workflow

Prior to troubleshooting the installation environment, it is critical to understand the overall flow of the installer-provisioned installation on bare metal. The diagrams below provide a troubleshooting flow with a step-by-step breakdown for the environment.

image:flow1.png[Flow-Diagram-1]

_Workflow 1 of 4_ illustrates a troubleshooting workflow when the `install-config.yaml` file has errors or the {op-system-first} images are inaccessible.  Troubleshooting suggestions can be found at xref:ipi-install-troubleshooting-install-config_{context}[Troubleshooting `install-config.yaml`].

image:flow2.png[Flow-Diagram-2]

_Workflow 2 of 4_ illustrates a troubleshooting workflow for xref:ipi-install-troubleshooting-bootstrap-vm_{context}[ bootstrap VM issues], xref:ipi-install-troubleshooting-bootstrap-vm-cannot-boot_{context}[ bootstrap VMs that cannot boot up the cluster nodes], and  xref:ipi-install-troubleshooting-bootstrap-vm-inspecting-logs_{context}[ inspecting logs]. When installing an {product-title} cluster without the `provisioning` network, this workflow does not apply.

image:flow3.png[Flow-Diagram-3]

_Workflow 3 of 4_ illustrates a troubleshooting workflow for xref:ipi-install-troubleshooting-cluster-nodes-will-not-pxe_{context}[ cluster nodes that will not PXE boot]. If installing using RedFish Virtual Media, each node must meet minimum firmware requirements for the installer to deploy the node. See *Firmware requirements for installing with virtual media* in the *Prerequisites* section for additional details.

image:flow4.png[Flow-Diagram-4]

_Workflow 4 of 4_ illustrates a troubleshooting workflow from
xref:ipi-install-troubleshooting-api-not-accessible_{context}[ a non-accessible API] to a xref:ipi-install-troubleshooting-reviewing-the-installation_{context}[validated installation].


:leveloffset: +1

// Module included in the following assemblies:
// //installing/installing_bare_metal_ipi/installing_bare_metal_ipi/ipi-install-troubleshooting.adoc

:_mod-docs-content-type: PROCEDURE
[id="ipi-install-troubleshooting-install-config_{context}"]

= Troubleshooting `install-config.yaml`

The `install-config.yaml` configuration file represents all of the nodes that are part of the {product-title} cluster. The file contains the necessary options consisting of but not limited to `apiVersion`, `baseDomain`, `imageContentSources` and virtual IP addresses. If errors occur early in the deployment of the {product-title} cluster, the errors are likely in the `install-config.yaml` configuration file.

.Procedure

. Use the guidelines in link:https://www.redhat.com/sysadmin/yaml-tips[YAML-tips].
. Verify the YAML syntax is correct using link:http://www.yamllint.com/[syntax-check].
. Verify the {op-system-first} QEMU images are properly defined and accessible via the URL provided in the `install-config.yaml`. For example:
+
[source,terminal]
----
$ curl -s -o /dev/null -I -w "%{http_code}\n" http://webserver.example.com:8080/rhcos-44.81.202004250133-0-qemu.<architecture>.qcow2.gz?sha256=7d884b46ee54fe87bbc3893bf2aa99af3b2d31f2e19ab5529c60636fbd0f1ce7
----
+
If the output is `200`, there is a valid response from the webserver storing the bootstrap VM image.

:leveloffset!:
:leveloffset: +1

// Module included in the following assemblies:
// //installing/installing_bare_metal_ipi/installing_bare_metal_ipi/ipi-install-troubleshooting.adoc

:_mod-docs-content-type: PROCEDURE
[id="ipi-install-troubleshooting-bootstrap-vm_{context}"]

= Bootstrap VM issues

The {product-title} installation program spawns a bootstrap node virtual machine, which handles provisioning the {product-title} cluster nodes.

.Procedure

. About 10 to 15 minutes after triggering the installation program, check to ensure the bootstrap VM is operational using the `virsh` command:
+
[source,terminal]
----
$ sudo virsh list
----
+
[source,terminal]
----
 Id    Name                           State
 --------------------------------------------
 12    openshift-xf6fq-bootstrap      running
----
+
[NOTE]
====
The name of the bootstrap VM is always the cluster name followed by a random set of characters and ending in the word "bootstrap."
====
+
If the bootstrap VM is not running after 10-15 minutes, troubleshoot why it is not running. Possible issues include:

. Verify `libvirtd` is running on the system:
+
[source,terminal]
----
$ systemctl status libvirtd
----
+
[source,terminal]
----
● libvirtd.service - Virtualization daemon
   Loaded: loaded (/usr/lib/systemd/system/libvirtd.service; enabled; vendor preset: enabled)
   Active: active (running) since Tue 2020-03-03 21:21:07 UTC; 3 weeks 5 days ago
     Docs: man:libvirtd(8)
           https://libvirt.org
 Main PID: 9850 (libvirtd)
    Tasks: 20 (limit: 32768)
   Memory: 74.8M
   CGroup: /system.slice/libvirtd.service
           ├─ 9850 /usr/sbin/libvirtd
----
+
If the bootstrap VM is operational, log in to it.

. Use the `virsh console` command to find the IP address of the bootstrap VM:
+
[source,terminal]
----
$ sudo virsh console example.com
----
+
[source,terminal]
----
Connected to domain example.com
Escape character is ^]
Red Hat Enterprise Linux CoreOS 43.81.202001142154.0 (Ootpa) 4.3
SSH host key: SHA256:BRWJktXZgQQRY5zjuAV0IKZ4WM7i4TiUyMVanqu9Pqg (ED25519)
SSH host key: SHA256:7+iKGA7VtG5szmk2jB5gl/5EZ+SNcJ3a2g23o0lnIio (ECDSA)
SSH host key: SHA256:DH5VWhvhvagOTaLsYiVNse9ca+ZSW/30OOMed8rIGOc (RSA)
ens3:  fd35:919d:4042:2:c7ed:9a9f:a9ec:7
ens4: 172.22.0.2 fe80::1d05:e52e:be5d:263f
localhost login:
----
+
[IMPORTANT]
====
When deploying an {product-title} cluster without the `provisioning` network, you must use a public IP address and not a private IP address like `172.22.0.2`.
====


. After you obtain the IP address, log in to the bootstrap VM using the `ssh` command:
+
[NOTE]
====
In the console output of the previous step, you can use the IPv6 IP address provided by `ens3` or the IPv4 IP provided by `ens4`.
====
+
[source,terminal]
----
$ ssh core@172.22.0.2
----

If you are not successful logging in to the bootstrap VM, you have likely encountered one of the following scenarios:

* You cannot reach the `172.22.0.0/24` network. Verify the network connectivity between the provisioner and the `provisioning` network bridge. This issue might occur if you are using a `provisioning` network.
`
* You cannot reach the bootstrap VM through the public network. When attempting
to SSH via `baremetal` network, verify connectivity on the
`provisioner` host specifically around the `baremetal` network bridge.

* You encountered `Permission denied (publickey,password,keyboard-interactive)`. When
attempting to access the bootstrap VM, a `Permission denied` error
might occur. Verify that the SSH key for the user attempting to log
in to the VM is set within the `install-config.yaml` file.

:leveloffset!:
:leveloffset: +2

// Module included in the following assemblies:
// //installing/installing_bare_metal_ipi/installing_bare_metal_ipi/ipi-install-troubleshooting.adoc

:_mod-docs-content-type: PROCEDURE
[id="ipi-install-troubleshooting-bootstrap-vm-cannot-boot_{context}"]
= Bootstrap VM cannot boot up the cluster nodes

During the deployment, it is possible for the bootstrap VM to fail to boot the cluster nodes, which prevents the VM from provisioning the nodes with the {op-system} image. This scenario can arise due to:

* A problem with the `install-config.yaml` file.
* Issues with out-of-band network access when using the baremetal network.

To verify the issue, there are three containers related to `ironic`:

* `ironic`
* `ironic-inspector`

.Procedure

. Log in to the bootstrap VM:
+
[source,terminal]
----
$ ssh core@172.22.0.2
----

. To check the container logs, execute the following:
+
[source,terminal]
----
[core@localhost ~]$ sudo podman logs -f <container_name>
----
+
Replace `<container_name>` with one of `ironic` or `ironic-inspector`. If you encounter an issue where the control plane nodes are not booting up from PXE, check the `ironic` pod. The `ironic` pod contains information about the attempt to boot the cluster nodes, because it attempts to log in to the node over IPMI.

.Potential reason
The cluster nodes might be in the `ON` state when deployment started.

.Solution
Power off the {product-title} cluster nodes before you begin the
installation over IPMI:

[source,terminal]
----
$ ipmitool -I lanplus -U root -P <password> -H <out_of_band_ip> power off
----

:leveloffset!:
:leveloffset: +2

// Module included in the following assemblies:
// //installing/installing_bare_metal_ipi/installing_bare_metal_ipi/ipi-install-troubleshooting.adoc

:_mod-docs-content-type: PROCEDURE
[id="ipi-install-troubleshooting-bootstrap-vm-inspecting-logs_{context}"]
= Inspecting logs

When experiencing issues downloading or accessing the {op-system} images, first verify that the URL is correct in the `install-config.yaml` configuration file.

.Example of internal webserver hosting {op-system} images
[source,yaml]
----
bootstrapOSImage: http://<ip:port>/rhcos-43.81.202001142154.0-qemu.<architecture>.qcow2.gz?sha256=9d999f55ff1d44f7ed7c106508e5deecd04dc3c06095d34d36bf1cd127837e0c
clusterOSImage: http://<ip:port>/rhcos-43.81.202001142154.0-openstack.<architecture>.qcow2.gz?sha256=a1bda656fa0892f7b936fdc6b6a6086bddaed5dafacedcd7a1e811abb78fe3b0
----

The `coreos-downloader` container downloads resources from a webserver or from the external link:https://quay.io[quay.io] registry, whichever the `install-config.yaml` configuration file specifies. Verify that the `coreos-downloader` container is up and running and inspect its logs as needed.

.Procedure

. Log in to the bootstrap VM:
+
[source,terminal]
----
$ ssh core@172.22.0.2
----

. Check the status of the `coreos-downloader` container within the bootstrap VM by running the following command:

+
[source,terminal]
----
[core@localhost ~]$ sudo podman logs -f coreos-downloader
----
+
If the bootstrap VM cannot access the URL to the images, use the `curl` command to verify that the VM can access the images.

. To inspect the `bootkube` logs that indicate if all the containers launched during the deployment phase, execute the following:
+
[source,terminal]
----
[core@localhost ~]$ journalctl -xe
----
+
[source,terminal]
----
[core@localhost ~]$ journalctl -b -f -u bootkube.service
----

. Verify all the pods, including `dnsmasq`, `mariadb`, `httpd`, and `ironic`, are running:
+
[source,terminal]
----
[core@localhost ~]$ sudo podman ps
----

. If there are issues with the pods, check the logs of the containers with issues. To check the logs of the `ironic` service, run the following command:
+
[source,terminal]
----
[core@localhost ~]$ sudo podman logs ironic
----

:leveloffset!:
:leveloffset: +1

// Module included in the following assemblies:
// //installing/installing_bare_metal_ipi/installing_bare_metal_ipi/ipi-install-troubleshooting.adoc

:_mod-docs-content-type: PROCEDURE
[id="ipi-install-troubleshooting-cluster-nodes-will-not-pxe_{context}"]

= Cluster nodes will not PXE boot

When {product-title} cluster nodes will not PXE boot, execute the following checks on the cluster nodes that will not PXE boot. This procedure does not apply when installing an {product-title} cluster without the `provisioning` network.

.Procedure

. Check the network connectivity to the `provisioning` network.

. Ensure PXE is enabled on the NIC for the `provisioning` network and PXE is disabled for all other NICs.

. Verify that the `install-config.yaml` configuration file has the proper hardware profile and boot MAC address for the NIC connected to the `provisioning` network. For example:
+
.control plane node settings
+
----
bootMACAddress: 24:6E:96:1B:96:90 # MAC of bootable provisioning NIC
hardwareProfile: default          #control plane node settings
----
+
.Worker node settings
+
----
bootMACAddress: 24:6E:96:1B:96:90 # MAC of bootable provisioning NIC
hardwareProfile: unknown          #worker node settings
----

:leveloffset!:
:leveloffset: +1

// This module is included in the following assemblies:
//
// installing/installing_bare_metal_ipi/ipi-install-troubleshooting.adoc

:_mod-docs-content-type: PROC
[id="unable-to-discover-new-bare-metal-hosts-using-the-bmc_{context}"]
= Unable to discover new bare metal hosts using the BMC

In some cases, the installation program will not be able to discover the new bare metal hosts and issue an error, because it cannot mount the remote virtual media share.

For example:

[source,terminal]
----
ProvisioningError 51s metal3-baremetal-controller Image provisioning failed: Deploy step deploy.deploy failed with BadRequestError: HTTP POST
https://<bmc_address>/redfish/v1/Managers/iDRAC.Embedded.1/VirtualMedia/CD/Actions/VirtualMedia.InsertMedia
returned code 400.
Base.1.8.GeneralError: A general error has occurred. See ExtendedInfo for more information
Extended information: [
  {
    "Message": "Unable to mount remote share https://<ironic_address>/redfish/boot-<uuid>.iso.",
    "MessageArgs": [
      "https://<ironic_address>/redfish/boot-<uuid>.iso"
    ],
    "MessageArgs@odata.count": 1,
    "MessageId": "IDRAC.2.5.RAC0720",
    "RelatedProperties": [
      "#/Image"
    ],
    "RelatedProperties@odata.count": 1,
    "Resolution": "Retry the operation.",
    "Severity": "Informational"
  }
].
----

In this situation, if you are using virtual media with an unknown certificate authority, you can configure your baseboard management controller (BMC) remote file share settings to trust an unknown certificate authority to avoid this error.

[NOTE]
====
This resolution was tested on {product-title} 4.11 with Dell iDRAC 9 and firmware version 5.10.50.
====

:leveloffset!:
:leveloffset: +1

// Module included in the following assemblies:
// //installing/installing_bare_metal_ipi/installing_bare_metal_ipi/ipi-install-troubleshooting.adoc

:_mod-docs-content-type: PROCEDURE
[id="ipi-install-troubleshooting-api-not-accessible_{context}"]

= The API is not accessible

When the cluster is running and clients cannot access the API, domain name resolution issues might impede access to the API.

.Procedure

. **Hostname Resolution:** Check the cluster nodes to ensure they have a fully qualified domain name, and not just `localhost.localdomain`. For example:
+
[source,terminal]
----
$ hostname
----
+
If a hostname is not set, set the correct hostname. For example:
+
[source,terminal]
----
$ hostnamectl set-hostname <hostname>
----

. **Incorrect Name Resolution:** Ensure that each node has the correct name resolution in the DNS server using `dig` and `nslookup`. For example:
+
[source,terminal]
----
$ dig api.<cluster_name>.example.com
----
+
[source,terminal]
----
; <<>> DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el8 <<>> api.<cluster_name>.example.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 37551
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: 866929d2f8e8563582af23f05ec44203d313e50948d43f60 (good)
;; QUESTION SECTION:
;api.<cluster_name>.example.com. IN A

;; ANSWER SECTION:
api.<cluster_name>.example.com. 10800 IN	A 10.19.13.86

;; AUTHORITY SECTION:
<cluster_name>.example.com. 10800 IN NS	<cluster_name>.example.com.

;; ADDITIONAL SECTION:
<cluster_name>.example.com. 10800 IN A	10.19.14.247

;; Query time: 0 msec
;; SERVER: 10.19.14.247#53(10.19.14.247)
;; WHEN: Tue May 19 20:30:59 UTC 2020
;; MSG SIZE  rcvd: 140
----
+
The output in the foregoing example indicates that the appropriate IP address for the `api.<cluster_name>.example.com` VIP is `10.19.13.86`. This IP address should reside on the `baremetal` network.

:leveloffset!:
:leveloffset: +1

// This module is included in the following assemblies:
//
// installing/installing_bare_metal_ipi/ipi-install-troubleshooting.adoc

:_mod-docs-content-type: PROCEDURE
[id="worker-nodes-cannot-join-the-cluster_{context}"]
= Troubleshooting worker nodes that cannot join the cluster

Installer-provisioned clusters deploy with a DNS server that includes a DNS entry for the `api-int.<cluster_name>.<base_domain>` URL. If the nodes within the cluster use an external or upstream DNS server to resolve the `api-int.<cluster_name>.<base_domain>` URL and there is no such entry, worker nodes might fail to join the cluster. Ensure that all nodes in the cluster can resolve the domain name.

.Procedure

. Add a DNS A/AAAA or CNAME record to internally identify the API load balancer. For example, when using dnsmasq, modify the `dnsmasq.conf` configuration file:
+
[source,terminal,options="nowrap",role="white-space-pre"]
----
$ sudo nano /etc/dnsmasq.conf
----
+
[source,terminal,options="nowrap",role="white-space-pre"]
----
address=/api-int.<cluster_name>.<base_domain>/<IP_address>
address=/api-int.mycluster.example.com/192.168.1.10
address=/api-int.mycluster.example.com/2001:0db8:85a3:0000:0000:8a2e:0370:7334
----

. Add a DNS PTR record to internally identify the API load balancer. For example, when using dnsmasq, modify the `dnsmasq.conf` configuration file:
+
[source,terminal,options="nowrap",role="white-space-pre"]
----
$ sudo nano /etc/dnsmasq.conf
----
+
[source,terminal,options="nowrap",role="white-space-pre"]
----
ptr-record=<IP_address>.in-addr.arpa,api-int.<cluster_name>.<base_domain>
ptr-record=10.1.168.192.in-addr.arpa,api-int.mycluster.example.com
----

. Restart the DNS server. For example, when using dnsmasq, execute the following command:
+
[source,terminal,subs="+quotes",options="nowrap",role="white-space-pre"]
----
$ sudo systemctl restart dnsmasq
----

These records must be resolvable from all the nodes within the cluster.

:leveloffset!:
:leveloffset: +1

// Module included in the following assemblies:
//
//installing/installing_bare_metal_ipi/installing_bare_metal_ipi/ipi-install-troubleshooting.adoc

:_mod-docs-content-type: PROCEDURE
[id="ipi-install-troubleshooting-cleaning-up-previous-installations_{context}"]
= Cleaning up previous installations

In the event of a previous failed deployment, remove the artifacts from the failed attempt before attempting to deploy {product-title} again.

.Procedure

. Power off all bare metal nodes prior to installing the {product-title} cluster:
+
[source,terminal]
----
$ ipmitool -I lanplus -U <user> -P <password> -H <management_server_ip> power off
----

. Remove all old bootstrap resources if any are left over from a previous deployment attempt:
+
[source,terminal]
----
for i in $(sudo virsh list | tail -n +3 | grep bootstrap | awk {'print $2'});
do
  sudo virsh destroy $i;
  sudo virsh undefine $i;
  sudo virsh vol-delete $i --pool $i;
  sudo virsh vol-delete $i.ign --pool $i;
  sudo virsh pool-destroy $i;
  sudo virsh pool-undefine $i;
done
----

. Remove the following from the `clusterconfigs` directory to prevent Terraform from failing:
+
[source,terminal]
----
$ rm -rf ~/clusterconfigs/auth ~/clusterconfigs/terraform* ~/clusterconfigs/tls ~/clusterconfigs/metadata.json
----

:leveloffset!:
:leveloffset: +1

// Module included in the following assemblies:
// //installing/installing_bare_metal_ipi/installing_bare_metal_ipi/ipi-install-troubleshooting.adoc

:_mod-docs-content-type: PROCEDURE
[id="ipi-install-troubleshooting-registry-issues_{context}"]

= Issues with creating the registry

When creating a disconnected registry, you might encounter a "User Not Authorized" error when attempting to mirror the registry. This error might occur if you fail to append the new authentication to the existing `pull-secret.txt` file.

.Procedure

. Check to ensure authentication is successful:
+
[source,terminal]
----
$ /usr/local/bin/oc adm release mirror \
  -a pull-secret-update.json
  --from=$UPSTREAM_REPO \
  --to-release-image=$LOCAL_REG/$LOCAL_REPO:${VERSION} \
  --to=$LOCAL_REG/$LOCAL_REPO
----
+
[NOTE]
====
Example output of the variables used to mirror the install images:

[source,terminal]
----
UPSTREAM_REPO=${RELEASE_IMAGE}
LOCAL_REG=<registry_FQDN>:<registry_port>
LOCAL_REPO='ocp4/openshift4'
----

The values of `RELEASE_IMAGE` and `VERSION` were set during the **Retrieving OpenShift Installer** step of the **Setting up the environment for an OpenShift installation** section.
====

. After mirroring the registry, confirm that you can access it in your
disconnected environment:
+
[source,terminal]
----
$ curl -k -u <user>:<password> https://registry.example.com:<registry_port>/v2/_catalog
{"repositories":["<Repo_Name>"]}
----

:leveloffset!:
:leveloffset: +1

// Module included in the following assemblies:
// //installing/installing_bare_metal_ipi/installing_bare_metal_ipi/ipi-install-troubleshooting.adoc

:_mod-docs-content-type: PROCEDURE
[id="ipi-install-troubleshooting-misc-issues_{context}"]

= Miscellaneous issues

== Addressing the `runtime network not ready` error

After the deployment of a cluster you might receive the following error:

----
`runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady message:Network plugin returns error: Missing CNI default network`
----

The Cluster Network Operator is responsible for deploying the networking components in response to a special object created by the installer. It runs very early in the installation process, after the control plane (master) nodes have come up, but before the bootstrap control plane has been torn down. It can be indicative of more subtle installer issues, such as long delays in bringing up control plane (master) nodes or issues with `apiserver` communication.

.Procedure

. Inspect the pods in the `openshift-network-operator` namespace:
+
[source,terminal]
----
$ oc get all -n openshift-network-operator
----
+
[source,terminal]
----
NAME                                    READY STATUS            RESTARTS   AGE
pod/network-operator-69dfd7b577-bg89v   0/1   ContainerCreating 0          149m
----


. On the `provisioner` node, determine that the network configuration exists:
+
[source,terminal]
----
$ kubectl get network.config.openshift.io cluster -oyaml
----
+
[source,yaml]
----
apiVersion: config.openshift.io/v1
kind: Network
metadata:
  name: cluster
spec:
  serviceNetwork:
  - 172.30.0.0/16
  clusterNetwork:
  - cidr: 10.128.0.0/14
    hostPrefix: 23
  networkType: OVNKubernetes
----
+
If it does not exist, the installer did not create it. To determine why the installer did not create it, execute the following:
+
[source,terminal]
----
$ openshift-install create manifests
----

. Check that the `network-operator` is running:
+
[source,terminal]
----
$ kubectl -n openshift-network-operator get pods
----

. Retrieve the logs:
+
[source,terminal]
----
$ kubectl -n openshift-network-operator logs -l "name=network-operator"
----
+
On high availability clusters with three or more control plane (master) nodes, the Operator will perform leader election and all other Operators will sleep. For additional details, see https://github.com/openshift/installer/blob/master/docs/user/troubleshooting.md[Troubleshooting].

== Cluster nodes not getting the correct IPv6 address over DHCP

If the cluster nodes are not getting the correct IPv6 address over DHCP, check the following:

. Ensure the reserved IPv6 addresses reside outside the DHCP range.

. In the IP address reservation on the DHCP server, ensure the reservation specifies the correct DHCP Unique Identifier (DUID). For example:
+
[source,terminal]
----
# This is a dnsmasq dhcp reservation, 'id:00:03:00:01' is the client id and '18:db:f2:8c:d5:9f' is the MAC Address for the NIC
id:00:03:00:01:18:db:f2:8c:d5:9f,openshift-master-1,[2620:52:0:1302::6]
----

. Ensure that route announcements are working.

. Ensure that the DHCP server is listening on the required interfaces serving the IP address ranges.


== Cluster nodes not getting the correct hostname over DHCP

During IPv6 deployment, cluster nodes must get their hostname over DHCP. Sometimes the `NetworkManager` does not assign the hostname immediately. A control plane (master) node might report an error such as:

----
Failed Units: 2
  NetworkManager-wait-online.service
  nodeip-configuration.service
----

This error indicates that the cluster node likely booted without first receiving a hostname from the DHCP server, which causes `kubelet` to boot
with a `localhost.localdomain` hostname. To address the error, force the node to renew the hostname.

.Procedure

. Retrieve the `hostname`:
+
[source,terminal]
----
[core@master-X ~]$ hostname
----
+
If the hostname is `localhost`, proceed with the following steps.
+
[NOTE]
====
Where `X` is the control plane node number.
====

. Force the cluster node to renew the DHCP lease:
+
[source,terminal]
----
[core@master-X ~]$ sudo nmcli con up "<bare_metal_nic>"
----
+
Replace `<bare_metal_nic>` with the wired connection corresponding to the `baremetal` network.

. Check `hostname` again:
+
[source,terminal]
----
[core@master-X ~]$ hostname
----

. If the hostname is still `localhost.localdomain`, restart `NetworkManager`:
+
[source,terminal]
----
[core@master-X ~]$ sudo systemctl restart NetworkManager
----

. If the hostname is still `localhost.localdomain`, wait a few minutes and check again. If the hostname remains  `localhost.localdomain`, repeat the previous steps.

. Restart the `nodeip-configuration` service:
+
[source,terminal]
----
[core@master-X ~]$ sudo systemctl restart nodeip-configuration.service
----
+
This service will reconfigure the `kubelet` service with the correct hostname references.

. Reload the unit files definition since the kubelet changed in the previous step:
+
[source,terminal]
----
[core@master-X ~]$ sudo systemctl daemon-reload
----

. Restart the `kubelet` service:
+
[source,terminal]
----
[core@master-X ~]$ sudo systemctl restart kubelet.service
----

. Ensure `kubelet` booted with the correct hostname:
+
[source,terminal]
----
[core@master-X ~]$ sudo journalctl -fu kubelet.service
----

If the cluster node is not getting the correct hostname over DHCP after the cluster is up and running, such as during a reboot, the cluster will have a pending `csr`. **Do not** approve a `csr`, or other issues might arise.

.Addressing a `csr`

. Get CSRs on the cluster:
+
[source,terminal]
----
$ oc get csr
----

. Verify if a pending `csr` contains `Subject Name: localhost.localdomain`:
+
[source,terminal]
----
$ oc get csr <pending_csr> -o jsonpath='{.spec.request}' | base64 --decode | openssl req -noout -text
----

. Remove any `csr` that contains `Subject Name: localhost.localdomain`:
+
[source,terminal]
----
$ oc delete csr <wrong_csr>
----

== Routes do not reach endpoints

During the installation process, it is possible to encounter a Virtual Router Redundancy Protocol (VRRP) conflict. This conflict might occur if a previously used {product-title} node that was once part of a cluster deployment using a specific cluster name is still running but not part of the current {product-title} cluster deployment using that same cluster name. For example, a cluster was deployed using the cluster name `openshift`, deploying three control plane (master) nodes and three worker nodes. Later, a separate install uses the same cluster name `openshift`, but this redeployment only installed three control plane (master) nodes, leaving the three worker nodes from a previous deployment in an `ON` state. This might cause a Virtual Router Identifier (VRID) conflict and a VRRP conflict.

. Get the route:
+
[source,terminal]
----
$ oc get route oauth-openshift
----

. Check the service endpoint:
+
[source,terminal]
----
$ oc get svc oauth-openshift
----
+
[source,terminal]
----
NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
oauth-openshift   ClusterIP   172.30.19.162   <none>        443/TCP   59m
----

. Attempt to reach the service from a control plane (master) node:
+
[source,terminal]
----
[core@master0 ~]$ curl -k https://172.30.19.162
----
+
[source,terminal]
----
{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {
  },
  "status": "Failure",
  "message": "forbidden: User \"system:anonymous\" cannot get path \"/\"",
  "reason": "Forbidden",
  "details": {
  },
  "code": 403
----

. Identify the `authentication-operator` errors from the `provisioner` node:
+
[source,terminal]
----
$ oc logs deployment/authentication-operator -n openshift-authentication-operator
----
+
[source,terminal]
----
Event(v1.ObjectReference{Kind:"Deployment", Namespace:"openshift-authentication-operator", Name:"authentication-operator", UID:"225c5bd5-b368-439b-9155-5fd3c0459d98", APIVersion:"apps/v1", ResourceVersion:"", FieldPath:""}): type: 'Normal' reason: 'OperatorStatusChanged' Status for clusteroperator/authentication changed: Degraded message changed from "IngressStateEndpointsDegraded: All 2 endpoints for oauth-server are reporting"
----

.Solution

. Ensure that the cluster name for every deployment is unique, ensuring no conflict.

. Turn off all the rogue nodes which are not part of the cluster deployment that are using the same cluster name. Otherwise, the authentication pod of the  {product-title} cluster might never start successfully.

:leveloffset!:
:leveloffset: +2

// Module included in the following assemblies:
// //installing/installing_bare_metal_ipi/installing_bare_metal_ipi/ipi-install-troubleshooting.adoc

:_mod-docs-content-type: PROCEDURE
[id="ipi-install-troubleshooting-failed-ignition-during-firstboot_{context}"]

= Failed Ignition during Firstboot

During the Firstboot, the Ignition configuration may fail.

.Procedure

. Connect to the node where the Ignition configuration failed:
+
[source,terminal]
----
Failed Units: 1
  machine-config-daemon-firstboot.service
----

. Restart the `machine-config-daemon-firstboot` service:
+
[source,terminal]
----
[core@worker-X ~]$ sudo systemctl restart machine-config-daemon-firstboot.service
----

:leveloffset!:
:leveloffset: +2

// Module included in the following assemblies:
// //installing/installing_bare_metal_ipi/installing_bare_metal_ipi/ipi-install-troubleshooting.adoc

:_mod-docs-content-type: PROCEDURE
[id="ipi-install-troubleshooting-ntp-out-of-sync_{context}"]

= NTP out of sync

The deployment of {product-title} clusters depends on NTP synchronized clocks among the cluster nodes. Without synchronized clocks, the deployment may fail due to clock drift if the time difference is greater than two seconds.

.Procedure

. Check for differences in the `AGE` of the cluster nodes. For example:
+
[source,terminal]
----
$ oc get nodes
----
+
[source,terminal]
----
NAME                         STATUS   ROLES    AGE   VERSION
master-0.cloud.example.com   Ready    master   145m   v1.27.3
master-1.cloud.example.com   Ready    master   135m   v1.27.3
master-2.cloud.example.com   Ready    master   145m   v1.27.3
worker-2.cloud.example.com   Ready    worker   100m   v1.27.3
----

. Check for inconsistent timing delays due to clock drift. For example:
+
[source,terminal]
----
$ oc get bmh -n openshift-machine-api
----
+
[source,terminal]
----
master-1   error registering master-1  ipmi://<out_of_band_ip>
----
+
[source,terminal]
----
$ sudo timedatectl
----
+
[source,terminal]
----
               Local time: Tue 2020-03-10 18:20:02 UTC
           Universal time: Tue 2020-03-10 18:20:02 UTC
                 RTC time: Tue 2020-03-10 18:36:53
                Time zone: UTC (UTC, +0000)
System clock synchronized: no
              NTP service: active
          RTC in local TZ: no
----

.Addressing clock drift in existing clusters

. Create a Butane config file including the contents of the `chrony.conf` file to be delivered to the nodes. In the following example, create `99-master-chrony.bu` to add the file to the control plane nodes. You can modify the file for worker nodes or repeat this procedure for the worker role.
+
[NOTE]
====
See "Creating machine configs with Butane" for information about Butane.
====
+
[source,yaml,subs="attributes+"]
----
variant: openshift
version: {product-version}.0
metadata:
  name: 99-master-chrony
  labels:
    machineconfiguration.openshift.io/role: master
storage:
  files:
  - path: /etc/chrony.conf
    mode: 0644
    overwrite: true
    contents:
      inline: |
        server <NTP_server> iburst <1>
        stratumweight 0
        driftfile /var/lib/chrony/drift
        rtcsync
        makestep 10 3
        bindcmdaddress 127.0.0.1
        bindcmdaddress ::1
        keyfile /etc/chrony.keys
        commandkey 1
        generatecommandkey
        noclientlog
        logchange 0.5
        logdir /var/log/chrony
----
<1> Replace `<NTP_server>` with the IP address of the NTP server.

. Use Butane to generate a `MachineConfig` object file, `99-master-chrony.yaml`, containing the configuration to be delivered to the nodes:
+
[source,terminal]
----
$ butane 99-master-chrony.bu -o 99-master-chrony.yaml
----
. Apply the `MachineConfig` object file:
+
[source,terminal]
----
$ oc apply -f 99-master-chrony.yaml
----

. Ensure the `System clock synchronized` value is **yes**:
+
[source,terminal]
----
$ sudo timedatectl
----
+
[source,terminal]
----
               Local time: Tue 2020-03-10 19:10:02 UTC
           Universal time: Tue 2020-03-10 19:10:02 UTC
                 RTC time: Tue 2020-03-10 19:36:53
                Time zone: UTC (UTC, +0000)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no
----
+
To setup clock synchronization prior to deployment, generate the manifest files and add this file to the `openshift` directory. For example:
+
[source,terminal]
----
$ cp chrony-masters.yaml ~/clusterconfigs/openshift/99_masters-chrony-configuration.yaml
----
+
Then, continue to create the cluster.

:leveloffset!:
:leveloffset: +1

// Module included in the following assemblies:
// //installing/installing_bare_metal_ipi/installing_bare_metal_ipi/ipi-install-troubleshooting.adoc

:_mod-docs-content-type: PROCEDURE
[id="ipi-install-troubleshooting-reviewing-the-installation_{context}"]

= Reviewing the installation

After installation, ensure the installer deployed the nodes and pods successfully.

.Procedure

. When the {product-title} cluster nodes are installed appropriately, the following `Ready` state is seen within the `STATUS` column:
+
[source,terminal]
----
$ oc get nodes
----
+
[source,terminal]
----
NAME                   STATUS   ROLES           AGE  VERSION
master-0.example.com   Ready    master,worker   4h   v1.27.3
master-1.example.com   Ready    master,worker   4h   v1.27.3
master-2.example.com   Ready    master,worker   4h   v1.27.3
----

. Confirm the installer deployed all pods successfully. The following command
removes any pods that are still running or have completed as part of the output.
+
[source,terminal]
----
$ oc get pods --all-namespaces | grep -iv running | grep -iv complete
----

:leveloffset!:

//# includes=_attributes/common-attributes,modules/ipi-install-troubleshooting-install-config,modules/ipi-install-troubleshooting-bootstrap-vm,modules/ipi-install-troubleshooting-bootstrap-vm-cannot-boot,modules/ipi-install-troubleshooting-bootstrap-vm-inspecting-logs,modules/ipi-install-troubleshooting-cluster-nodes-will-not-pxe,modules/ipi-install-troubleshooting_unable-to-discover-new-bare-metal-hosts-using-the-bmc,modules/ipi-install-troubleshooting-api-not-accessible,modules/ipi-install-troubleshooting_proc_worker-nodes-cannot-join-the-cluster,modules/ipi-install-troubleshooting-cleaning-up-previous-installations,modules/ipi-install-troubleshooting-registry-issues,modules/ipi-install-troubleshooting-misc-issues,modules/ipi-install-troubleshooting-failed-ignition-during-firstboot,modules/ipi-install-troubleshooting-ntp-out-of-sync,modules/ipi-install-troubleshooting-reviewing-the-installation
